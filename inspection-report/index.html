<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ford Property Services ‚Ä¢ Inspection Report</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --text:#e7eefc;
      --muted:#a9b7d3;
      --line:rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(74,163,255,.20), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:10;
      background: rgba(11,18,32,.84);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:12px;}

    .logo{
      width:56px;height:56px;border-radius:14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      overflow:hidden;
      cursor:pointer;
      padding:7px;
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:none}

    .brand h1{margin:0;font-size:16px;line-height:1.1}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
    }
    .pill strong{color:var(--text)}
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(74,163,255,.35));
      border-color: rgba(74,163,255,.5);
    }
    button.danger{
      background: linear-gradient(135deg, rgba(239,68,68,.9), rgba(239,68,68,.25));
      border-color: rgba(239,68,68,.45);
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      z-index:99999;
      background: rgba(15,27,51,.95);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-weight:900;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      white-space:nowrap;
      max-width: calc(100vw - 24px);
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1}

    main{max-width:980px;margin:0 auto;padding:16px}
    .card{
      background: linear-gradient(180deg, rgba(15,27,51,.92), rgba(12,23,48,.92));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .stack{display:grid;gap:14px}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}

    .sectionTitle{
      font-weight:900; letter-spacing:.4px; font-size:12px;
      color: var(--text); opacity:.95;
      margin:2px 0 10px; text-transform:uppercase;
    }

    .reportHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
    }
    .rhLeft .bigTitle{font-size:18px;font-weight:950;margin:0}
    .rhRight{
      display:grid; gap:6px; min-width:260px;
      color:var(--muted); font-size:12px;
    }
    .rhRight b{color:var(--text)}
    .statusLine{
      margin-top:6px;
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-weight:900; letter-spacing:.2px;
    }

    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }

    .kv{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px;
    }
    .kv .k{color:var(--muted);font-size:12px}

    .chip{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      user-select:none;
    }
    .chip input{width:auto;transform:scale(1.1)}
    .hint{color:var(--muted);font-size:12px;margin:8px 0 0}

    .billingBar{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:720px){
      .billingBar{ grid-template-columns: 1fr 1fr; }
    }
    .billItem{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .billItem .chip{margin:0;}
    .billItem input{max-width:260px;}

    .evidence{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px;
      display:flex; justify-content:space-between;
      gap:10px; flex-wrap:wrap; align-items:center;
    }
    .evidence .line{color:var(--text); font-weight:850;}
    .checkWrap{display:flex; gap:10px; flex-wrap:wrap;}

    .photoCols{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){ .photoCols{grid-template-columns:1fr 1fr} }
    .photoBox{
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.04);
    }
    .photoTop{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .photoTop .title{font-weight:950;letter-spacing:.2px}
    .btnRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    /* Thumbs grid gets denser to handle up to 20 nicely */
    .thumbs{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:8px; margin-top:10px;
    }
    @media(min-width:720px){
      .thumbs{ grid-template-columns: repeat(5, 1fr); }
    }

    .thumb{
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      aspect-ratio: 1 / 1;
      display:grid;place-items:center;
      position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb button{
      position:absolute;top:6px;right:6px;
      padding:6px 8px;border-radius:10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      font-weight:900;
    }

    footer{color:var(--muted);text-align:center;padding:18px 10px 30px;font-size:12px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" id="logoBox" title="Tap to upload logo">
          <span id="logoFallback" style="font-weight:950;letter-spacing:.4px;color:#0b1220;">FPS</span>
          <img id="logoImg" alt="Company logo" />
        </div>
        <div>
          <h1>Ford Property Services</h1>
          <p>Inspection Report</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill"><strong>Report ID:</strong> <span id="reportIdText"></span></span>
        <span class="pill"><strong>Finalised:</strong> <span id="finalisedText">‚Äî</span></span>

        <!-- NEW: Save Draft -->
        <button id="saveDraftBtn" type="button">Save Draft</button>

        <button id="newBtn" class="danger" type="button">New Report</button>
        <button id="pdfBtn" class="primary" type="button">Generate PDF</button>
      </div>
    </div>
  </div>
</header>

<input id="logoInput" type="file" accept="image/*" style="display:none" />

<main>
  <div class="card stack">

    <div class="reportHeader">
      <div class="rhLeft">
        <div style="text-transform:uppercase;font-weight:950;font-size:12px;letter-spacing:.4px;opacity:.9;">
          Ford Property Services
        </div>
        <h2 class="bigTitle" style="margin-top:6px;">Inspection Report</h2>
        <div class="statusLine">FINAL / COMPLETED</div>
      </div>

      <div class="rhRight">
        <div><b>Report ID:</b> <span id="rhReportId"></span></div>
        <div><b>Finalised:</b> <span id="rhFinalised">‚Äî</span></div>
        <div><b>Date Completed:</b> <span id="dateCompletedText"></span></div>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Billing</div>
      <div class="billingBar">
        <div class="billItem">
          <label class="chip">
            <input id="invoiceRequired" type="checkbox" />
            Invoice Required
          </label>
          <div style="flex:1;min-width:180px;max-width:320px">
            <label>Invoice Number</label>
            <input id="invoiceNumber" placeholder="e.g., INV-1007" />
          </div>
        </div>

        <div class="billItem">
          <label class="chip">
            <input id="estimateRequired" type="checkbox" />
            Estimate Required
          </label>
          <div style="flex:1;min-width:180px;max-width:320px">
            <label>Estimate Number</label>
            <input id="estimateNumber" placeholder="e.g., EST-1007" />
          </div>
        </div>
      </div>
      <div class="hint">Tip: You can type the numbers even if ticks are off. PDF includes what you type.</div>
    </div>

    <div>
      <div class="sectionTitle">Job Details</div>
      <div class="grid2">
        <div class="kv">
          <div class="k">Letting Agent</div>
          <input id="lettingAgent" placeholder="e.g., Romans" />
        </div>

        <div class="kv" style="grid-column:1/-1;">
          <div class="k">Property Address</div>
          <input id="propertyAddress" placeholder="Full address" />
        </div>

        <div class="kv">
          <div class="k">Date Completed (tap calendar)</div>
          <input id="dateCompletedISO" type="date" />
          <div class="hint">Select date using calendar. It prints as UK format (DD/MM/YYYY).</div>
        </div>

        <div class="kv">
          <div class="k">Completed By</div>
          <div style="padding:10px 2px 2px;font-weight:950;">Ford Property Services</div>
        </div>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Photo Evidence</div>
      <div class="evidence">
        <div class="line">
          Before photos taken: <span id="beforeMark">‚úò</span>
          &nbsp;&nbsp; After photos taken: <span id="afterMark">‚úò</span>
        </div>
        <div class="checkWrap">
          <label class="chip"><input id="beforeTick" type="checkbox" /> Before photos taken</label>
          <label class="chip"><input id="afterTick" type="checkbox" /> After photos taken</label>
        </div>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Works / Inspection Notes</div>
      <textarea id="worksNotes" placeholder="Type inspection notes / works / notes here..."></textarea>
    </div>

    <div class="photoCols">
      <div class="photoBox">
        <div class="photoTop">
          <div class="title">BEFORE PHOTOS (UP TO 20)</div>
          <div class="pill"><strong>Count:</strong> <span id="beforeCount">0</span>/20</div>
        </div>
        <div class="btnRow">
          <button type="button" id="beforeGalleryBtn">Add from Gallery</button>
          <button type="button" id="beforeCameraBtn">Take Photo</button>
        </div>
        <input id="beforeGalleryInput" type="file" accept="image/*" multiple style="display:none" />
        <input id="beforeCameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <div class="thumbs" id="beforeThumbs"></div>
        <p class="hint" id="beforeEmptyHint">No photos added</p>
      </div>

      <div class="photoBox">
        <div class="photoTop">
          <div class="title">AFTER PHOTOS (UP TO 20)</div>
          <div class="pill"><strong>Count:</strong> <span id="afterCount">0</span>/20</div>
        </div>
        <div class="btnRow">
          <button type="button" id="afterGalleryBtn">Add from Gallery</button>
          <button type="button" id="afterCameraBtn">Take Photo</button>
        </div>
        <input id="afterGalleryInput" type="file" accept="image/*" multiple style="display:none" />
        <input id="afterCameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <div class="thumbs" id="afterThumbs"></div>
        <p class="hint" id="afterEmptyHint">No photos added</p>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Extra Attachments</div>
      <label class="chip" style="display:inline-flex">
        <input id="extraAttachments" type="checkbox" />
        Photo / Video files attached to email
      </label>
    </div>

  </div>
</main>

<footer>Ford Property Services ‚Ä¢ Inspection Report</footer>

<div id="toast" class="toast">Saved</div>

<script>
  // PWA Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  // ===== CONFIG =====
  const MAX_PHOTOS = 20;
  const DRAFT_KEY = 'fps_inspection_draft_v1';

  // Helpers
  function pad2(n){ return String(n).padStart(2,'0'); }
  function ukDate(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
  function ukFromISO(iso){
    if(!iso) return "";
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
    if(!m) return "";
    return `${m[3]}/${m[2]}/${m[1]}`;
  }
  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function makeReportId(){
    const d = new Date();
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    let tail = "";
    for(let i=0;i<5;i++) tail += letters[Math.floor(Math.random()*letters.length)];
    return `FPS-${dd}-${mm}-${yyyy}-${tail}`;
  }

  async function fileToDataURL(file, maxDim=1400, quality=0.80){
    const img = await new Promise((res, rej)=>{
      const i = new Image();
      i.onload=()=>res(i);
      i.onerror=rej;
      i.src = URL.createObjectURL(file);
    });
    const canvas = document.createElement('canvas');
    let {width:w, height:h} = img;
    const scale = Math.min(1, maxDim / Math.max(w,h));
    w = Math.round(w*scale); h = Math.round(h*scale);
    canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    const dataUrl = canvas.toDataURL('image/jpeg', quality);
    URL.revokeObjectURL(img.src);
    return dataUrl;
  }

  function blobToDataURL(blob){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }

  // State
  const state = {
    reportId: makeReportId(),
    finalised: null,
    beforePhotos: [],
    afterPhotos: [],
    logoDataUrl: null
  };

  // Elements
  const reportIdText = document.getElementById('reportIdText');
  const finalisedText = document.getElementById('finalisedText');
  const rhReportId = document.getElementById('rhReportId');
  const rhFinalised = document.getElementById('rhFinalised');
  const dateCompletedText = document.getElementById('dateCompletedText');

  const beforeTick = document.getElementById('beforeTick');
  const afterTick = document.getElementById('afterTick');
  const beforeMark = document.getElementById('beforeMark');
  const afterMark = document.getElementById('afterMark');

  const beforeCount = document.getElementById('beforeCount');
  const afterCount = document.getElementById('afterCount');
  const beforeEmptyHint = document.getElementById('beforeEmptyHint');
  const afterEmptyHint = document.getElementById('afterEmptyHint');
  const beforeThumbs = document.getElementById('beforeThumbs');
  const afterThumbs = document.getElementById('afterThumbs');

  const lettingAgent = document.getElementById('lettingAgent');
  const propertyAddress = document.getElementById('propertyAddress');
  const dateCompletedISO = document.getElementById('dateCompletedISO');

  const invoiceRequired = document.getElementById('invoiceRequired');
  const invoiceNumber = document.getElementById('invoiceNumber');
  const estimateRequired = document.getElementById('estimateRequired');
  const estimateNumber = document.getElementById('estimateNumber');

  const worksNotes = document.getElementById('worksNotes');
  const extraAttachments = document.getElementById('extraAttachments');

  const logoBox = document.getElementById('logoBox');
  const logoInput = document.getElementById('logoInput');
  const logoImg = document.getElementById('logoImg');
  const logoFallback = document.getElementById('logoFallback');

  const beforeGalleryBtn = document.getElementById('beforeGalleryBtn');
  const beforeCameraBtn  = document.getElementById('beforeCameraBtn');
  const afterGalleryBtn  = document.getElementById('afterGalleryBtn');
  const afterCameraBtn   = document.getElementById('afterCameraBtn');

  const beforeGalleryInput = document.getElementById('beforeGalleryInput');
  const beforeCameraInput  = document.getElementById('beforeCameraInput');
  const afterGalleryInput  = document.getElementById('afterGalleryInput');
  const afterCameraInput   = document.getElementById('afterCameraInput');

  const newBtn = document.getElementById('newBtn');
  const pdfBtn = document.getElementById('pdfBtn');
  const saveDraftBtn = document.getElementById('saveDraftBtn');

  const toast = document.getElementById('toast');
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1200);
  }

  // Defaults
  dateCompletedISO.value = todayISO();

  // UI
  function setFinalisedUI(){
    const t = state.finalised ? ukDate(state.finalised) : "‚Äî";
    finalisedText.textContent = t;
    rhFinalised.textContent = t;
  }
  function setReportIdUI(){
    reportIdText.textContent = state.reportId;
    rhReportId.textContent = state.reportId;
  }
  function setDateCompletedUI(){
    const uk = ukFromISO(dateCompletedISO.value);
    dateCompletedText.textContent = uk ? uk : "‚Äî";
  }
  function updateEvidenceMarks(){
    beforeMark.textContent = beforeTick.checked ? "‚úî" : "‚úò";
    afterMark.textContent  = afterTick.checked ? "‚úî" : "‚úò";
  }
  function updatePhotoCounts(){
    beforeCount.textContent = state.beforePhotos.length;
    afterCount.textContent = state.afterPhotos.length;
    beforeEmptyHint.style.display = state.beforePhotos.length ? "none" : "block";
    afterEmptyHint.style.display = state.afterPhotos.length ? "none" : "block";
  }

  function setLogo(src){
    state.logoDataUrl = src || null;
    if(src){
      logoImg.src = src;
      logoImg.style.display = 'block';
      logoFallback.style.display = 'none';
    }else{
      logoImg.removeAttribute('src');
      logoImg.style.display = 'none';
      logoFallback.style.display = 'block';
    }
  }

  async function loadLockedLogoFallback(){
    const defaultLogoPath = 'icons/fps-logo.png';
    try{
      const res = await fetch(defaultLogoPath, {cache:'no-store'});
      if(!res.ok) return false;
      const blob = await res.blob();
      const dataUrl = await blobToDataURL(blob);
      setLogo(dataUrl);
      return true;
    }catch(e){
      return false;
    }
  }

  // ===== DRAFT SAVE / LOAD =====
  let saveTimer = null;
  function scheduleAutoSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=> saveDraft(false), 450);
  }

  function buildDraftObject(){
    return {
      v: 1,
      savedAt: Date.now(),
      reportId: state.reportId,
      finalised: state.finalised ? state.finalised.toISOString() : null,
      logoDataUrl: state.logoDataUrl || null,

      lettingAgent: lettingAgent.value || "",
      propertyAddress: propertyAddress.value || "",
      dateCompletedISO: dateCompletedISO.value || "",

      invoiceRequired: !!invoiceRequired.checked,
      invoiceNumber: invoiceNumber.value || "",
      estimateRequired: !!estimateRequired.checked,
      estimateNumber: estimateNumber.value || "",

      beforeTick: !!beforeTick.checked,
      afterTick: !!afterTick.checked,

      worksNotes: worksNotes.value || "",
      extraAttachments: !!extraAttachments.checked,

      beforePhotos: (state.beforePhotos || []).map(p=> ({dataUrl: p.dataUrl})),
      afterPhotos: (state.afterPhotos || []).map(p=> ({dataUrl: p.dataUrl}))
    };
  }

  function saveDraft(showMsg=true){
    try{
      const draft = buildDraftObject();
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      if(showMsg) showToast('Draft saved');
    }catch(e){
      if(showMsg) alert('Draft could not be saved (storage full). Try fewer photos or clear space.');
    }
  }

  function loadDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return false;
      const d = JSON.parse(raw);

      if(d.reportId) state.reportId = d.reportId;
      state.finalised = d.finalised ? new Date(d.finalised) : null;

      if(d.logoDataUrl){
        setLogo(d.logoDataUrl);
      }

      lettingAgent.value = d.lettingAgent || "";
      propertyAddress.value = d.propertyAddress || "";
      dateCompletedISO.value = d.dateCompletedISO || todayISO();

      invoiceRequired.checked = !!d.invoiceRequired;
      invoiceNumber.value = d.invoiceNumber || "";
      estimateRequired.checked = !!d.estimateRequired;
      estimateNumber.value = d.estimateNumber || "";

      beforeTick.checked = !!d.beforeTick;
      afterTick.checked  = !!d.afterTick;

      worksNotes.value = d.worksNotes || "";
      extraAttachments.checked = !!d.extraAttachments;

      state.beforePhotos = Array.isArray(d.beforePhotos) ? d.beforePhotos.slice(0, MAX_PHOTOS).map(p=>({dataUrl:p.dataUrl})) : [];
      state.afterPhotos  = Array.isArray(d.afterPhotos)  ? d.afterPhotos.slice(0, MAX_PHOTOS).map(p=>({dataUrl:p.dataUrl})) : [];

      return true;
    }catch(e){
      return false;
    }
  }

  function clearDraft(){
    try{ localStorage.removeItem(DRAFT_KEY); }catch(e){}
  }

  // ===== INIT (logo + draft) =====
  (async ()=>{
    const savedLogo = localStorage.getItem('fps_logo_v1');
    if(savedLogo){
      setLogo(savedLogo);
    }else{
      const ok = await loadLockedLogoFallback();
      if(!ok) setLogo(null);
    }

    // Load draft after logo (draft may contain logoDataUrl anyway)
    const hadDraft = loadDraft();
    setReportIdUI(); setFinalisedUI(); setDateCompletedUI(); updateEvidenceMarks(); updatePhotoCounts();

    // Render thumbs (after draft load)
    renderThumbs(state.beforePhotos, beforeThumbs, (i)=> removeBefore(i));
    renderThumbs(state.afterPhotos, afterThumbs, (i)=> removeAfter(i));

    // If no draft existed, do a first autosave so reportId persists
    if(!hadDraft){
      saveDraft(false);
    }else{
      showToast('Draft loaded');
    }
  })();

  setReportIdUI(); setFinalisedUI(); setDateCompletedUI(); updateEvidenceMarks(); updatePhotoCounts();
  dateCompletedISO.addEventListener('input', ()=>{ setDateCompletedUI(); scheduleAutoSave(); });

  beforeTick.addEventListener('change', ()=>{ updateEvidenceMarks(); scheduleAutoSave(); });
  afterTick.addEventListener('change', ()=>{ updateEvidenceMarks(); scheduleAutoSave(); });

  invoiceRequired.addEventListener('change', scheduleAutoSave);
  estimateRequired.addEventListener('change', scheduleAutoSave);
  extraAttachments.addEventListener('change', scheduleAutoSave);

  lettingAgent.addEventListener('input', scheduleAutoSave);
  propertyAddress.addEventListener('input', scheduleAutoSave);
  invoiceNumber.addEventListener('input', scheduleAutoSave);
  estimateNumber.addEventListener('input', scheduleAutoSave);
  worksNotes.addEventListener('input', scheduleAutoSave);

  saveDraftBtn.addEventListener('click', ()=> saveDraft(true));

  // Logo upload
  logoBox.addEventListener('click', ()=> logoInput.click());
  logoInput.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const dataUrl = await fileToDataURL(file, 900, 0.90);
    setLogo(dataUrl);
    localStorage.setItem('fps_logo_v1', dataUrl);
    saveDraft(false);
    showToast('Logo saved');
  });

  // Photos
  function renderThumbs(list, container, onRemove){
    container.innerHTML = '';
    list.forEach((p, i)=>{
      const t = document.createElement('div');
      t.className = 'thumb';
      const img = document.createElement('img');
      img.src = p.dataUrl;
      const b = document.createElement('button');
      b.type='button';
      b.textContent = '√ó';
      b.addEventListener('click', ()=> onRemove(i));
      t.appendChild(img);
      t.appendChild(b);
      container.appendChild(t);
    });
  }

  function updateAllPhotoUI(){
    updatePhotoCounts();
    updateEvidenceMarks();
    renderThumbs(state.beforePhotos, beforeThumbs, (i)=> removeBefore(i));
    renderThumbs(state.afterPhotos, afterThumbs, (i)=> removeAfter(i));
  }

  function autoTickFromPhotos(){
    beforeTick.checked = state.beforePhotos.length > 0;
    afterTick.checked  = state.afterPhotos.length > 0;
    updateEvidenceMarks();
  }

  function removeBefore(i){
    state.beforePhotos.splice(i,1);
    autoTickFromPhotos();
    updateAllPhotoUI();
    scheduleAutoSave();
  }

  function removeAfter(i){
    state.afterPhotos.splice(i,1);
    autoTickFromPhotos();
    updateAllPhotoUI();
    scheduleAutoSave();
  }

  async function addPhotos(files, targetList){
    const arr = Array.from(files || []);
    for(const f of arr){
      if(targetList.length >= MAX_PHOTOS) break;
      const dataUrl = await fileToDataURL(f, 1400, 0.82);
      targetList.push({dataUrl});
    }
    autoTickFromPhotos();
    updateAllPhotoUI();
    scheduleAutoSave();
  }

  const beforeGalleryBtn = document.getElementById('beforeGalleryBtn');
  const beforeCameraBtn  = document.getElementById('beforeCameraBtn');
  const afterGalleryBtn  = document.getElementById('afterGalleryBtn');
  const afterCameraBtn   = document.getElementById('afterCameraBtn');

  beforeGalleryBtn.addEventListener('click', ()=> beforeGalleryInput.click());
  beforeCameraBtn.addEventListener('click', ()=> beforeCameraInput.click());
  afterGalleryBtn.addEventListener('click', ()=> afterGalleryInput.click());
  afterCameraBtn.addEventListener('click', ()=> afterCameraInput.click());

  beforeGalleryInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.beforePhotos); beforeGalleryInput.value=''; });
  beforeCameraInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.beforePhotos); beforeCameraInput.value=''; });
  afterGalleryInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.afterPhotos); afterGalleryInput.value=''; });
  afterCameraInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.afterPhotos); afterCameraInput.value=''; });

  // New report reset
  newBtn.addEventListener('click', async ()=>{
    if(!confirm('Start a new report? This clears fields + photos (logo stays).')) return;

    state.reportId = makeReportId();
    state.finalised = null;
    state.beforePhotos = [];
    state.afterPhotos = [];

    lettingAgent.value = "";
    propertyAddress.value = "";
    dateCompletedISO.value = todayISO();

    invoiceRequired.checked = false;
    invoiceNumber.value = "";
    estimateRequired.checked = false;
    estimateNumber.value = "";

    beforeTick.checked = false;
    afterTick.checked = false;
    worksNotes.value = "";
    extraAttachments.checked = false;

    setReportIdUI(); setFinalisedUI(); setDateCompletedUI();
    updateAllPhotoUI();

    // keep logo; ensure fallback if none
    if(!state.logoDataUrl){
      await loadLockedLogoFallback();
    }

    // clear & save draft so new report doesn't re-load old fields
    clearDraft();
    saveDraft(false);
    showToast('New report started');
  });

  // PDF helpers
  function tickBox(doc, checked, x, y){
    const bx = x;
    const by = y - 3.8;
    const s  = 4.2;

    doc.setDrawColor(120);
    doc.setLineWidth(0.35);
    doc.rect(bx, by, s, s);

    if(checked){
      doc.setLineWidth(0.75);
      doc.line(bx+0.8, by+1.8, bx+1.9, by+3.0);
      doc.line(bx+1.9, by+3.0, bx+3.7, by+0.7);
      doc.setLineWidth(0.35);
    }else{
      doc.setLineWidth(0.6);
      doc.line(bx+0.8, by+0.8, bx+s-0.8, by+s-0.8);
      doc.line(bx+s-0.8, by+0.8, bx+0.8, by+s-0.8);
      doc.setLineWidth(0.35);
    }
  }

  // Generate PDF
  pdfBtn.addEventListener('click', async ()=>{
    if(!dateCompletedISO.value){
      alert("Please choose a Date Completed.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a4'});

    state.finalised = new Date();
    setFinalisedUI();

    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const margin = 12;
    const usableW = pageW - margin*2;

    const data = {
      reportId: state.reportId,
      finalised: ukDate(state.finalised),
      lettingAgent: (lettingAgent.value || "").trim() || "-",
      propertyAddress: (propertyAddress.value || "").trim() || "-",
      dateCompleted: ukFromISO(dateCompletedISO.value),
      invoiceRequired: !!invoiceRequired.checked,
      invoiceNumber: (invoiceNumber.value || "").trim() || "-",
      estimateRequired: !!estimateRequired.checked,
      estimateNumber: (estimateNumber.value || "").trim() || "-",
      completedBy: "Ford Property Services",
      beforeTaken: !!beforeTick.checked,
      afterTaken: !!afterTick.checked,
      worksNotes: (worksNotes.value || "").trim() || "-",
      extraAttachments: !!extraAttachments.checked
    };

    function imgTypeFromDataUrl(d){
      if(!d) return "JPEG";
      return d.startsWith("data:image/png") ? "PNG" : "JPEG";
    }

    function fitImage(doc, dataUrl, x, y, maxW, maxH){
      try{
        const props = doc.getImageProperties(dataUrl);
        const iw = props.width || 1;
        const ih = props.height || 1;
        const scale = Math.min(maxW/iw, maxH/ih);
        const w = iw*scale;
        const h = ih*scale;
        const dx = x + (maxW - w)/2;
        const dy = y + (maxH - h)/2;
        doc.addImage(dataUrl, imgTypeFromDataUrl(dataUrl), dx, dy, w, h, undefined, 'FAST');
        return {w,h};
      }catch(e){
        return null;
      }
    }

    function box(x,y,w,h, r=2){
      doc.setDrawColor(170);
      doc.setLineWidth(0.35);
      doc.roundedRect(x,y,w,h,r,r);
    }

    function fillBar(x,y,w,h){
      doc.setFillColor(245,245,245);
      doc.setDrawColor(170);
      doc.setLineWidth(0.35);
      doc.roundedRect(x,y,w,h,2,2,'FD');
    }

    function sectionBar(title, y){
      fillBar(margin, y, usableW, 7.5);
      doc.setFont('helvetica','bold');
      doc.setFontSize(10);
      doc.setTextColor(35);
      doc.text(title.toUpperCase(), margin+3, y+5.3);
      return y + 9.5;
    }

    function ensureSpace(curY, needed){
      if(curY + needed > pageH - 16){
        doc.addPage();
        return 14;
      }
      return curY;
    }

    function addNotesAuto(title, text, startY){
      let y = sectionBar(title, startY);

      const innerX = margin;
      const innerW = usableW;
      const pad = 4;

      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.setTextColor(35);

      const lines = doc.splitTextToSize(text, innerW - pad*2);

      const lineH = 4.6;
      const topPad = 7.0;
      const bottomPad = 5.0;

      let idx = 0;
      while(idx < lines.length){
        y = ensureSpace(y, 20);

        const maxBoxH = (pageH - 16) - y;
        const maxLines = Math.max(1, Math.floor((maxBoxH - (topPad+bottomPad)) / lineH));
        const chunk = lines.slice(idx, idx + maxLines);

        const boxH = Math.max(20, (chunk.length * lineH) + topPad + bottomPad);
        box(innerX, y, innerW, boxH, 2);

        doc.text(chunk, innerX + pad, y + topPad);
        y += boxH + 5;
        idx += maxLines;

        if(idx < lines.length){
          doc.addPage();
          y = 14;
          y = sectionBar(title + " (cont.)", y);
        }
      }
      return y;
    }

    // HEADER
    let y = 12;

    const logoBoxW = 36;
    const logoBoxH = 16;

    if(state.logoDataUrl){
      fitImage(doc, state.logoDataUrl, margin, y, logoBoxW, logoBoxH);
    }else{
      doc.setDrawColor(170);
      doc.rect(margin, y, logoBoxW, logoBoxH);
      doc.setFontSize(9);
      doc.setTextColor(90);
      doc.text('LOGO', margin+10, y+10);
    }

    doc.setFont('helvetica','bold'); doc.setFontSize(15); doc.setTextColor(25);
    doc.text('FORD PROPERTY SERVICES', margin + logoBoxW + 6, y + 6);

    doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(45);
    doc.text('Inspection Report', margin + logoBoxW + 6, y + 12);

    doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(25);
    doc.text('FINAL / COMPLETED', pageW - margin, y + 6, {align:'right'});
    doc.setFont('helvetica','normal'); doc.setFontSize(9.5); doc.setTextColor(45);
    doc.text(`Report ID: ${data.reportId}`, pageW - margin, y + 11.5, {align:'right'});
    doc.text(`Finalised: ${data.finalised}`, pageW - margin, y + 16.5, {align:'right'});

    y += 20;

    // JOB DETAILS
    y = sectionBar('Job Details', y);

    const jobBoxH = 42;
    box(margin, y, usableW, jobBoxH, 2);

    const colGap = 6;
    const colW = (usableW - colGap) / 2;

    const col1X = margin + 4;
    const col2X = margin + colW + colGap + 4;

    const labelW = 30;
    const rowH = 6;

    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    const addrLinesAll = doc.splitTextToSize(data.propertyAddress, colW - labelW - 6);
    const addrLines = addrLinesAll.slice(0,2);
    const addrTooLong = addrLinesAll.length > 2;

    const r0 = y + 10;
    const r1 = r0 + rowH;
    const r2 = r1 + rowH;
    const r3 = r2 + rowH;
    const r4 = r3 + rowH;

    function field(colX, rowY, label, value){
      doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(45);
      doc.text(label, colX, rowY);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(35);
      doc.text(value, colX + labelW, rowY);
    }

    field(col1X, r0, 'Letting Agent', data.lettingAgent);

    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(45);
    doc.text('Address', col1X, r1);
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(35);
    if(addrLines[0]) doc.text(addrLines[0], col1X + labelW, r1);
    if(addrLines[1]) doc.text(addrLines[1] + (addrTooLong ? "‚Ä¶" : ""), col1X + labelW, r2);

    field(col1X, r3, 'Date', data.dateCompleted);

    field(col2X, r0, 'Completed', data.completedBy);

    const cbX = col2X + labelW;
    const reqX = cbX + 6;
    const noLabelX = col2X;
    const noValueX = col2X + labelW;

    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(45);
    doc.text('Invoice', col2X, r1);
    tickBox(doc, data.invoiceRequired, cbX, r1);
    doc.setFont('helvetica','normal'); doc.setFontSize(9.5); doc.setTextColor(35);
    doc.text('Required', reqX, r1);

    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(45);
    doc.text('No:', noLabelX, r2);
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(35);
    doc.text(`${data.invoiceNumber}`, noValueX, r2);

    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(45);
    doc.text('Estimate', col2X, r3);
    tickBox(doc, data.estimateRequired, cbX, r3);
    doc.setFont('helvetica','normal'); doc.setFontSize(9.5); doc.setTextColor(35);
    doc.text('Required', reqX, r3);

    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(45);
    doc.text('No:', noLabelX, r4);
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(35);
    doc.text(`${data.estimateNumber}`, noValueX, r4);

    y += jobBoxH + 5;

    // PHOTO EVIDENCE
    y = sectionBar('Photo Evidence', y);
    const peH = 12;
    box(margin, y, usableW, peH, 2);

    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(35);
    tickBox(doc, data.beforeTaken, margin+6, y+7.7);
    doc.text('Before photos taken', margin+12, y+7.7);

    tickBox(doc, data.afterTaken, margin+92, y+7.7);
    doc.text('After photos taken', margin+98, y+7.7);

    y += peH + 5;

    // NOTES
    y = addNotesAuto('Works / Inspection Notes', data.worksNotes, y);

    // EXTRA ATTACHMENTS
    y = ensureSpace(y, 28);
    y = sectionBar('Extra Attachments', y);

    const eaH = 18;
    box(margin, y, usableW, eaH, 2);

    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    doc.setTextColor(35);
    const eaText = data.extraAttachments ? 'Photo / Video files attached to email' : '-';
    const eaLines = doc.splitTextToSize(eaText, usableW - 8);
    doc.text(eaLines, margin + 4, y + 8);

    // ===== PHOTOS: 2 columns, auto-add extra pages as required =====
    function drawPhotoSectionPaged(title, photos){
      if(!photos || !photos.length) return;

      const gap = 4;
      const boxH = 78;
      const containerPad = 4;

      const innerW = usableW - (containerPad * 2);
      const boxW = (innerW - gap) / 2;

      const rowsPerPage = 2;          // 2 rows => 4 photos per page
      const perPage = rowsPerPage * 2;

      for(let offset=0; offset<photos.length; offset += perPage){
        doc.addPage();
        let py = 14;

        py = sectionBar(title + (photos.length > perPage ? ` (${Math.floor(offset/perPage)+1})` : ''), py);

        const chunk = photos.slice(offset, offset + perPage);
        const rows = Math.ceil(chunk.length / 2);

        const innerH = rows * boxH + (rows - 1) * gap;
        const containerH = innerH + containerPad*2;

        box(margin, py, usableW, containerH, 2);

        for(let i=0;i<chunk.length;i++){
          const col = i % 2;
          const row = Math.floor(i / 2);

          const x = margin + containerPad + col*(boxW + gap);
          const y0 = py + containerPad + row*(boxH + gap);

          box(x, y0, boxW, boxH, 2);
          try{
            doc.addImage(chunk[i].dataUrl, 'JPEG', x+2, y0+2, boxW-4, boxH-4, undefined, 'FAST');
          }catch(e){
            doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(90);
            doc.text('Image error', x+5, y0+10);
            doc.setTextColor(35);
          }
        }
      }
    }

    const canBefore = beforeTick.checked && state.beforePhotos.length > 0;
    const canAfter  = afterTick.checked  && state.afterPhotos.length > 0;

    if(canBefore) drawPhotoSectionPaged('Before Photos', state.beforePhotos);
    if(canAfter)  drawPhotoSectionPaged('After Photos', state.afterPhotos);

    // Footer on every page
    const total = doc.getNumberOfPages();
    for(let p=1;p<=total;p++){
      doc.setPage(p);
      doc.setFont('helvetica','normal');
      doc.setFontSize(9);
      doc.setTextColor(130);
      doc.text(`Report ID: ${data.reportId}`, margin, pageH - 8);
      doc.text(`Page ${p} of ${total}`, pageW - margin, pageH - 8, {align:'right'});
    }

    const safeName = `${data.reportId}.pdf`.replace(/[^\w\-\.]/g,'_');
    doc.save(safeName);

    // Save draft after generating PDF (so finalised date persists if you reopen)
    saveDraft(false);
  });
</script>
</body>
</html>

<a href="../dashboard/" style="position:fixed;top:10px;right:10px;z-index:9999;font-weight:900;color:#9ecbff;text-decoration:none;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:12px;background:#0b1220;">
  üè† Dashboard
</a>
