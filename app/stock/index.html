<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ford Property Services ‚Ä¢ Stock</title>
  <meta name="theme-color" content="#0b1220" />

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --text:#e7eefc;
      --muted:#a9b7d3;
      --line:rgba(255,255,255,.14);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --blue: rgba(74,163,255,.95);
      --green: rgba(34,197,94,.95);
      --red: rgba(239,68,68,.95);
      --amber: rgba(245,158,11,.95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 20% -10%, rgba(74,163,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 14px 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65));
      border-bottom:1px solid var(--line);
    }
    .row{display:flex; gap:10px; align-items:center}
    .title{font-weight:900; letter-spacing:.2px}
    input, select{
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
    }
    input::placeholder{color:rgba(233,240,255,.55)}
    button{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
      touch-action: manipulation;
      user-select:none;
      white-space:nowrap;
    }
    button.primary{background:rgba(74,163,255,.16); border-color:rgba(74,163,255,.35)}
    button.good{background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.35)}
    button.bad{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35)}
    button.warn{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35)}
    button:active{transform:translateY(1px)}
    main{padding:14px; max-width:980px; margin:0 auto}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .itemRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .name{font-weight:900; font-size:15px}
    .meta{color:var(--muted); font-size:12px; margin-top:2px}
    .qtyBox{
      display:flex; align-items:center; gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .qty{
      min-width:84px;
      text-align:center;
      font-weight:900;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
    }
    .qty.zero{
      border-color: rgba(239,68,68,.55);
      color: var(--red);
    }
    .mini{padding:10px 10px; border-radius:14px; min-width:44px}
    .miniTxt{padding:10px 10px; border-radius:14px; min-width:48px}
    .low{border-color:rgba(245,158,11,.45) !important}
    .verylow{border-color:rgba(239,68,68,.55) !important}
    .hint{color:var(--muted); font-size:12px}
    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .split{grid-template-columns: 1.2fr .8fr;}
    }

    /* Modal (bottom sheet) */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:100;
      padding:12px;
    }
    .sheet{
      width:min(980px, 100%);
      background:rgba(11,18,32,.96);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:12px;
      max-height:86vh;
      overflow:auto;
    }
    .sheetHeader{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .sheetTitle{font-weight:1000}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow);
    }
    .hr{height:1px; background:var(--line); margin:10px 0}

    /* Barcode area */
    #qrRegion{
      width:100%;
      background:rgba(255,255,255,.05);
      border:1px dashed rgba(255,255,255,.22);
      border-radius:18px;
      overflow:hidden;
      min-height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }
    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-weight:800;
      font-size:12px;
      color:var(--text);
    }

    /* Custom amount prompt (list) */
    .promptOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:200;
      padding:12px;
    }
    .promptSheet{
      width:min(640px, 100%);
      background:rgba(11,18,32,.96);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:12px;
    }

    /* Photo Identify UI */
    .previewRow{display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;}
    .preview{
      width:120px; height:120px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      object-fit:cover;
    }
    .suggestions .pill{display:block; width:100%; text-align:left; margin-top:8px}
    .mutedBox{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      border-radius:18px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
      white-space:pre-wrap;
    }
  </style>

  <!-- Barcode scanner lib -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, getDocs, getDoc, query, where,
      onSnapshot, orderBy, serverTimestamp, arrayUnion, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
    import {
      getFunctions, httpsCallable
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

    // ‚úÖ Your Firebase config (fps-jobs-board)
    const firebaseConfig = {
      apiKey: "AIzaSyCJPVdTvzHFRiyLTzR08hMTBp71gPEPLU8",
      authDomain: "fps-jobs-board.firebaseapp.com",
      projectId: "fps-jobs-board",
      storageBucket: "fps-jobs-board.firebasestorage.app",
      messagingSenderId: "386598717430",
      appId: "1:386598717430:web:06a2b508f1d7fcc92069d7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functions = getFunctions(app);
    const STOCK_COL = collection(db, "stockItems");

    // Callable (deployed in Part 2)
    const identifyFromPhoto = httpsCallable(functions, "identifyFromPhoto");

    const els = {
      search: document.getElementById("search"),
      list: document.getElementById("list"),
      status: document.getElementById("status"),
      btnScan: document.getElementById("btnScan"),
      btnAdd: document.getElementById("btnAdd"),
      btnPhoto: document.getElementById("btnPhoto"),

      overlay: document.getElementById("overlay"),
      closeSheet: document.getElementById("closeSheet"),
      sheetTitle: document.getElementById("sheetTitle"),
      modePill: document.getElementById("modePill"),

      // Sections
      scanSection: document.getElementById("scanSection"),
      formSection: document.getElementById("formSection"),
      photoSection: document.getElementById("photoSection"),

      // Add/Edit form
      f_barcodes: document.getElementById("f_barcodes"),
      f_name: document.getElementById("f_name"),
      f_qty: document.getElementById("f_qty"),
      f_unit: document.getElementById("f_unit"),
      f_category: document.getElementById("f_category"),
      f_location: document.getElementById("f_location"),
      f_minQty: document.getElementById("f_minQty"),
      btnSaveItem: document.getElementById("btnSaveItem"),

      // Scanner
      qrRegion: document.getElementById("qrRegion"),
      btnStartScan: document.getElementById("btnStartScan"),
      btnStopScan: document.getElementById("btnStopScan"),
      scanHint: document.getElementById("scanHint"),

      // Scan prompt
      qtyPrompt: document.getElementById("qtyPrompt"),
      qtyPromptHint: document.getElementById("qtyPromptHint"),
      suggestedBox: document.getElementById("suggestedBox"),
      suggestedName: document.getElementById("suggestedName"),
      suggestedBrand: document.getElementById("suggestedBrand"),
      suggestedTag: document.getElementById("suggestedTag"),
      btnUseSuggested: document.getElementById("btnUseSuggested"),
      btnManualCreate: document.getElementById("btnManualCreate"),
      btnShowAssign: document.getElementById("btnShowAssign"),
      btnCancelAdd: document.getElementById("btnCancelAdd"),
      btnCustomAdd: document.getElementById("btnCustomAdd"),
      customAddRow: document.getElementById("customAddRow"),
      customAddVal: document.getElementById("customAddVal"),
      btnApplyCustom: document.getElementById("btnApplyCustom"),

      // Assign
      assignBox: document.getElementById("assignBox"),
      assignSearch: document.getElementById("assignSearch"),
      assignList: document.getElementById("assignList"),
      btnAssignClose: document.getElementById("btnAssignClose"),

      // List custom amount prompt
      amtOverlay: document.getElementById("amtOverlay"),
      amtTitle: document.getElementById("amtTitle"),
      amtInput: document.getElementById("amtInput"),
      amtApply: document.getElementById("amtApply"),
      amtCancel: document.getElementById("amtCancel"),

      // Photo Identify
      photoInput: document.getElementById("photoInput"),
      photoPreview: document.getElementById("photoPreview"),
      photoStatus: document.getElementById("photoStatus"),
      photoText: document.getElementById("photoText"),
      photoBest: document.getElementById("photoBest"),
      photoAlt: document.getElementById("photoAlt"),
      photoBtnUseBest: document.getElementById("photoBtnUseBest"),
      photoBtnUseAlt: document.getElementById("photoBtnUseAlt"),
      photoBtnManual: document.getElementById("photoBtnManual"),
    };

    let allItems = [];
    let editId = null;

    let scanner = null;
    let scanning = false;
    let lastScanned = "";
    let pendingScan = null;

    let pendingListDelta = { id:null };

    // Photo identify state
    let lastPhotoSuggestion = null; // {name, altName, sizeHints, unitGuess, rawText}

    function esc(s=""){ return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function openSheet(title){
      els.sheetTitle.textContent = title;
      els.overlay.style.display = "flex";
    }
    function closeSheet(){
      els.overlay.style.display = "none";
      hideQtyPrompt();
      hideAssign();
      pendingScan = null;
      stopScanner();
      resetPhotoUI();
    }

    function showOnly(section){
      els.scanSection.style.display = "none";
      els.formSection.style.display = "none";
      els.photoSection.style.display = "none";
      section.style.display = "block";
    }

    function clearForm(){
      editId = null;
      els.f_barcodes.value = "";
      els.f_name.value = "";
      els.f_qty.value = "1";
      els.f_unit.value = "pcs";
      els.f_category.value = "";
      els.f_location.value = "";
      els.f_minQty.value = "";
    }

    async function adjustQtyAtomic(itemId, delta){
      const ref = doc(db, "stockItems", itemId);
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists()) return;
        const data = snap.data() || {};
        const cur = Number(data.qty || 0);
        const next = Math.max(0, cur + Number(delta || 0));
        tx.update(ref, { qty: next, updatedAt: serverTimestamp() });
      });
    }

    async function findByBarcode(code){
      const q1 = query(STOCK_COL, where("barcode", "==", code));
      const s1 = await getDocs(q1);
      let found = null;
      s1.forEach(d => { if (!found) found = { id: d.id, ...d.data() }; });
      if (found) return found;

      const q2 = query(STOCK_COL, where("barcodes", "array-contains", code));
      const s2 = await getDocs(q2);
      s2.forEach(d => { if (!found) found = { id: d.id, ...d.data() }; });
      return found;
    }

    async function fetchOpenFoodFacts(code){
      const url = `https://world.openfoodfacts.net/api/v2/product/${encodeURIComponent(code)}`;
      try{
        const res = await fetch(url, { method:"GET" });
        if (!res.ok) return null;
        const data = await res.json();
        if (!data || data.status !== 1 || !data.product) return null;

        const p = data.product;
        const name =
          (p.product_name && p.product_name.trim()) ||
          (p.product_name_en && p.product_name_en.trim()) ||
          (p.generic_name && p.generic_name.trim()) ||
          "";
        const brand = (p.brands && p.brands.trim()) || "";
        if (!name && !brand) return null;

        return { name: name || "", brand: brand || "", source: "Open Food Facts" };
      } catch(e){
        return null;
      }
    }

    function showQtyPrompt(){
      els.qtyPrompt.style.display = "block";
      els.customAddRow.style.display = "none";
      els.customAddVal.value = "";
      els.assignBox.style.display = "none";
    }
    function hideQtyPrompt(){
      els.qtyPrompt.style.display = "none";
      els.customAddRow.style.display = "none";
      els.customAddVal.value = "";
      els.qtyPromptHint.textContent = "";
      els.suggestedBox.style.display = "none";
    }
    function showSuggested(suggested){
      if (!suggested) { els.suggestedBox.style.display = "none"; return; }
      els.suggestedBox.style.display = "block";
      els.suggestedName.textContent = suggested.name || "(No name found)";
      els.suggestedBrand.textContent = suggested.brand ? `Brand: ${suggested.brand}` : "";
      els.suggestedTag.textContent = suggested.source || "";
    }

    function hideAssign(){
      els.assignBox.style.display = "none";
      els.assignSearch.value = "";
      els.assignList.innerHTML = "";
    }

    function parseBarcodes(input){
      const arr = (input || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
      return [...new Set(arr)];
    }

    function openAddWithBarcode(code, startingQty=1, suggested=null){
      clearForm();
      els.f_barcodes.value = code ? code : "";
      els.f_qty.value = String(startingQty || 1);
      if (suggested?.name) els.f_name.value = suggested.name + (suggested.brand ? ` (${suggested.brand})` : "");
      openSheet("Add new item");
      els.modePill.textContent = "New";
      showOnly(els.formSection);
      els.f_name.focus();
    }

    function openEdit(id){
      const it = allItems.find(x => x.id === id);
      if (!it) return;
      editId = id;

      const bars = Array.isArray(it.barcodes) ? it.barcodes : (it.barcode ? [it.barcode] : []);
      els.f_barcodes.value = bars.join(", ");

      els.f_name.value = it.name || "";
      els.f_qty.value = String(it.qty ?? 0);
      els.f_unit.value = it.unit || "pcs";
      els.f_category.value = it.category || "";
      els.f_location.value = it.location || "";
      els.f_minQty.value = (it.minQty ?? "") === 0 ? "0" : (it.minQty ?? "");
      openSheet("Edit item");
      els.modePill.textContent = "Edit";
      showOnly(els.formSection);
    }

    async function saveItem(){
      const barcodes = parseBarcodes(els.f_barcodes.value);
      const name = (els.f_name.value || "").trim();
      const qty = Number(els.f_qty.value || 0);
      const unit = (els.f_unit.value || "pcs").trim();
      const category = (els.f_category.value || "").trim();
      const location = (els.f_location.value || "").trim();
      const minQtyRaw = (els.f_minQty.value || "").trim();
      const minQty = minQtyRaw === "" ? null : Number(minQtyRaw);

      if (!name){ alert("Item name is required."); els.f_name.focus(); return; }
      if (Number.isNaN(qty) || qty < 0){ alert("Quantity must be 0 or more."); els.f_qty.focus(); return; }
      if (minQty !== null && (Number.isNaN(minQty) || minQty < 0)){ alert("Min stock must be blank or 0+."); els.f_minQty.focus(); return; }

      const primaryBarcode = barcodes[0] || null;

      const payload = {
        name,
        barcode: primaryBarcode,
        barcodes: barcodes.length ? barcodes : null,
        qty,
        unit: unit || "pcs",
        category: category || null,
        location: location || null,
        minQty: minQty === null ? null : minQty,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      };

      if (editId){
        const ref = doc(db, "stockItems", editId);
        const snap = await getDoc(ref);
        const existingCreated = snap.exists() ? snap.data()?.createdAt : null;

        const upd = { ...payload };
        if (existingCreated) delete upd.createdAt;

        await updateDoc(ref, upd);
        closeSheet();
        return;
      }

      if (primaryBarcode){
        const existing = await findByBarcode(primaryBarcode);
        if (existing){
          await adjustQtyAtomic(existing.id, qty);
          await updateDoc(doc(db, "stockItems", existing.id), {
            barcode: existing.barcode || primaryBarcode,
            barcodes: arrayUnion(primaryBarcode),
            updatedAt: serverTimestamp()
          });
          closeSheet();
          return;
        }
      }

      await addDoc(STOCK_COL, payload);
      closeSheet();
    }

    function render(){
      const term = (els.search.value || "").trim().toLowerCase();
      const filtered = !term ? allItems : allItems.filter(it => {
        const barcodes = Array.isArray(it.barcodes) ? it.barcodes.join(" ") : (it.barcode || "");
        const hay = `${it.name||""} ${it.category||""} ${it.location||""} ${barcodes}`.toLowerCase();
        return hay.includes(term);
      });

      if (!filtered.length){
        els.list.innerHTML = `
          <div class="card">
            <div class="name">No items found</div>
            <div class="meta">Try scanning a barcode, using Photo Identify, or tap ‚ÄúAdd item‚Äù.</div>
          </div>
        `;
        return;
      }

      els.list.innerHTML = filtered.map(it => {
        const qty = Number(it.qty || 0);
        const min = it.minQty === undefined || it.minQty === null || it.minQty === "" ? null : Number(it.minQty);
        const lowClass = (min !== null && qty <= min) ? (qty <= Math.max(0, Math.floor(min*0.5)) ? "verylow" : "low") : "";
        const unit = it.unit || "pcs";
        const qtyClass = qty === 0 ? "qty zero" : "qty";

        const bars = Array.isArray(it.barcodes) ? it.barcodes : (it.barcode ? [it.barcode] : []);
        const barcodeLabel = bars.length ? `üè∑Ô∏è ${esc(bars[0])}${bars.length>1 ? ` +${bars.length-1}` : ""}` : "";

        const metaBits = [
          it.category ? `üì¶ ${esc(it.category)}` : "",
          it.location ? `üìç ${esc(it.location)}` : "",
          barcodeLabel
        ].filter(Boolean).join(" ‚Ä¢ ");

        return `
          <div class="card ${lowClass}">
            <div class="itemRow">
              <div>
                <div class="name">${esc(it.name || "Unnamed item")}</div>
                <div class="meta">${metaBits || `<span class="hint">No category/location/barcode set</span>`}</div>
                ${min !== null ? `<div class="meta">Min: <b>${esc(min)}</b> ${esc(unit)}</div>` : ``}
              </div>

              <div class="qtyBox">
                <button class="mini bad" data-act="add" data-delta="-1" data-id="${esc(it.id)}">‚Äì</button>
                <div class="${qtyClass}">${esc(qty)} ${esc(unit)}</div>

                <button class="miniTxt good" data-act="add" data-delta="1" data-id="${esc(it.id)}">+1</button>
                <button class="miniTxt good" data-act="add" data-delta="2" data-id="${esc(it.id)}">+2</button>
                <button class="miniTxt good" data-act="add" data-delta="5" data-id="${esc(it.id)}">+5</button>
                <button class="miniTxt good" data-act="add" data-delta="10" data-id="${esc(it.id)}">+10</button>
                <button class="miniTxt primary" data-act="custom" data-id="${esc(it.id)}">Custom</button>

                <button class="mini" data-act="edit" data-id="${esc(it.id)}">‚úèÔ∏è</button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function startLive(){
      els.status.textContent = "Syncing‚Ä¶";
      const qy = query(STOCK_COL, orderBy("name", "asc"));
      onSnapshot(qy, (snap) => {
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        arr.sort((a,b) => String(a.name||"").localeCompare(String(b.name||""), "en", { sensitivity:"base" }));
        allItems = arr;
        els.status.textContent = `${arr.length} item${arr.length===1?"":"s"}`;
        render();
      }, (err) => {
        console.error(err);
        els.status.textContent = "Sync error (check Firebase rules/config)";
      });
    }

    // ----- List custom amount prompt -----
    function openListCustom(id){
      pendingListDelta = { id };
      const it = allItems.find(x => x.id === id);
      els.amtTitle.textContent = `Add custom amount${it?.name ? ` ‚Ä¢ ${it.name}` : ""}`;
      els.amtInput.value = "";
      els.amtOverlay.style.display = "flex";
      els.amtInput.focus();
    }
    function closeListCustom(){
      els.amtOverlay.style.display = "none";
      els.amtInput.value = "";
      pendingListDelta = { id:null };
    }

    // ----- Barcode scan -----
    async function startScanner(){
      if (scanning) return;
      scanning = true;
      els.scanHint.textContent = "Point your camera at the barcode‚Ä¶";
      els.btnStartScan.disabled = true;
      els.btnStopScan.disabled = false;
      hideQtyPrompt();
      hideAssign();
      pendingScan = null;

      if (!scanner) scanner = new Html5Qrcode("qrRegion");
      const config = { fps: 10, qrbox: { width: 300, height: 220 } };

      try{
        await scanner.start(
          { facingMode: "environment" },
          config,
          async (decodedText) => {
            const code = (decodedText || "").trim();
            if (!code) return;

            if (code === lastScanned) return;
            lastScanned = code;
            setTimeout(() => { lastScanned = ""; }, 1400);

            const existing = await findByBarcode(code);

            if (existing){
              pendingScan = { code, existingItem: existing, suggested: null };
              els.scanHint.textContent = `‚úÖ Found: ${existing.name}`;
              els.qtyPromptHint.textContent = `Barcode found: ${existing.name}`;
              showSuggested(null);
              showQtyPrompt();
              return;
            }

            els.scanHint.textContent = "Searching product database‚Ä¶";
            const suggested = await fetchOpenFoodFacts(code);

            pendingScan = { code, existingItem: null, suggested: suggested || null };
            els.scanHint.textContent = "üÜï New barcode";
            els.qtyPromptHint.textContent = "Not in your stock list yet.";
            showSuggested(suggested);
            showQtyPrompt();
          }
        );
      } catch (e){
        console.error(e);
        els.scanHint.textContent = "Camera error. Check permissions or try again.";
        scanning = false;
        els.btnStartScan.disabled = false;
        els.btnStopScan.disabled = true;
      }
    }

    async function stopScanner(){
      if (!scanner || !scanning) return;
      try{ await scanner.stop(); } catch(e){}
      try{ await scanner.clear(); } catch(e){}
      scanning = false;
      els.btnStartScan.disabled = false;
      els.btnStopScan.disabled = true;
    }

    // ----- Assign barcode to existing item -----
    function buildAssignList(term=""){
      const t = (term || "").trim().toLowerCase();
      const matches = !t ? allItems : allItems.filter(it => {
        const hay = `${it.name||""} ${it.category||""} ${it.location||""}`.toLowerCase();
        return hay.includes(t);
      }).slice(0, 20);

      if (!matches.length){
        els.assignList.innerHTML = `<div class="hint">No matches.</div>`;
        return;
      }

      els.assignList.innerHTML = matches.map(it => `
        <button class="pill" style="width:100%; text-align:left;" data-assign-id="${esc(it.id)}">
          ${esc(it.name || "Unnamed item")}
          <div class="hint">${esc(it.category||"")} ${it.location ? "‚Ä¢ "+esc(it.location) : ""}</div>
        </button>
      `).join("");
    }

    function showAssign(){
      els.assignBox.style.display = "block";
      els.assignSearch.value = "";
      buildAssignList("");
      els.assignSearch.focus();
    }

    // ----- Photo Identify (Option 1) -----
    function resetPhotoUI(){
      lastPhotoSuggestion = null;
      els.photoPreview.src = "";
      els.photoPreview.style.display = "none";
      els.photoStatus.textContent = "Take a photo of the item label/packaging.";
      els.photoText.textContent = "";
      els.photoBest.textContent = "‚Äî";
      els.photoAlt.textContent = "‚Äî";
      els.photoBtnUseBest.disabled = true;
      els.photoBtnUseAlt.disabled = true;
    }

    function guessUnitFromText(t){
      const s = (t||"").toLowerCase();
      if (/\bml\b|\blitre\b|\bliter\b|\bl\b/.test(s)) return "litres";
      if (/\bmetre\b|\bmeters?\b|\bm\b|\bmm\b|\bcm\b/.test(s)) return "metres";
      if (/\broll\b/.test(s)) return "rolls";
      if (/\bbox\b|\bpack\b/.test(s)) return "boxes";
      if (/\btube\b|\bcartridge\b/.test(s)) return "tubes";
      return "pcs";
    }

    function extractSizeHints(t){
      const s = (t||"");
      const hints = [];
      const patterns = [
        /\b\d{1,4}\s?mm\b/gi,
        /\b\d{1,4}\s?cm\b/gi,
        /\b\d{1,4}\s?m\b/gi,
        /\b\d{1,4}\s?ml\b/gi,
        /\b\d{1,3}\s?l\b/gi,
        /\b\d{1,3}\s?(pack|pk)\b/gi,
        /\b\d{1,3}\s?(pcs|pc)\b/gi
      ];
      for (const re of patterns){
        const m = s.match(re);
        if (m) m.forEach(x => hints.push(x.trim()));
      }
      return [...new Set(hints)].slice(0, 6);
    }

    function buildNameFromSuggestion(best, sizeHints){
      if (!best) return "";
      const clean = best.replace(/\s+/g, " ").trim();
      if (!sizeHints || !sizeHints.length) return clean;
      // append the first size hint if not already included
      const first = sizeHints[0];
      if (clean.toLowerCase().includes(first.toLowerCase())) return clean;
      return `${clean} ‚Ä¢ ${first}`;
    }

    async function handlePhotoFile(file){
      if (!file) return;
      resetPhotoUI();

      // Preview
      const url = URL.createObjectURL(file);
      els.photoPreview.src = url;
      els.photoPreview.style.display = "block";

      els.photoStatus.textContent = "Uploading photo‚Ä¶";

      // Upload to Storage
      const ts = Date.now();
      const path = `stock-photo-identify/${ts}-${Math.random().toString(16).slice(2)}.jpg`;
      const r = sRef(storage, path);
      const bytes = await file.arrayBuffer();
      await uploadBytes(r, new Uint8Array(bytes), { contentType: file.type || "image/jpeg" });

      els.photoStatus.textContent = "Analysing photo‚Ä¶";

      // Call function
      let result;
      try{
        result = await identifyFromPhoto({ storagePath: path });
      } catch(err){
        console.error(err);
        els.photoStatus.textContent = "Photo identify failed (check Functions/Vision API).";
        els.photoText.textContent = (err && (err.message || err.toString())) || "";
        return;
      }

      const data = result?.data || {};
      const ocrText = (data.ocrText || "").trim();
      const bestName = (data.bestName || "").trim();
      const altName = (data.altName || "").trim();

      const sizeHints = extractSizeHints(ocrText);
      const unitGuess = guessUnitFromText(ocrText);

      lastPhotoSuggestion = {
        bestName,
        altName,
        sizeHints,
        unitGuess,
        rawText: ocrText
      };

      els.photoStatus.textContent = "Suggestions ready (tap to use).";
      els.photoText.textContent = ocrText ? ocrText.slice(0, 1800) : "(No readable text found)";

      els.photoBest.textContent = bestName ? buildNameFromSuggestion(bestName, sizeHints) : "‚Äî";
      els.photoAlt.textContent = altName ? buildNameFromSuggestion(altName, sizeHints) : "‚Äî";

      els.photoBtnUseBest.disabled = !bestName;
      els.photoBtnUseAlt.disabled = !altName;
    }

    function usePhotoSuggestion(which){
      if (!lastPhotoSuggestion) return;
      const picked = which === "alt" ? lastPhotoSuggestion.altName : lastPhotoSuggestion.bestName;
      const sizeHints = lastPhotoSuggestion.sizeHints || [];
      const unitGuess = lastPhotoSuggestion.unitGuess || "pcs";

      clearForm();
      els.f_qty.value = "1";
      els.f_unit.value = unitGuess;
      els.f_name.value = buildNameFromSuggestion(picked, sizeHints);

      // optional: auto category hint from keywords (simple)
      const t = (lastPhotoSuggestion.rawText || "").toLowerCase();
      if (/ct1|silicone|sealant|adhesive/.test(t)) els.f_category.value = "Sealants / Adhesives";
      else if (/screw|fixing|anchor|rawl/.test(t)) els.f_category.value = "Fixings";
      else if (/cable|socket|rcd|fuse/.test(t)) els.f_category.value = "Electrical";
      else if (/copper|pipe|elbow|valve|tap|plumb/.test(t)) els.f_category.value = "Plumbing";

      openSheet("Add new item");
      els.modePill.textContent = "New";
      showOnly(els.formSection);
      els.f_name.focus();
    }

    // ----- Wire up UI -----
    els.search.addEventListener("input", render);

    els.list.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if (!id || !act) return;

      if (act === "add"){
        const delta = Number(btn.getAttribute("data-delta") || "0");
        if (!delta) return;
        await adjustQtyAtomic(id, delta);
      }
      if (act === "custom"){
        openListCustom(id);
      }
      if (act === "edit"){
        openEdit(id);
      }
    });

    // List custom prompt
    els.amtCancel.addEventListener("click", closeListCustom);
    els.amtOverlay.addEventListener("click", (e) => { if (e.target === els.amtOverlay) closeListCustom(); });
    els.amtApply.addEventListener("click", async () => {
      const amt = Number(els.amtInput.value || 0);
      if (!pendingListDelta.id || !amt || amt < 1) return;
      await adjustQtyAtomic(pendingListDelta.id, amt);
      closeListCustom();
    });

    els.btnAdd.addEventListener("click", () => {
      clearForm();
      openSheet("Add new item");
      els.modePill.textContent = "New";
      showOnly(els.formSection);
    });

    els.btnScan.addEventListener("click", () => {
      clearForm();
      openSheet("Scan barcode");
      els.modePill.textContent = "Scan";
      showOnly(els.scanSection);
    });

    els.btnPhoto.addEventListener("click", () => {
      resetPhotoUI();
      openSheet("Photo Identify");
      els.modePill.textContent = "Photo";
      showOnly(els.photoSection);
      // open camera chooser
      els.photoInput.value = "";
      els.photoInput.click();
    });

    els.photoInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      await handlePhotoFile(file);
    });

    els.photoBtnUseBest.addEventListener("click", () => usePhotoSuggestion("best"));
    els.photoBtnUseAlt.addEventListener("click", () => usePhotoSuggestion("alt"));
    els.photoBtnManual.addEventListener("click", () => {
      clearForm();
      openSheet("Add new item");
      els.modePill.textContent = "New";
      showOnly(els.formSection);
      els.f_name.focus();
    });

    els.closeSheet.addEventListener("click", closeSheet);
    els.overlay.addEventListener("click", (e) => { if (e.target === els.overlay) closeSheet(); });

    els.btnSaveItem.addEventListener("click", saveItem);

    els.btnStartScan.addEventListener("click", startScanner);
    els.btnStopScan.addEventListener("click", stopScanner);

    // Scan prompt buttons
    els.qtyPrompt.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const qadd = btn.getAttribute("data-qadd");
      if (!qadd) return;

      const amt = Number(qadd);
      if (!pendingScan || !amt || amt < 1) return;

      const { code, existingItem } = pendingScan;

      if (existingItem){
        await adjustQtyAtomic(existingItem.id, amt);
        els.scanHint.textContent = `‚úÖ Added +${amt} to: ${existingItem.name}`;
        hideQtyPrompt();
        pendingScan = null;
        return;
      }

      hideQtyPrompt();
      const suggested = pendingScan.suggested || null;
      pendingScan = null;
      await stopScanner();
      openAddWithBarcode(code, amt, suggested);
    });

    els.btnCustomAdd.addEventListener("click", () => {
      els.customAddRow.style.display = "block";
      els.customAddVal.focus();
    });

    els.btnApplyCustom.addEventListener("click", async () => {
      const amt = Number(els.customAddVal.value || 0);
      if (!pendingScan || !amt || amt < 1) return;

      const { code, existingItem } = pendingScan;

      if (existingItem){
        await adjustQtyAtomic(existingItem.id, amt);
        els.scanHint.textContent = `‚úÖ Added +${amt} to: ${existingItem.name}`;
        hideQtyPrompt();
        pendingScan = null;
        return;
      }

      hideQtyPrompt();
      const suggested = pendingScan.suggested || null;
      pendingScan = null;
      await stopScanner();
      openAddWithBarcode(code, amt, suggested);
    });

    els.btnCancelAdd.addEventListener("click", () => {
      hideQtyPrompt();
      hideAssign();
      pendingScan = null;
      els.scanHint.textContent = "Cancelled.";
    });

    els.btnUseSuggested.addEventListener("click", async () => {
      if (!pendingScan || pendingScan.existingItem) return;
      const { code, suggested } = pendingScan;
      hideQtyPrompt();
      pendingScan = null;
      await stopScanner();
      openAddWithBarcode(code, 1, suggested || null);
    });

    els.btnManualCreate.addEventListener("click", async () => {
      if (!pendingScan || pendingScan.existingItem) return;
      const { code } = pendingScan;
      hideQtyPrompt();
      pendingScan = null;
      await stopScanner();
      openAddWithBarcode(code, 1, null);
    });

    els.btnShowAssign.addEventListener("click", () => {
      if (!pendingScan || pendingScan.existingItem) return;
      showAssign();
    });

    els.btnAssignClose.addEventListener("click", hideAssign);

    els.assignSearch.addEventListener("input", () => buildAssignList(els.assignSearch.value));

    els.assignList.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-assign-id]");
      if (!btn) return;
      if (!pendingScan || pendingScan.existingItem) return;

      const targetId = btn.getAttribute("data-assign-id");
      const code = pendingScan.code;

      await updateDoc(doc(db, "stockItems", targetId), {
        barcode: code,
        barcodes: arrayUnion(code),
        updatedAt: serverTimestamp()
      });

      els.scanHint.textContent = `‚úÖ Assigned barcode to existing item`;
      hideAssign();
      hideQtyPrompt();
      pendingScan = null;
    });

    // Default open = list
    function openList(){
      // no sheet
    }

    // Start
    startLive();
    render();

    // ----- Helpers used above but defined later -----
    function openListCustom(id){
      pendingListDelta = { id };
      const it = allItems.find(x => x.id === id);
      els.amtTitle.textContent = `Add custom amount${it?.name ? ` ‚Ä¢ ${it.name}` : ""}`;
      els.amtInput.value = "";
      els.amtOverlay.style.display = "flex";
      els.amtInput.focus();
    }

    // (scanner helpers already defined above)
  </script>
</head>

<body>
  <header>
    <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
      <div>
        <div class="title">FPS ‚Ä¢ Stock</div>
        <div class="hint" id="status">Loading‚Ä¶</div>
      </div>
      <div class="row" style="flex-wrap:wrap;">
        <button class="primary" id="btnScan">üì∑ Scan</button>
        <button class="primary" id="btnPhoto">üì∏ Photo Identify</button>
        <button class="good" id="btnAdd">Ôºã Add item</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <input id="search" placeholder="Search stock‚Ä¶ (name, category, location, barcode)" />
    </div>
  </header>

  <main>
    <div class="grid" id="list"></div>
    <div class="hint" style="margin-top:10px;">
      Tip: Photo Identify works best when the label is clear and close-up. Qty still needs your input.
    </div>
  </main>

  <!-- Bottom sheet / modal -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetHeader">
        <div>
          <div class="sheetTitle" id="sheetTitle">Add</div>
          <div class="hint">Mode: <span class="pill" id="modePill" style="padding:4px 10px;">New</span></div>
        </div>
        <button id="closeSheet">Close</button>
      </div>

      <div class="hr"></div>

      <!-- PHOTO IDENTIFY SECTION -->
      <div id="photoSection" style="display:none;">
        <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />

        <div class="previewRow">
          <img id="photoPreview" class="preview" alt="Preview" style="display:none" />
          <div style="flex:1; min-width:220px;">
            <div class="name">Photo Identify</div>
            <div class="hint" id="photoStatus">Take a photo of the item label/packaging.</div>
            <div class="row" style="margin-top:10px; flex-wrap:wrap;">
              <button class="primary" onclick="document.getElementById('photoInput').click()">Take another photo</button>
              <button id="photoBtnManual">Manual add</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card suggestions">
          <div class="name">Suggested names</div>
          <div class="hint">Tap one to autofill the add form.</div>

          <button class="pill" id="photoBtnUseBest" disabled>
            <div class="hint">Best match</div>
            <div style="font-weight:900" id="photoBest">‚Äî</div>
          </button>

          <button class="pill" id="photoBtnUseAlt" disabled>
            <div class="hint">Alternative</div>
            <div style="font-weight:900" id="photoAlt">‚Äî</div>
          </button>
        </div>

        <div class="hr"></div>

        <div class="card">
          <div class="name">OCR text (what it read)</div>
          <div class="mutedBox" id="photoText">(No text yet)</div>
        </div>
      </div>

      <!-- SCAN SECTION -->
      <div id="scanSection" style="display:none;">
        <div id="qrRegion">Camera preview will appear here</div>

        <div class="row" style="margin-top:10px;">
          <button class="primary" id="btnStartScan">Start scan</button>
          <button id="btnStopScan" disabled>Stop</button>
        </div>

        <div class="hint" style="margin-top:10px;" id="scanHint">Tap ‚ÄúStart scan‚Äù then point at the barcode.</div>

        <!-- Add Amount / Actions Prompt -->
        <div id="qtyPrompt" class="card" style="display:none; margin-top:10px;">
          <div class="name" style="margin-bottom:6px;">What do you want to do?</div>
          <div class="hint" id="qtyPromptHint"></div>

          <!-- Suggested product (Open Food Facts) -->
          <div id="suggestedBox" style="display:none; margin-top:10px;">
            <span class="tag" id="suggestedTag"></span>
            <div class="name" style="margin-top:8px;" id="suggestedName">Suggested name</div>
            <div class="meta" id="suggestedBrand"></div>
            <div class="row" style="margin-top:10px; flex-wrap:wrap;">
              <button class="good" id="btnUseSuggested">Use suggestion</button>
              <button class="primary" id="btnShowAssign">Assign to existing</button>
              <button class="warn" id="btnManualCreate">Create manually</button>
            </div>
            <div class="hr"></div>
          </div>

          <!-- Amount chooser -->
          <div class="row" style="flex-wrap:wrap; gap:8px; margin-top:8px;">
            <button class="good" data-qadd="1">+1</button>
            <button class="good" data-qadd="2">+2</button>
            <button class="good" data-qadd="5">+5</button>
            <button class="good" data-qadd="10">+10</button>
            <button class="primary" id="btnCustomAdd">Custom‚Ä¶</button>
            <button id="btnCancelAdd">Cancel</button>
          </div>

          <div id="customAddRow" style="display:none; margin-top:10px;">
            <div class="row">
              <input id="customAddVal" type="number" inputmode="numeric" min="1" placeholder="Enter amount‚Ä¶" />
              <button class="good" id="btnApplyCustom">Apply</button>
            </div>
          </div>

          <!-- Assign box -->
          <div id="assignBox" class="card" style="display:none; margin-top:10px;">
            <div class="row" style="justify-content:space-between;">
              <div class="name">Assign barcode to existing item</div>
              <button id="btnAssignClose">Close</button>
            </div>
            <div style="height:10px"></div>
            <input id="assignSearch" placeholder="Search items to assign‚Ä¶" />
            <div style="height:10px"></div>
            <div id="assignList" class="grid"></div>
            <div class="hint" style="margin-top:10px;">
              Tap an item to attach this barcode to it.
            </div>
          </div>

        </div>
      </div>

      <!-- FORM SECTION -->
      <div id="formSection">
        <div class="split">
          <div class="card">
            <div class="hint">Barcodes (comma separated)</div>
            <input id="f_barcodes" placeholder="e.g. 5051234567890, 5012345678901" />

            <div style="height:10px"></div>

            <div class="hint">Item name *</div>
            <input id="f_name" placeholder="e.g. 15mm copper elbow" />

            <div style="height:10px"></div>

            <div class="row">
              <div style="flex:1">
                <div class="hint">Qty</div>
                <input id="f_qty" type="number" inputmode="numeric" min="0" value="1" />
              </div>
              <div style="width:140px">
                <div class="hint">Unit</div>
                <select id="f_unit">
                  <option value="pcs">pcs</option>
                  <option value="boxes">boxes</option>
                  <option value="tubes">tubes</option>
                  <option value="rolls">rolls</option>
                  <option value="metres">metres</option>
                  <option value="litres">litres</option>
                </select>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="hint">Min stock (optional)</div>
            <input id="f_minQty" type="number" inputmode="numeric" min="0" placeholder="e.g. 5" />
          </div>

          <div class="card">
            <div class="hint">Category (optional)</div>
            <input id="f_category" placeholder="e.g. Plumbing / Electrical / Fixings" />

            <div style="height:10px"></div>

            <div class="hint">Location (optional)</div>
            <input id="f_location" placeholder="e.g. Unit shelf A3 / Van box 2" />

            <div class="hr"></div>

            <div class="row">
              <button class="good" style="flex:1" id="btnSaveItem">Save</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              Tip: Photo Identify will pre-fill name + unit guess, you still choose qty.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- List custom amount prompt -->
  <div class="promptOverlay" id="amtOverlay">
    <div class="promptSheet">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:1000;" id="amtTitle">Add custom amount</div>
        <button id="amtCancel">Close</button>
      </div>
      <div class="hr"></div>
      <div class="hint">Enter how many to add</div>
      <div class="row" style="margin-top:10px;">
        <input id="amtInput" type="number" inputmode="numeric" min="1" placeholder="e.g. 12" />
        <button class="good" id="amtApply">Add</button>
      </div>
    </div>
  </div>

</body>
                                                                         </html>
