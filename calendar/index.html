<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ford Property Services ‚Ä¢ Calendar</title>
<meta name="theme-color" content="#0b1220" />

<style>
:root{
  --bg:#0b1220;
  --card:rgba(15,27,51,.92);
  --card2:rgba(12,23,48,.92);
  --text:#e7eefc;
  --muted:#a9b7d3;
  --line:rgba(255,255,255,.14);
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --blue:#4aa3ff;
  --green:#22c55e;
  --purple:#a855f7;
}
*{box-sizing:border-box}
html,body{overflow-x:hidden;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1200px 650px at 20% -10%, rgba(74,163,255,.22), transparent 60%),
    radial-gradient(1000px 650px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
    var(--bg);
  color:var(--text);
}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(11,18,32,.82);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:8px 12px;
  border-radius:14px;
  font-weight:900;
  text-decoration:none;
  cursor:pointer;
  max-width:100%;
  white-space:nowrap;
}
.btn.primary{border-color:rgba(74,163,255,.35);background:rgba(74,163,255,.12)}
.btn.ok{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.10)}
.btn.danger{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.10)}
main{max-width:1100px;margin:0 auto;padding:16px}
.card{
  background:linear-gradient(180deg,var(--card),var(--card2));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:14px;
}
.toolbar{
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;
  margin-bottom:12px;
  gap:10px;
}
.toolbar > div{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

.grid{
  display:grid;
  grid-template-columns:repeat(7, minmax(0, 1fr));
  gap:10px;
}
.dow{color:var(--muted);text-align:center;font-size:12px}
.day{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  border-radius:16px;
  min-height:90px;
  padding:8px;
  cursor:pointer;
  min-width:0;
}
.day.today{border-color:var(--blue);background:rgba(74,163,255,.10)}
.dayNum{font-weight:950;margin-bottom:4px}

/* Base event chip */
.event{
  margin-top:6px;
  padding:6px 8px;
  border-radius:12px;
  font-size:12px;
  cursor:pointer;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  max-width:100%;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.event.est{border-left:4px solid var(--blue)}     /* üîµ Estimate booked */
.event.works{border-left:4px solid var(--green)}  /* üü¢ Works booked (incl. Estimate Accepted) */
.event.manual{border-left:4px solid var(--purple)}

/* Carry-on placeholder */
.event.carry{
  border-left:4px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.03);
  border:1px dashed rgba(255,255,255,.16);
  color:rgba(231,238,252,.70);
}

/* Week view: 2-line chip + centered duration */
.weekEvent{
  white-space:normal !important;
  overflow:visible !important;
  text-overflow:clip !important;
}
.weekEventTop{
  display:block;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.weekEventDur{
  display:block;
  text-align:center;
  margin-top:4px;
  font-size:11px;
  color:var(--muted);
  font-weight:900;
}
.weekEventDur.carryDur{ opacity:.75; }

.muted{color:var(--muted);font-size:12px}

/* Full-month Week view (42 days) with horizontal scroll on mobile */
.weekWrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  padding-bottom:8px;
}
.weekMonthGrid{
  display:grid;
  grid-template-columns:repeat(7, minmax(220px, 1fr));
  gap:10px;
  min-width:calc(7 * 220px + 6 * 10px);
}
@media(min-width:860px){
  .weekMonthGrid{
    grid-template-columns:repeat(7, minmax(0, 1fr));
    min-width:0;
  }
}
.weekCol{
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  padding:10px;
  min-width:0;
}
.weekCol.today{border-color:var(--blue);background:rgba(74,163,255,.06)}
.weekHead{
  font-weight:950;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--muted);
}

/* Day view list */
.list{display:grid;gap:10px}
.listItem{
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  cursor:pointer;
  min-width:0;
}

@media(max-width:520px){
  .wrap{padding:12px 12px}
  main{padding:12px}
  .card{padding:12px}
  .grid{gap:6px}
  .day{min-height:78px;padding:6px;border-radius:14px}
  .event{font-size:11px;padding:5px 6px;border-radius:11px}
  .weekEventDur{font-size:10.5px}
  .btn{padding:8px 10px}
}

/* Dialog */
dialog{
  width:min(720px, 96vw);
  border:1px solid rgba(255,255,255,.16);
  border-radius:18px;
  padding:0;
  background: rgba(11,18,32,.95);
  color:var(--text);
  box-shadow: var(--shadow);
}
dialog::backdrop{ background: rgba(0,0,0,.55); }
.dlgHead{
  padding:14px 14px 10px;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.dlgHead strong{ font-size:14px; }
.dlgBody{ padding:14px; display:grid; gap:10px; }
.field{display:grid; gap:6px;}
label{font-size:12px;color:var(--muted);}
input, textarea{
  width:100%;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  outline:none;
}
textarea{min-height:110px; resize:vertical;}
.dlgActions{
  padding:14px;
  border-top:1px solid var(--line);
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.two{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
@media(min-width:700px){
  .two{grid-template-columns: 1fr 1fr;}
}
.smallnote{color:var(--muted);font-size:12px}
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <strong>Ford Property Services</strong><br>
        <span class="muted">Calendar</span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn ok" id="newManualBtn" type="button">+ Manual</button>
        <a class="btn" href="../jobs-board/">Jobs Board</a>
      </div>
    </div>
  </div>
</header>

<main>
<div class="card">
  <div class="toolbar">
    <div>
      <button class="btn" id="prev">‚Üê</button>
      <strong id="title"></strong>
      <button class="btn" id="next">‚Üí</button>
    </div>
    <div>
      <button class="btn" id="monthBtn">Month</button>
      <button class="btn" id="weekBtn">Week</button>
      <button class="btn" id="dayBtn">Day</button>
      <button class="btn" id="todayBtn">Today</button>
    </div>
  </div>

  <div id="monthView">
    <div class="grid" id="dow"></div>
    <div class="grid" id="monthGrid"></div>
  </div>

  <div id="weekView" style="display:none"></div>
  <div id="dayView" style="display:none"></div>
</div>
</main>

<!-- Manual appointment dialog -->
<dialog id="manualDlg">
  <div class="dlgHead">
    <strong id="manualDlgTitle">Manual Appointment</strong>
    <button class="btn" id="manualClose" type="button">‚úï</button>
  </div>

  <div class="dlgBody">
    <div class="two">
      <div class="field">
        <label>Date</label>
        <input id="manDate" type="date" />
      </div>
      <div class="field">
        <label>Time</label>
        <input id="manTime" type="time" />
      </div>
    </div>

    <div class="field">
      <label>Address (first line shown)</label>
      <input id="manAddr" type="text" placeholder="e.g. 12 High Street" />
    </div>

    <div class="field">
      <label>Notes (optional)</label>
      <textarea id="manNotes" placeholder="Key details..."></textarea>
      <div class="smallnote">Manual appointments sync to cloud and do not link to Jobs Board.</div>
      <div class="smallnote" id="cloudStatus" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="dlgActions">
    <button class="btn danger" id="manDelete" type="button" style="display:none">Delete</button>
    <button class="btn ok" id="manSave" type="button">Save</button>
  </div>
</dialog>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyCJPVdTvzHFRiyLTzR08hMTBp71gPEPLU8",
  authDomain:"fps-jobs-board.firebaseapp.com",
  projectId:"fps-jobs-board"
});
const auth = getAuth(app);
await signInAnonymously(auth);
const db = getFirestore(app);

/* ===== Manual appointments (CLOUD + local cache fallback) ===== */
const MANUAL_CACHE_KEY = "fps_calendar_manual_cache_v1";

function loadManualCache(){
  try{
    const raw = localStorage.getItem(MANUAL_CACHE_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch{ return {}; }
}
function saveManualCache(obj){
  localStorage.setItem(MANUAL_CACHE_KEY, JSON.stringify(obj || {}));
}
function uid(){
  return "man_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function normaliseManual(obj){
  const out = {};
  if(!obj || typeof obj !== "object") return out;
  for(const [k,v] of Object.entries(obj)){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(k)) continue;
    const arr = Array.isArray(v) ? v : [];
    out[k] = arr
      .filter(x => x && typeof x === "object")
      .map(x => ({
        id: String(x.id || uid()),
        time: String(x.time || "").slice(0,5),
        address: String(x.address || "").trim(),
        notes: String(x.notes || "").trim()
      }));
    if(out[k].length === 0) delete out[k];
  }
  return out;
}

let manualCloud = normaliseManual(loadManualCache());
let manualLoadedFromCloud = false;

const cloudStatusEl = document.getElementById("cloudStatus");
function setCloudStatus(msg){
  if(!cloudStatusEl) return;
  cloudStatusEl.textContent = msg || "";
}

/* ===== Jobs board bookings (from Firestore) ===== */
let jobs = [];
const sharedRef = doc(db, "jobsBoard", "shared");

onSnapshot(sharedRef, (snap)=>{
  const data = snap.data() || {};
  jobs = Array.isArray(data.jobs) ? data.jobs : [];

  const cloudManual = normaliseManual(data.calendarManual || {});
  if(!manualLoadedFromCloud){
    manualLoadedFromCloud = true;

    const cache = normaliseManual(loadManualCache());
    const cloudIsEmpty = Object.keys(cloudManual).length === 0;
    const cacheHas = Object.keys(cache).length > 0;

    manualCloud = cloudIsEmpty ? cache : cloudManual;

    if(cloudIsEmpty && cacheHas){
      queueManualCloudSave("Seeding cloud from this device‚Ä¶");
    } else {
      setCloudStatus("Cloud sync ready.");
    }
  } else {
    manualCloud = cloudManual;
    saveManualCache(manualCloud);
    setCloudStatus("Synced.");
  }

  render();
}, (err)=>{
  console.error("Firestore listener error:", err);
  setCloudStatus("Cloud error ‚Äî using local cache.");
  render();
});

let manualSaveTimer = null;
async function queueManualCloudSave(statusText = "Saving‚Ä¶"){
  setCloudStatus(statusText);
  saveManualCache(manualCloud);

  if(manualSaveTimer) clearTimeout(manualSaveTimer);
  manualSaveTimer = setTimeout(async ()=>{
    try{
      const u = auth.currentUser;
      await setDoc(sharedRef, {
        calendarManual: manualCloud,
        calendarManualUpdatedAtMs: Date.now(),
        calendarManualUpdatedBy: u?.uid || "anon"
      }, { merge: true });
      setCloudStatus("Saved to cloud.");
    }catch(e){
      console.error("Manual cloud save failed:", e);
      setCloudStatus("Save failed ‚Äî check internet / rules.");
    }
  }, 450);
}

/* ===== UI refs ===== */
const title = document.getElementById("title");
const monthGrid = document.getElementById("monthGrid");
const weekView = document.getElementById("weekView");
const dayView = document.getElementById("dayView");
const dow = document.getElementById("dow");
const monthView = document.getElementById("monthView");

["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(d=>{
  const el = document.createElement("div");
  el.className="dow"; el.textContent=d; dow.appendChild(el);
});

let view = new Date(); view.setDate(1);
let selected = new Date();
let mode = "month";

const pad2 = n => String(n).padStart(2,"0");
const iso = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const firstLine = a => (a||"").split(",")[0].trim();

/* ===== WORKS rules ===== */
function splitDT(dtLocal){
  const s = String(dtLocal || "");
  if(!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s)) return { dateISO:"", time:"" };
  return { dateISO: s.slice(0,10), time: s.slice(11,16) };
}
function addDaysISO(dateISO, n){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) return "";
  const d = new Date(dateISO + "T00:00");
  d.setDate(d.getDate() + (Number(n)||0));
  return iso(d);
}
function minutesFromHHMM(t){
  const m = /^(\d{2}):(\d{2})$/.exec(String(t||""));
  if(!m) return 9999;
  return (Number(m[1])||0)*60 + (Number(m[2])||0);
}
function getWorksDays(job){
  const daysRaw = Number(job.worksDays || job.worksDurationDays || job.days || 0);
  if(!Number.isFinite(daysRaw) || daysRaw <= 0) return 1;
  return daysRaw;
}
function dayLabel(n){
  const pretty = Number.isInteger(n) ? String(n) : String(n);
  const plural = (n === 1) ? "" : "s";
  return `${pretty} day${plural}`;
}
function worksDaysLabel(job){
  return dayLabel(getWorksDays(job));
}
function worksSpanDays(job){
  const d = getWorksDays(job);
  if(d <= 1) return 1;      // 0.5 or 1 => only booked day
  return Math.ceil(d);      // 1.5 => 2, 2.5 => 3, etc
}
function remainingForCarryDay(totalDays, dayIndex){
  // dayIndex: 0=start day, 1=second day, 2=third day...
  if(dayIndex <= 0) return totalDays;

  const span = (totalDays <= 1) ? 1 : Math.ceil(totalDays);
  const remainder = totalDays - Math.floor(totalDays); // 0 or 0.5 etc
  const lastIndex = span - 1;

  if(dayIndex === lastIndex && remainder > 0){
    return remainder; // e.g. 0.5
  }
  return 1; // full day for non-last carry days
}

/* ‚úÖ ONLY show jobs that are actually booked in these two job-board folders */
function jobStatusKey(job){
  return String(job?.status || "").trim();
}
function isEstVisitBooked(job){
  return jobStatusKey(job) === "est_visit_booked";
}
function isWorksBooked(job){
  return jobStatusKey(job) === "works_booked";
}

/* Build all events for a date */
function eventsFor(dateISO){
  const out = [];

  for(const j of jobs){
    // üîµ Estimate visit booked (ONLY when status is est_visit_booked)
    if(
      isEstVisitBooked(j) &&
      j.estVisitDT?.startsWith(dateISO)
    ){
      const t = j.estVisitDT.slice(11,16);
      out.push({
        t,
        sortKey: minutesFromHHMM(t),
        a: firstLine(j.address),
        dur: "",
        id: j.id,
        type:"est",
        src:"job",
        carry:false
      });
    }

    // üü¢ Works booked (ONLY when status is works_booked)
    if(isWorksBooked(j) && j.worksDT){
      const { dateISO:startISO, time:startTime } = splitDT(j.worksDT);
      if(!startISO) continue;

      const span = worksSpanDays(j);
      const keys = [];
      for(let i=0;i<span;i++) keys.push(addDaysISO(startISO, i));

      if(keys.includes(dateISO)){
        const isStartDay = (dateISO === startISO);

        if(isStartDay){
          out.push({
            t: startTime,
            sortKey: minutesFromHHMM(startTime),
            a: firstLine(j.address),
            dur: worksDaysLabel(j), // total, e.g. 1.5 days
            id: j.id,
            type:"works",
            src:"job",
            carry:false
          });
        }else{
          const total = getWorksDays(j);
          const dayIdx = keys.indexOf(dateISO); // 1,2,3...
          const left = remainingForCarryDay(total, dayIdx); // ‚úÖ 0.5 on last carry day
          out.push({
            t: "Carry on",
            sortKey: 9000,
            a: firstLine(j.address),
            dur: dayLabel(left), // ‚úÖ shows remaining for this day
            id: j.id,
            type:"carry",
            src:"job",
            carry:true
          });
        }
      }
    }
  }

  // Manual events (unchanged)
  const arr = Array.isArray(manualCloud[dateISO]) ? manualCloud[dateISO] : [];
  for(const e of arr){
    const t = (e.time || "00:00");
    out.push({
      t,
      sortKey: minutesFromHHMM(t),
      a:(e.address || "").trim(),
      dur:"",
      id:e.id,
      type:"manual",
      src:"manual",
      carry:false
    });
  }

  return out.sort((a,b)=> (a.sortKey - b.sortKey) || String(a.t||"").localeCompare(String(b.t||"")));
}

function setSelected(d){
  selected = new Date(d);
  view = new Date(selected.getFullYear(), selected.getMonth(), 1);
}

function openJobDetails(jobId){
  location.href = `../jobs-board/?job=${encodeURIComponent(jobId)}`;
}

/* Helpers for full-month week mode (42-day range) */
function getMonthRange42(y, m){
  const first = new Date(y,m,1);
  const start = new Date(first);
  start.setDate(first.getDate() - ((first.getDay()+6)%7)); // Monday on/before 1st
  return { start };
}

function render(){
  const titleDate = (mode==="day") ? selected : view;
  title.textContent = titleDate.toLocaleDateString("en-GB",{month:"long",year:"numeric"});

  monthGrid.innerHTML="";
  weekView.innerHTML="";
  dayView.innerHTML="";

  monthView.style.display = mode==="month" ? "block" : "none";
  weekView.style.display  = mode==="week"  ? "block" : "none";
  dayView.style.display   = mode==="day"   ? "block" : "none";

  const todayISO = iso(new Date());

  if(mode==="month"){
    const y=view.getFullYear(), m=view.getMonth();
    const first=new Date(y,m,1);
    const offset=(first.getDay()+6)%7;
    const days=new Date(y,m+1,0).getDate();

    for(let i=0;i<offset;i++){
      const blank=document.createElement("div");
      blank.className="day";
      blank.style.opacity="0";
      blank.style.pointerEvents="none";
      monthGrid.appendChild(blank);
    }

    for(let d=1; d<=days; d++){
      const date=new Date(y,m,d);
      const dISO = iso(date);

      const box=document.createElement("div");
      box.className="day"+(dISO===todayISO?" today":"");
      box.innerHTML=`<div class="dayNum">${d}</div>`;

      eventsFor(dISO).forEach(e=>{
        const ev=document.createElement("div");
        ev.className=`event ${e.type}${e.carry?" carry":""}`;
        const suffix = e.dur ? ` ‚Ä¢ ${e.dur}` : "";
        ev.textContent = `${e.t || "‚Äî"} ‚Ä¢ ${e.a || "(No address)"}${suffix}`;

        ev.onclick=(evt)=>{
          evt.stopPropagation();
          if(e.src === "job") openJobDetails(e.id);
          else openManualDialog(dISO, e.id);
        };
        box.appendChild(ev);
      });

      box.onclick=()=>{
        setSelected(date);
        mode="day";
        render();
      };

      monthGrid.appendChild(box);
    }
  }

  if(mode==="week"){
    const y=view.getFullYear(), m=view.getMonth();
    const { start } = getMonthRange42(y, m);

    const wrap = document.createElement("div");
    wrap.className = "weekWrap";

    const grid = document.createElement("div");
    grid.className = "weekMonthGrid";

    const monthKey = `${y}-${pad2(m+1)}`;

    for(let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const dISO = iso(d);
      const evs=eventsFor(dISO);

      const col=document.createElement("div");
      col.className="weekCol"+(dISO===todayISO?" today":"");

      const inMonth = (`${d.getFullYear()}-${pad2(d.getMonth()+1)}` === monthKey);

      col.innerHTML = `
        <div class="weekHead">
          <div style="${inMonth ? "" : "opacity:.55"}">
            ${d.toLocaleDateString("en-GB",{weekday:"short",day:"2-digit",month:"short"})}
          </div>
          <span class="badge">${evs.length} booking${evs.length===1?"":"s"}</span>
        </div>
      `;

      if(!evs.length){
        const none=document.createElement("div");
        none.className="muted";
        none.textContent="No bookings";
        col.appendChild(none);
      }else{
        evs.forEach(e=>{
          const ev=document.createElement("div");
          ev.className=`event weekEvent ${e.type}${e.carry?" carry":""}`;

          const top = document.createElement("span");
          top.className = "weekEventTop";
          top.textContent = `${e.t || "‚Äî"} ‚Ä¢ ${e.a || "(No address)"}`;
          ev.appendChild(top);

          if(e.dur){
            const dur = document.createElement("span");
            dur.className = "weekEventDur" + (e.carry ? " carryDur" : "");
            dur.textContent = e.dur;
            ev.appendChild(dur);
          }

          ev.onclick=(evt)=>{
            evt.stopPropagation();
            if(e.src === "job") openJobDetails(e.id);
            else openManualDialog(dISO, e.id);
          };
          col.appendChild(ev);
        });
      }

      col.addEventListener("click",(evt)=>{
        if(evt.target.closest(".event")) return;
        setSelected(d);
        mode="day";
        render();
      });

      grid.appendChild(col);
    }

    wrap.appendChild(grid);
    weekView.appendChild(wrap);
  }

  if(mode==="day"){
    const dISO = iso(selected);
    const evs=eventsFor(dISO);

    const head=document.createElement("div");
    head.className="weekCol"+(dISO===todayISO?" today":"");
    head.innerHTML = `
      <div class="weekHead">
        <div>${selected.toLocaleDateString("en-GB",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})}</div>
        <span class="badge">${evs.length} appointment${evs.length===1?"":"s"}</span>
      </div>
    `;
    dayView.appendChild(head);

    const list=document.createElement("div");
    list.className="list";

    if(!evs.length){
      list.innerHTML=`<div class="muted">No appointments</div>`;
    }else{
      evs.forEach(e=>{
        const li=document.createElement("div");
        li.className="listItem";
        const suffix = e.dur ? ` ‚Ä¢ ${e.dur}` : "";
        li.textContent = `${e.t || "‚Äî"} ‚Ä¢ ${e.a || "(No address)"}${suffix}`;
        li.onclick=()=>{
          if(e.src === "job") openJobDetails(e.id);
          else openManualDialog(dISO, e.id);
        };
        list.appendChild(li);
      });
    }
    dayView.appendChild(list);
  }
}

/* ===== Prev/Next + Today ===== */
document.getElementById("prev").onclick=()=>{
  if(mode==="month" || mode==="week"){
    view.setMonth(view.getMonth()-1);
  }else{
    const d=new Date(selected); d.setDate(d.getDate()-1); setSelected(d);
  }
  render();
};
document.getElementById("next").onclick=()=>{
  if(mode==="month" || mode==="week"){
    view.setMonth(view.getMonth()+1);
  }else{
    const d=new Date(selected); d.setDate(d.getDate()+1); setSelected(d);
  }
  render();
};
document.getElementById("todayBtn").onclick=()=>{
  setSelected(new Date());
  view = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  render();
};
document.getElementById("monthBtn").onclick=()=>{ mode="month"; render(); };
document.getElementById("weekBtn").onclick=()=>{ mode="week"; render(); };
document.getElementById("dayBtn").onclick=()=>{ mode="day"; render(); };

/* ===== Manual dialog logic ===== */
const manualDlg = document.getElementById("manualDlg");
const manualDlgTitle = document.getElementById("manualDlgTitle");
const manualClose = document.getElementById("manualClose");
const manDate = document.getElementById("manDate");
const manTime = document.getElementById("manTime");
const manAddr = document.getElementById("manAddr");
const manNotes = document.getElementById("manNotes");
const manDelete = document.getElementById("manDelete");
const manSave = document.getElementById("manSave");
const newManualBtn = document.getElementById("newManualBtn");

let editingManualId = null;

function openManualDialog(dateISO, manualId=null){
  const arr = Array.isArray(manualCloud[dateISO]) ? manualCloud[dateISO] : [];
  const existing = manualId ? arr.find(x=>x.id===manualId) : null;

  editingManualId = manualId || null;

  manualDlgTitle.textContent = existing ? "Edit Manual Appointment" : "New Manual Appointment";
  manDate.value = dateISO;
  manTime.value = existing?.time || "";
  manAddr.value = existing?.address || "";
  manNotes.value = existing?.notes || "";

  manDelete.style.display = existing ? "inline-flex" : "none";

  manualDlg.showModal();
}

manualClose.onclick = ()=> manualDlg.close();

newManualBtn.onclick = ()=>{
  const dISO = iso(new Date());
  setSelected(new Date());
  openManualDialog(dISO, null);
};

manSave.onclick = ()=>{
  const dateISO = (manDate.value || "").trim();
  if(!dateISO) return;

  const time = (manTime.value || "").trim();
  const address = (manAddr.value || "").trim();
  const notes = (manNotes.value || "").trim();

  if(!time && !address && !notes){
    manualDlg.close();
    return;
  }

  const arr = Array.isArray(manualCloud[dateISO]) ? manualCloud[dateISO].slice() : [];

  if(editingManualId){
    const i = arr.findIndex(x=>x.id===editingManualId);
    if(i>=0){
      arr[i] = { ...arr[i], time, address, notes };
    }else{
      arr.push({ id: editingManualId, time, address, notes });
    }
  }else{
    arr.push({ id: uid(), time, address, notes });
  }

  manualCloud[dateISO] = arr;
  manualCloud = normaliseManual(manualCloud);

  queueManualCloudSave("Saving to cloud‚Ä¶");

  setSelected(new Date(dateISO));
  manualDlg.close();
  render();
};

manDelete.onclick = ()=>{
  const dateISO = (manDate.value || "").trim();
  if(!dateISO || !editingManualId) return;

  if(!confirm("Delete this manual appointment?")) return;

  const arr = Array.isArray(manualCloud[dateISO]) ? manualCloud[dateISO].slice() : [];
  const next = arr.filter(x=>x.id !== editingManualId);

  if(next.length) manualCloud[dateISO] = next;
  else delete manualCloud[dateISO];

  manualCloud = normaliseManual(manualCloud);

  queueManualCloudSave("Deleting‚Ä¶");
  manualDlg.close();
  render();
};

render();
</script>
</body>
</html>
