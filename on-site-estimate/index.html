<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ On-Site Estimate</title>

<meta name="theme-color" content="#0b1220">

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220;
  --card:#0f1a33;
  --text:#e7eefc;
  --muted:#a9b7d3;
  --line:rgba(255,255,255,.14);
  --blue:#4aa3ff;
  --green:#22c55e;
  --red:#ef4444;
  --radius:18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;
  background:var(--bg);
  color:var(--text);
}

header{
  position:sticky;
  top:0;
  z-index:5;
  background:linear-gradient(180deg,#0b1220,#0b1220cc);
  padding:14px 16px;
  border-bottom:1px solid var(--line);
}

header h1{
  margin:0;
  font-size:18px;
  font-weight:900;
  letter-spacing:.2px;
}

header .sub{
  margin-top:4px;
  color:var(--muted);
  font-size:12px;
}

main{
  padding:16px;
  max-width:950px;
  margin:auto;
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

.card h2{
  margin:0 0 10px;
  font-size:15px;
}

label{
  font-size:12px;
  color:var(--muted);
}

input,textarea,select{
  width:100%;
  background:#081226;
  border:1px solid var(--line);
  color:var(--text);
  border-radius:12px;
  padding:10px;
  margin-top:4px;
  outline:none;
}

textarea{resize:vertical}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

@media (max-width:780px){
  .row{grid-template-columns:1fr}
}

button{
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:800;
  background:var(--blue);
  color:#081226;
  cursor:pointer;
}

button:active{transform:scale(.99)}
button:disabled{opacity:.55; cursor:not-allowed}

button.secondary{
  background:#1b2a55;
  color:var(--text);
}

button.danger{
  background:var(--red);
  color:#081226;
}

.small{
  font-size:12px;
  color:var(--muted);
}

.list{ margin-top:10px; }

.list-head{
  display:grid;
  grid-template-columns:2fr 1fr 1fr auto;
  gap:8px;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

.list-item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr auto;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
}

.list-item .remove{
  width:44px;
  padding:10px 0;
  text-align:center;
}

.pill{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#0b1630;
  color:var(--muted);
  font-size:12px;
}

.total-line{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:6px 0;
}

.total{
  font-size:20px;
  font-weight:900;
  color:var(--green);
}

hr.sep{
  border:none;
  border-top:1px solid var(--line);
  margin:12px 0;
}

.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

.toolbar > *{flex:1 1 180px}

.estList{
  margin-top:10px;
  display:grid;
  gap:10px;
}

.estCard{
  border:1px solid var(--line);
  border-radius:16px;
  background:#0b1630;
  padding:12px;
}

.estTop{
  display:flex;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
}

.estTitle{
  font-weight:900;
  font-size:14px;
  margin:0 0 2px;
}

.estMeta{
  color:var(--muted);
  font-size:12px;
  white-space:pre-line;
}

.estActions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.estActions button{
  padding:10px 12px;
  border-radius:12px;
  font-weight:900;
}

.badge{
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#0b1630;
  color:var(--muted);
  font-size:12px;
}
.dot{width:8px;height:8px;border-radius:50%;background:#64748b}
.dot.ok{background:var(--green)}
.dot.bad{background:var(--red)}
</style>
</head>

<body>
<header>
  <h1>On-Site Estimate</h1>
  <div class="sub">Multiple estimates ‚Ä¢ Firestore sync ‚Ä¢ materials + labour ‚Ä¢ GPS address ‚Ä¢ PDF export</div>
</header>

<main>

<!-- ================= SAVED ESTIMATES ================= -->
<section class="card">
  <h2>Saved Estimates</h2>

  <div class="toolbar">
    <div>
      <label>Workspace (shared across devices)</label>
      <input id="workspaceKey" placeholder="e.g. FPS">
      <div class="small">Tip: keep this the same on all devices so you see the same estimates.</div>
    </div>

    <div>
      <label>Search</label>
      <input id="searchBox" placeholder="Search agent, address, date...">
    </div>

    <div>
      <label>&nbsp;</label>
      <button id="newEstimateBtnTop" class="secondary" type="button">+ New Estimate</button>
      <div style="margin-top:8px" class="badge">
        <span class="dot" id="syncDot"></span>
        <span id="syncText">Connecting‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="small" id="listHint" style="margin-top:10px"></div>
  <div class="estList" id="estimatesList"></div>
</section>

<!-- ================= JOB DETAILS ================= -->
<section class="card">
  <h2>Job Details</h2>

  <div class="row">
    <div>
      <label>Letting Agent / Branch</label>
      <input id="clientName" placeholder="e.g. ABC Lettings - Chester">
    </div>
    <div>
      <label>Estimate Date</label>
      <input id="estimateDate" type="date">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>Door / Flat No. (if GPS misses it)</label>
      <input id="doorNo" placeholder="e.g. 12 / Flat 3">
    </div>
    <div>
      <label>GPS Address</label>
      <button id="gpsBtn" class="secondary" type="button">üìç Use GPS to fill address</button>
      <div class="small" id="gpsStatus" style="margin-top:6px"></div>
    </div>
  </div>

  <div style="margin-top:10px">
    <label>Job Address</label>
    <textarea id="jobAddress" rows="2" placeholder="Will fill from GPS (or type manually)"></textarea>
  </div>

  <div style="margin-top:10px">
    <label>Scope of Works</label>
    <textarea id="jobDesc" rows="3" placeholder="Describe works to be carried out"></textarea>
  </div>

  <div class="small" style="margin-top:10px">
    Current estimate:
    <span class="pill" id="currentIdPill">New (not saved yet)</span>
  </div>
</section>

<!-- ================= MATERIALS ================= -->
<section class="card">
  <h2>Materials</h2>

  <div class="list-head">
    <div>Item</div><div>Qty</div><div>Unit ¬£</div><div></div>
  </div>

  <div class="list-item">
    <input id="matName" placeholder="Material name">
    <input id="matQty" type="number" inputmode="decimal" placeholder="Qty">
    <input id="matCost" type="number" inputmode="decimal" placeholder="¬£">
    <button id="addMatBtn" type="button">+</button>
  </div>

  <div class="list" id="materialsList"></div>

  <div class="total-line">
    <div class="small">Materials Subtotal</div>
    <div id="materialsSubtotal">¬£0.00</div>
  </div>
</section>

<!-- ================= LABOUR ================= -->
<section class="card">
  <h2>Labour</h2>

  <div class="list-head">
    <div>Name</div><div>Days</div><div>Rate ¬£/day</div><div></div>
  </div>

  <div class="list-item">
    <input id="labName" placeholder="Name (e.g. Joe)">
    <input id="labDays" type="number" inputmode="decimal" placeholder="Days">
    <input id="labRate" type="number" inputmode="decimal" placeholder="¬£/day">
    <button id="addLabBtn" type="button">+</button>
  </div>

  <div class="list" id="labourList"></div>

  <div class="total-line">
    <div class="small">Labour Subtotal</div>
    <div id="labourSubtotal">¬£0.00</div>
  </div>
</section>

<!-- ================= TOTALS ================= -->
<section class="card">
  <h2>Totals</h2>

  <div class="row">
    <div>
      <label>Markup (¬£)</label>
      <input id="markupGBP" type="number" inputmode="decimal" value="0">
    </div>
    <div>
      <label>Commission (%)</label>
      <input id="commissionPct" type="number" inputmode="decimal" value="0">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>VAT (%)</label>
      <input id="vatPct" type="number" inputmode="decimal" value="20">
    </div>
    <div>
      <label>&nbsp;</label>
      <div class="pill">VAT applies after markup + commission</div>
    </div>
  </div>

  <hr class="sep">

  <div class="total-line">
    <div class="small">Subtotal (Materials + Labour)</div>
    <div id="subTotal">¬£0.00</div>
  </div>

  <div class="total-line">
    <div class="small">Markup</div>
    <div id="markupTotal">¬£0.00</div>
  </div>

  <div class="total-line">
    <div class="small">Commission</div>
    <div id="commissionTotal">¬£0.00</div>
  </div>

  <div class="total-line">
    <div class="small">VAT</div>
    <div id="vatTotal">¬£0.00</div>
  </div>

  <hr class="sep">

  <div class="total-line">
    <div style="font-weight:800">TOTAL</div>
    <div class="total" id="grandTotal">¬£0.00</div>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="secondary" id="saveDraftBtn" type="button">Save to Cloud</button>
    <button id="makePdfBtn" type="button">Generate PDF</button>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="secondary" id="newEstimateBtn" type="button">New / Clear</button>
    <button class="secondary" id="exportJsonBtn" type="button">Export Backup</button>
  </div>

  <div class="small" id="saveStatus" style="margin-top:10px"></div>
</section>

<script type="module">
/* ===========================
   Firebase + Firestore (modular)
   Multiple Estimates (cloud synced)
   =========================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc,
  onSnapshot, query, where, orderBy, limit,
  serverTimestamp, enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* --- Your config (from Firebase console) --- */
const firebaseConfig = {
  apiKey: "AIzaSyCJPVdTvzHFRiyLTzR08hMTBp71gPEPLU8",
  authDomain: "fps-jobs-board.firebaseapp.com",
  projectId: "fps-jobs-board",
  storageBucket: "fps-jobs-board.firebasestorage.app",
  messagingSenderId: "386598717430",
  appId: "1:386598717430:web:06a2b508f1d7fcc92069d7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Offline cache for Firestore (best effort)
enableIndexedDbPersistence(db).catch(()=>{});

/* ===========================
   Helpers
   =========================== */
const fmtGBP = (n)=> {
  const x = Number(n||0);
  return "¬£" + x.toFixed(2);
};
const num = (v)=> {
  const n = parseFloat(String(v).replace(/[^\d.\-]/g,""));
  return isNaN(n) ? 0 : n;
};
const escapeHtml = (s)=> String(s ?? "")
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#039;");

function todayISO(){
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
function nowPretty(ts){
  try{
    const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
    if(!d) return "";
    return d.toLocaleString("en-GB", {day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"});
  }catch{return "";}
}
function uid(){
  return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
}

/* ===========================
   DOM
   =========================== */
const els = {
  workspaceKey: document.getElementById("workspaceKey"),
  searchBox: document.getElementById("searchBox"),
  newEstimateBtnTop: document.getElementById("newEstimateBtnTop"),
  estimatesList: document.getElementById("estimatesList"),
  listHint: document.getElementById("listHint"),
  syncDot: document.getElementById("syncDot"),
  syncText: document.getElementById("syncText"),

  clientName: document.getElementById("clientName"),
  estimateDate: document.getElementById("estimateDate"),
  doorNo: document.getElementById("doorNo"),
  gpsBtn: document.getElementById("gpsBtn"),
  gpsStatus: document.getElementById("gpsStatus"),
  jobAddress: document.getElementById("jobAddress"),
  jobDesc: document.getElementById("jobDesc"),
  currentIdPill: document.getElementById("currentIdPill"),

  matName: document.getElementById("matName"),
  matQty: document.getElementById("matQty"),
  matCost: document.getElementById("matCost"),
  addMatBtn: document.getElementById("addMatBtn"),
  materialsList: document.getElementById("materialsList"),
  materialsSubtotal: document.getElementById("materialsSubtotal"),

  labName: document.getElementById("labName"),
  labDays: document.getElementById("labDays"),
  labRate: document.getElementById("labRate"),
  addLabBtn: document.getElementById("addLabBtn"),
  labourList: document.getElementById("labourList"),
  labourSubtotal: document.getElementById("labourSubtotal"),

  markupGBP: document.getElementById("markupGBP"),
  commissionPct: document.getElementById("commissionPct"),
  vatPct: document.getElementById("vatPct"),

  subTotal: document.getElementById("subTotal"),
  markupTotal: document.getElementById("markupTotal"),
  commissionTotal: document.getElementById("commissionTotal"),
  vatTotal: document.getElementById("vatTotal"),
  grandTotal: document.getElementById("grandTotal"),

  saveDraftBtn: document.getElementById("saveDraftBtn"),
  makePdfBtn: document.getElementById("makePdfBtn"),
  newEstimateBtn: document.getElementById("newEstimateBtn"),
  exportJsonBtn: document.getElementById("exportJsonBtn"),
  saveStatus: document.getElementById("saveStatus"),
};

let state = { materials: [], labour: [] };
let currentEstimateId = null;
let estimatesCache = []; // list from Firestore
let unsub = null;

const LS_WS = "fps_est_ws_v1";
els.workspaceKey.value = localStorage.getItem(LS_WS) || "FPS";

if(!els.estimateDate.value) els.estimateDate.value = todayISO();

/* ===========================
   Render lists (materials/labour)
   =========================== */
function renderMaterials(){
  els.materialsList.innerHTML = "";
  state.materials.forEach((m, idx)=>{
    const lineTotal = num(m.qty) * num(m.unit);
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input value="${escapeHtml(m.name)}" data-k="name" data-i="${idx}" data-t="mat">
      <input type="number" inputmode="decimal" value="${m.qty}" data-k="qty" data-i="${idx}" data-t="mat">
      <input type="number" inputmode="decimal" value="${m.unit}" data-k="unit" data-i="${idx}" data-t="mat">
      <button class="danger remove" type="button" data-remove="mat" data-i="${idx}">‚úï</button>
    `;
    els.materialsList.appendChild(div);

    const meta = document.createElement("div");
    meta.className = "small";
    meta.style.margin = "-4px 0 10px";
    meta.style.display = "flex";
    meta.style.justifyContent = "space-between";
    meta.innerHTML = `<span class="pill">Line total</span><span>${fmtGBP(lineTotal)}</span>`;
    els.materialsList.appendChild(meta);
  });
}

function renderLabour(){
  els.labourList.innerHTML = "";
  state.labour.forEach((l, idx)=>{
    const lineTotal = num(l.days) * num(l.rate);
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input value="${escapeHtml(l.name)}" data-k="name" data-i="${idx}" data-t="lab">
      <input type="number" inputmode="decimal" value="${l.days}" data-k="days" data-i="${idx}" data-t="lab">
      <input type="number" inputmode="decimal" value="${l.rate}" data-k="rate" data-i="${idx}" data-t="lab">
      <button class="danger remove" type="button" data-remove="lab" data-i="${idx}">‚úï</button>
    `;
    els.labourList.appendChild(div);

    const meta = document.createElement("div");
    meta.className = "small";
    meta.style.margin = "-4px 0 10px";
    meta.style.display = "flex";
    meta.style.justifyContent = "space-between";
    meta.innerHTML = `<span class="pill">Line total</span><span>${fmtGBP(lineTotal)}</span>`;
    els.labourList.appendChild(meta);
  });
}

/* ===========================
   Totals
   =========================== */
function calc(){
  const matSub = state.materials.reduce((a,m)=>a + (num(m.qty)*num(m.unit)), 0);
  const labSub = state.labour.reduce((a,l)=>a + (num(l.days)*num(l.rate)), 0);
  const sub = matSub + labSub;

  const markup = num(els.markupGBP.value);
  const commissionPct = num(els.commissionPct.value);
  const commission = (sub + markup) * (commissionPct/100);

  const vatPct = num(els.vatPct.value);
  const vatBase = sub + markup + commission;
  const vat = vatBase * (vatPct/100);

  const total = vatBase + vat;

  els.materialsSubtotal.textContent = fmtGBP(matSub);
  els.labourSubtotal.textContent = fmtGBP(labSub);
  els.subTotal.textContent = fmtGBP(sub);
  els.markupTotal.textContent = fmtGBP(markup);
  els.commissionTotal.textContent = fmtGBP(commission);
  els.vatTotal.textContent = fmtGBP(vat);
  els.grandTotal.textContent = fmtGBP(total);

  return {matSub, labSub, sub, markup, commissionPct, commission, vatPct, vat, total};
}

/* ===========================
   Estimate document (for Firestore)
   =========================== */
function getDocData(){
  const totals = calc();
  const ws = (els.workspaceKey.value || "FPS").trim() || "FPS";

  return {
    workspace: ws,
    agentBranch: (els.clientName.value || "").trim(),
    estimateDate: els.estimateDate.value || todayISO(),
    doorNo: (els.doorNo.value || "").trim(),
    jobAddress: (els.jobAddress.value || "").trim(),
    jobDesc: (els.jobDesc.value || "").trim(),
    markupGBP: num(els.markupGBP.value),
    commissionPct: num(els.commissionPct.value),
    vatPct: num(els.vatPct.value),
    materials: state.materials,
    labour: state.labour,
    totals: {
      materialsSubtotal: totals.matSub,
      labourSubtotal: totals.labSub,
      subtotal: totals.sub,
      markup: totals.markup,
      commission: totals.commission,
      vat: totals.vat,
      total: totals.total
    }
  };
}

function setFromDocData(d){
  els.clientName.value = d.agentBranch || "";
  els.estimateDate.value = d.estimateDate || todayISO();
  els.doorNo.value = d.doorNo || "";
  els.jobAddress.value = d.jobAddress || "";
  els.jobDesc.value = d.jobDesc || "";
  els.markupGBP.value = (d.markupGBP ?? 0);
  els.commissionPct.value = (d.commissionPct ?? 0);
  els.vatPct.value = (d.vatPct ?? 20);
  state.materials = Array.isArray(d.materials) ? d.materials : [];
  state.labour = Array.isArray(d.labour) ? d.labour : [];
  renderMaterials();
  renderLabour();
  calc();
}

/* ===========================
   Materials / Labour add + edit + remove
   =========================== */
function addMaterial(){
  const name = els.matName.value.trim();
  const qty = num(els.matQty.value);
  const unit = num(els.matCost.value);
  if(!name) return;

  state.materials.unshift({name, qty: qty||1, unit});
  els.matName.value = "";
  els.matQty.value = "";
  els.matCost.value = "";
  renderMaterials();
  calc();
}
function addLabour(){
  const name = els.labName.value.trim();
  const days = num(els.labDays.value);
  const rate = num(els.labRate.value);
  if(!name) return;

  state.labour.unshift({name, days: days||1, rate});
  els.labName.value = "";
  els.labDays.value = "";
  els.labRate.value = "";
  renderLabour();
  calc();
}

els.addMatBtn.addEventListener("click", addMaterial);
els.addLabBtn.addEventListener("click", addLabour);

[els.matName, els.matQty, els.matCost].forEach(el=>{
  el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addMaterial(); }});
});
[els.labName, els.labDays, els.labRate].forEach(el=>{
  el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addLabour(); }});
});

document.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-remove]");
  if(!btn) return;
  const type = btn.dataset.remove;
  const i = parseInt(btn.dataset.i,10);

  if(type==="mat"){
    state.materials.splice(i,1);
    renderMaterials();
  }else{
    state.labour.splice(i,1);
    renderLabour();
  }
  calc();
});

document.addEventListener("input",(e)=>{
  const inp = e.target;
  const k = inp.dataset.k;
  const i = inp.dataset.i;
  const t = inp.dataset.t;
  if(k==null || i==null || t==null) return;
  const idx = parseInt(i,10);

  if(t==="mat" && state.materials[idx] && (k==="name"||k==="qty"||k==="unit")){
    state.materials[idx][k] = (k==="name") ? inp.value : num(inp.value);
    calc();
  }
  if(t==="lab" && state.labour[idx] && (k==="name"||k==="days"||k==="rate")){
    state.labour[idx][k] = (k==="name") ? inp.value : num(inp.value);
    calc();
  }
});

[els.markupGBP, els.commissionPct, els.vatPct].forEach(el=>el.addEventListener("input", calc));

/* ===========================
   GPS Address (OpenStreetMap Nominatim)
   =========================== */
async function reverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
  const res = await fetch(url, {method:"GET"});
  if(!res.ok) throw new Error("Reverse geocode failed");
  return res.json();
}

els.gpsBtn.addEventListener("click", async ()=>{
  els.gpsStatus.textContent = "Getting location‚Ä¶";
  els.gpsBtn.disabled = true;

  if(!navigator.geolocation){
    els.gpsStatus.textContent = "GPS not supported on this device/browser.";
    els.gpsBtn.disabled = false;
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos)=>{
    try{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      els.gpsStatus.textContent = "Finding address‚Ä¶";
      const data = await reverseGeocode(lat, lon);

      const a = data.address || {};
      const house = a.house_number || "";
      const road = a.road || a.pedestrian || a.cycleway || "";
      const suburb = a.suburb || a.neighbourhood || "";
      const town = a.town || a.city || a.village || "";
      const county = a.county || "";
      const postcode = a.postcode || "";

      let line1 = [house, road].filter(Boolean).join(" ").trim();
      let line2 = [suburb, town].filter(Boolean).join(", ").trim();
      let line3 = [county, postcode].filter(Boolean).join(", ").trim();

      const door = els.doorNo.value.trim();
      if(!house && door){
        line1 = [door, road].filter(Boolean).join(" ").trim();
      }

      const addr = [line1, line2, line3].filter(Boolean).join("\n").trim();
      if(addr) els.jobAddress.value = addr;

      els.gpsStatus.textContent = addr ? "Address filled ‚úî" : "Location found but no address returned ‚Äî type manually.";
      calc();
    }catch{
      els.gpsStatus.textContent = "Couldn‚Äôt get address ‚Äî you can type it manually.";
    }finally{
      els.gpsBtn.disabled = false;
    }
  }, ()=>{
    els.gpsStatus.textContent = "GPS blocked/denied ‚Äî allow location permission then try again.";
    els.gpsBtn.disabled = false;
  }, {enableHighAccuracy:true, timeout:12000, maximumAge:30000});
});

/* ===========================
   Firestore: list / save / open / duplicate / delete
   =========================== */
const estimatesCol = collection(db, "estimates");

function setSync(ok, msg){
  els.syncDot.className = "dot " + (ok ? "ok" : "bad");
  els.syncText.textContent = msg || (ok ? "Synced" : "Offline");
}

function workspace(){
  const ws = (els.workspaceKey.value || "FPS").trim() || "FPS";
  return ws;
}

function attachListener(){
  if(unsub) unsub();
  const ws = workspace();
  els.listHint.textContent = `Workspace: "${ws}" ‚Ä¢ showing latest estimates`;

  const qy = query(
    estimatesCol,
    where("workspace","==", ws),
    orderBy("updatedAt","desc"),
    limit(60)
  );

  setSync(true, "Syncing‚Ä¶");

  unsub = onSnapshot(qy, (snap)=>{
    estimatesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    setSync(true, `Synced (${estimatesCache.length})`);
    renderEstimatesList();
  }, ()=>{
    setSync(false, "Offline (will sync when back online)");
    renderEstimatesList();
  });
}

function renderEstimatesList(){
  const term = (els.searchBox.value || "").trim().toLowerCase();
  const rows = !term ? estimatesCache : estimatesCache.filter(e=>{
    const s = [
      e.agentBranch, e.jobAddress, e.estimateDate, e.doorNo
    ].filter(Boolean).join(" | ").toLowerCase();
    return s.includes(term);
  });

  els.estimatesList.innerHTML = "";
  if(rows.length === 0){
    els.estimatesList.innerHTML = `<div class="small">No saved estimates found in this workspace.</div>`;
    return;
  }

  rows.forEach(e=>{
    const total = (e?.totals?.total ?? 0);
    const meta = [
      `Date: ${e.estimateDate || ""}`,
      e.doorNo ? `Door/Flat: ${e.doorNo}` : "",
      e.jobAddress ? e.jobAddress : "",
      e.updatedAt ? `Updated: ${nowPretty(e.updatedAt)}` : ""
    ].filter(Boolean).join("\n");

    const div = document.createElement("div");
    div.className = "estCard";
    div.innerHTML = `
      <div class="estTop">
        <div>
          <div class="estTitle">${escapeHtml(e.agentBranch || "Untitled")} ‚Ä¢ ${fmtGBP(total)}</div>
          <div class="estMeta">${escapeHtml(meta)}</div>
        </div>
        <div class="estActions">
          <button class="secondary" type="button" data-open="${e.id}">Open</button>
          <button class="secondary" type="button" data-dup="${e.id}">Duplicate</button>
          <button class="danger" type="button" data-del="${e.id}">Delete</button>
        </div>
      </div>
    `;
    els.estimatesList.appendChild(div);
  });
}

async function saveToCloud(){
  const ws = workspace();
  localStorage.setItem(LS_WS, ws);

  const data = getDocData();
  els.saveStatus.textContent = "Saving‚Ä¶";

  try{
    if(!currentEstimateId){
      // Create new
      const newId = uid(); // create our own id for easy referencing
      const ref = doc(db, "estimates", newId);
      await setDoc(ref, {
        ...data,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      currentEstimateId = newId;
      els.currentIdPill.textContent = `Saved ‚Ä¢ ${currentEstimateId}`;
      els.saveStatus.textContent = "Saved to cloud ‚úî";
    }else{
      // Update existing
      const ref = doc(db, "estimates", currentEstimateId);
      await updateDoc(ref, {
        ...data,
        updatedAt: serverTimestamp()
      });
      els.saveStatus.textContent = "Updated in cloud ‚úî";
    }
  }catch(err){
    els.saveStatus.textContent = "Could not save (offline?) ‚Äî try again when signal returns.";
  }
}

function setCurrentId(id){
  currentEstimateId = id || null;
  els.currentIdPill.textContent = currentEstimateId ? `Saved ‚Ä¢ ${currentEstimateId}` : "New (not saved yet)";
}

function clearForm(confirmAsk=true){
  if(confirmAsk && !confirm("Start a new estimate? Unsaved changes will be lost unless you saved to cloud.")) return;

  setCurrentId(null);
  state.materials = [];
  state.labour = [];
  els.clientName.value = "";
  els.estimateDate.value = todayISO();
  els.doorNo.value = "";
  els.jobAddress.value = "";
  els.jobDesc.value = "";
  els.markupGBP.value = 0;
  els.commissionPct.value = 0;
  els.vatPct.value = 20;
  els.gpsStatus.textContent = "";
  els.saveStatus.textContent = "";
  renderMaterials();
  renderLabour();
  calc();
}

async function openEstimate(id){
  const e = estimatesCache.find(x=>x.id===id);
  if(!e) return;
  setFromDocData({
    agentBranch: e.agentBranch,
    estimateDate: e.estimateDate,
    doorNo: e.doorNo,
    jobAddress: e.jobAddress,
    jobDesc: e.jobDesc,
    markupGBP: e.markupGBP,
    commissionPct: e.commissionPct,
    vatPct: e.vatPct,
    materials: e.materials,
    labour: e.labour
  });
  setCurrentId(id);
  els.saveStatus.textContent = "Loaded. Tap ‚ÄúSave to Cloud‚Äù to update.";
  window.scrollTo({top:0, behavior:"smooth"});
}

async function duplicateEstimate(id){
  const e = estimatesCache.find(x=>x.id===id);
  if(!e) return;
  if(!confirm("Duplicate this estimate as a new one?")) return;

  setFromDocData({
    agentBranch: e.agentBranch,
    estimateDate: e.estimateDate || todayISO(),
    doorNo: e.doorNo,
    jobAddress: e.jobAddress,
    jobDesc: e.jobDesc,
    markupGBP: e.markupGBP,
    commissionPct: e.commissionPct,
    vatPct: e.vatPct,
    materials: e.materials,
    labour: e.labour
  });
  setCurrentId(null);
  els.saveStatus.textContent = "Duplicated. Tap ‚ÄúSave to Cloud‚Äù to create a new record.";
  window.scrollTo({top:0, behavior:"smooth"});
}

async function deleteEstimate(id){
  if(!confirm("Delete this estimate from the cloud?")) return;
  try{
    await deleteDoc(doc(db, "estimates", id));
    if(currentEstimateId === id) clearForm(false);
  }catch{
    alert("Could not delete (offline?)");
  }
}

document.addEventListener("click",(e)=>{
  const openBtn = e.target.closest("[data-open]");
  if(openBtn) return openEstimate(openBtn.dataset.open);

  const dupBtn = e.target.closest("[data-dup]");
  if(dupBtn) return duplicateEstimate(dupBtn.dataset.dup);

  const delBtn = e.target.closest("[data-del]");
  if(delBtn) return deleteEstimate(delBtn.dataset.del);
});

/* ===========================
   PDF generation
   =========================== */
function wrapText(docp, text, x, y, maxW, lineH){
  const lines = docp.splitTextToSize(String(text||""), maxW);
  lines.forEach((ln, idx)=> docp.text(ln, x, y + idx*lineH));
  return y + (lines.length * lineH);
}

els.makePdfBtn.addEventListener("click", ()=>{
  const totals = calc();
  const { jsPDF } = window.jspdf;

  const docp = new jsPDF({unit:"pt", format:"a4"});
  const W = docp.internal.pageSize.getWidth();
  const H = docp.internal.pageSize.getHeight();
  const M = 42;

  docp.setFont("helvetica","bold");
  docp.setFontSize(16);
  docp.text("FORD PROPERTY SERVICES", M, 56);

  docp.setFont("helvetica","normal");
  docp.setFontSize(10);
  docp.text("On-Site Estimate", M, 74);
  docp.text(`Date: ${els.estimateDate.value || ""}`, W - M, 56, {align:"right"});

  let y = 96;
  docp.setDrawColor(220);
  docp.setLineWidth(0.8);
  docp.roundedRect(M, y, W-(M*2), 92, 10, 10);

  docp.setFont("helvetica","bold");
  docp.text("Agent / Job", M+12, y+18);
  docp.setFont("helvetica","normal");

  docp.text(`Agent/Branch: ${els.clientName.value || ""}`, M+12, y+36);

  const door = els.doorNo.value.trim();
  if(door) docp.text(`Door/Flat: ${door}`, M+12, y+52);

  docp.text("Address:", (W/2), y+18);
  wrapText(docp, els.jobAddress.value || "", (W/2), y+36, (W/2)-M-12, 12);

  y = 200;
  docp.roundedRect(M, y, W-(M*2), 92, 10, 10);
  docp.setFont("helvetica","bold");
  docp.text("Scope of Works", M+12, y+18);
  docp.setFont("helvetica","normal");
  wrapText(docp, els.jobDesc.value || "", M+12, y+36, W-(M*2)-24, 12);

  y = 312;

  function tableTitle(title){
    docp.setFont("helvetica","bold");
    docp.setFontSize(12);
    docp.text(title, M, y);
    y += 10;
    docp.setLineWidth(0.8);
    docp.line(M, y, W-M, y);
    y += 16;
  }

  function ensureSpace(minSpace){
    if(y + minSpace > H - M){
      docp.addPage();
      y = M;
    }
  }

  // Materials
  tableTitle("Materials");
  docp.setFontSize(10);
  docp.setFont("helvetica","bold");
  docp.text("Item", M, y);
  docp.text("Qty", W-220, y);
  docp.text("Unit", W-160, y);
  docp.text("Total", W-M, y, {align:"right"});
  docp.setFont("helvetica","normal");
  y += 12;

  const mat = state.materials.slice().reverse();
  if(mat.length === 0){
    docp.text("‚Äî", M, y); y += 14;
  }else{
    mat.forEach(m=>{
      ensureSpace(28);
      const lineTotal = num(m.qty)*num(m.unit);
      docp.text(String(m.name||""), M, y);
      docp.text(String(m.qty||0), W-220, y);
      docp.text(fmtGBP(m.unit), W-160, y);
      docp.text(fmtGBP(lineTotal), W-M, y, {align:"right"});
      y += 14;
    });
  }

  docp.setFont("helvetica","bold");
  docp.text("Materials Subtotal", W-220, y+6);
  docp.text(fmtGBP(totals.matSub), W-M, y+6, {align:"right"});
  docp.setFont("helvetica","normal");
  y += 26;

  // Labour
  tableTitle("Labour");
  docp.setFontSize(10);
  docp.setFont("helvetica","bold");
  docp.text("Name", M, y);
  docp.text("Days", W-220, y);
  docp.text("Rate", W-160, y);
  docp.text("Total", W-M, y, {align:"right"});
  docp.setFont("helvetica","normal");
  y += 12;

  const lab = state.labour.slice().reverse();
  if(lab.length === 0){
    docp.text("‚Äî", M, y); y += 14;
  }else{
    lab.forEach(l=>{
      ensureSpace(28);
      const lineTotal = num(l.days)*num(l.rate);
      docp.text(String(l.name||""), M, y);
      docp.text(String(l.days||0), W-220, y);
      docp.text(fmtGBP(l.rate), W-160, y);
      docp.text(fmtGBP(lineTotal), W-M, y, {align:"right"});
      y += 14;
    });
  }

  docp.setFont("helvetica","bold");
  docp.text("Labour Subtotal", W-220, y+6);
  docp.text(fmtGBP(totals.labSub), W-M, y+6, {align:"right"});
  docp.setFont("helvetica","normal");
  y += 26;

  // Totals
  ensureSpace(150);
  docp.roundedRect(M, y, W-(M*2), 130, 10, 10);
  docp.setFont("helvetica","bold");
  docp.text("Totals", M+12, y+20);

  docp.setFont("helvetica","normal");
  docp.text("Subtotal", M+12, y+42);
  docp.text(fmtGBP(totals.sub), W-M-12, y+42, {align:"right"});

  docp.text("Markup", M+12, y+58);
  docp.text(fmtGBP(totals.markup), W-M-12, y+58, {align:"right"});

  docp.text(`Commission (${totals.commissionPct}%)`, M+12, y+74);
  docp.text(fmtGBP(totals.commission), W-M-12, y+74, {align:"right"});

  docp.text(`VAT (${totals.vatPct}%)`, M+12, y+90);
  docp.text(fmtGBP(totals.vat), W-M-12, y+90, {align:"right"});

  docp.setFont("helvetica","bold");
  docp.setFontSize(14);
  docp.text("TOTAL", M+12, y+114);
  docp.text(fmtGBP(totals.total), W-M-12, y+114, {align:"right"});

  docp.setFontSize(9);
  docp.setFont("helvetica","normal");
  docp.text("Prepared on site ‚Ä¢ Ford Property Services", M, H - 26);

  const fname = `FPS_Estimate_${(els.clientName.value||"Agent").replace(/[^a-z0-9]+/gi,"_")}_${(els.estimateDate.value||todayISO())}.pdf`;
  docp.save(fname);
});

/* ===========================
   Buttons / events
   =========================== */
els.saveDraftBtn.addEventListener("click", saveToCloud);

els.newEstimateBtn.addEventListener("click", ()=> clearForm(true));
els.newEstimateBtnTop.addEventListener("click", ()=> clearForm(true));

els.exportJsonBtn.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify({ id: currentEstimateId, ...getDocData() }, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FPS_OnSiteEstimate_Backup_${(els.estimateDate.value||todayISO())}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});

els.searchBox.addEventListener("input", renderEstimatesList);

els.workspaceKey.addEventListener("change", ()=>{
  localStorage.setItem(LS_WS, workspace());
  attachListener();
});

/* ===========================
   Init
   =========================== */
renderMaterials();
renderLabour();
calc();
setCurrentId(null);
attachListener();
setSync(true, "Syncing‚Ä¶");
</script>

</main>
</body>
</html>
