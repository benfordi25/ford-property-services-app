<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ On-Site Estimate</title>

<meta name="theme-color" content="#0b1220">

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220;
  --card:#0f1a33;
  --text:#e7eefc;
  --muted:#a9b7d3;
  --line:rgba(255,255,255,.14);
  --blue:#4aa3ff;
  --green:#22c55e;
  --red:#ef4444;
  --radius:18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;
  background:var(--bg);
  color:var(--text);
}

header{
  position:sticky;
  top:0;
  z-index:5;
  background:linear-gradient(180deg,#0b1220,#0b1220cc);
  padding:14px 16px;
  border-bottom:1px solid var(--line);
}

header h1{
  margin:0;
  font-size:18px;
  font-weight:900;
  letter-spacing:.2px;
}

header .sub{
  margin-top:4px;
  color:var(--muted);
  font-size:12px;
}

main{
  padding:16px;
  max-width:900px;
  margin:auto;
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

.card h2{
  margin:0 0 10px;
  font-size:15px;
}

label{
  font-size:12px;
  color:var(--muted);
}

input,textarea,select{
  width:100%;
  background:#081226;
  border:1px solid var(--line);
  color:var(--text);
  border-radius:12px;
  padding:10px;
  margin-top:4px;
  outline:none;
}

textarea{resize:vertical}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

@media (max-width:700px){
  .row{grid-template-columns:1fr}
}

button{
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:800;
  background:var(--blue);
  color:#081226;
  cursor:pointer;
}

button:active{transform:scale(.99)}

button.secondary{
  background:#1b2a55;
  color:var(--text);
}

button.danger{
  background:var(--red);
  color:#081226;
}

.small{
  font-size:12px;
  color:var(--muted);
}

.list{
  margin-top:10px;
}

.list-head{
  display:grid;
  grid-template-columns:2fr 1fr 1fr auto;
  gap:8px;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

.list-item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr auto;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
}

.list-item .remove{
  width:44px;
  padding:10px 0;
  text-align:center;
}

.pill{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#0b1630;
  color:var(--muted);
  font-size:12px;
}

.total-line{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:6px 0;
}

.total{
  font-size:20px;
  font-weight:900;
  color:var(--green);
}

hr.sep{
  border:none;
  border-top:1px solid var(--line);
  margin:12px 0;
}
</style>
</head>

<body>

<header>
  <h1>On-Site Estimate</h1>
  <div class="sub">On-site estimate ‚Ä¢ materials + labour ‚Ä¢ GPS address ‚Ä¢ PDF export</div>
</header>

<main>
  <!-- ================= AGENT & JOB ================= -->
<section class="card">
  <h2>Job Details</h2>

  <div class="row">
    <div>
      <label>Letting Agent / Branch</label>
      <input id="clientName" placeholder="e.g. ABC Lettings - Chester">
    </div>
    <div>
      <label>Estimate Date</label>
      <input id="estimateDate" type="date">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>Door / Flat No. (if GPS misses it)</label>
      <input id="doorNo" placeholder="e.g. 12 / Flat 3">
    </div>
    <div>
      <label>GPS Address</label>
      <button id="gpsBtn" class="secondary" type="button">üìç Use GPS to fill address</button>
      <div class="small" id="gpsStatus" style="margin-top:6px"></div>
    </div>
  </div>

  <div style="margin-top:10px">
    <label>Job Address</label>
    <textarea id="jobAddress" rows="2" placeholder="Will fill from GPS (or type manually)"></textarea>
  </div>

  <div style="margin-top:10px">
    <label>Scope of Works</label>
    <textarea id="jobDesc" rows="3" placeholder="Describe works to be carried out"></textarea>
  </div>
</section>

<!-- ================= MATERIALS ================= -->
<section class="card">
  <h2>Materials</h2>

  <div class="list-head">
    <div>Item</div><div>Qty</div><div>Unit ¬£</div><div></div>
  </div>

  <div class="list-item">
    <input id="matName" placeholder="Material name">
    <input id="matQty" type="number" inputmode="decimal" placeholder="Qty">
    <input id="matCost" type="number" inputmode="decimal" placeholder="¬£">
    <button id="addMatBtn" type="button">+</button>
  </div>

  <div class="list" id="materialsList"></div>

  <div class="total-line">
    <div class="small">Materials Subtotal</div>
    <div id="materialsSubtotal">¬£0.00</div>
  </div>
</section>

<!-- ================= LABOUR ================= -->
<section class="card">
  <h2>Labour</h2>

  <div class="list-head">
    <div>Name</div><div>Days</div><div>Rate ¬£/day</div><div></div>
  </div>

  <div class="list-item">
    <input id="labName" placeholder="Name (e.g. Joe)">
    <input id="labDays" type="number" inputmode="decimal" placeholder="Days">
    <input id="labRate" type="number" inputmode="decimal" placeholder="¬£/day">
    <button id="addLabBtn" type="button">+</button>
  </div>

  <div class="list" id="labourList"></div>

  <div class="total-line">
    <div class="small">Labour Subtotal</div>
    <div id="labourSubtotal">¬£0.00</div>
  </div>
</section>

<!-- ================= TOTALS ================= -->
<section class="card">
  <h2>Totals</h2>

  <div class="row">
    <div>
      <label>Markup (¬£)</label>
      <input id="markupGBP" type="number" inputmode="decimal" value="0">
    </div>
    <div>
      <label>Commission (%)</label>
      <input id="commissionPct" type="number" inputmode="decimal" value="0">
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>VAT (%)</label>
      <input id="vatPct" type="number" inputmode="decimal" value="20">
    </div>
    <div>
      <label>&nbsp;</label>
      <div class="pill">VAT applies after markup + commission</div>
    </div>
  </div>

  <hr class="sep">

  <div class="total-line">
    <div class="small">Subtotal (Materials + Labour)</div>
    <div id="subTotal">¬£0.00</div>
  </div>

  <div class="total-line">
    <div class="small">Markup</div>
    <div id="markupTotal">¬£0.00</div>
  </div>

  <div class="total-line">
    <div class="small">Commission</div>
    <div id="commissionTotal">¬£0.00</div>
  </div>

  <div class="total-line">
    <div class="small">VAT</div>
    <div id="vatTotal">¬£0.00</div>
  </div>

  <hr class="sep">

  <div class="total-line">
    <div style="font-weight:800">TOTAL</div>
    <div class="total" id="grandTotal">¬£0.00</div>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="secondary" id="saveDraftBtn" type="button">Save Draft</button>
    <button id="makePdfBtn" type="button">Generate PDF</button>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="secondary" id="newEstimateBtn" type="button">New / Clear</button>
    <button class="secondary" id="exportJsonBtn" type="button">Export Backup</button>
  </div>
</section>
<script>
/* ===========================
   On-Site Estimate ‚Ä¢ FPS
   =========================== */

const fmtGBP = (n)=> {
  const x = Number(n||0);
  return "¬£" + x.toFixed(2);
};
const num = (v)=> {
  const n = parseFloat(String(v).replace(/[^\d.\-]/g,""));
  return isNaN(n) ? 0 : n;
};
const escapeHtml = (s)=> String(s ?? "")
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#039;");

const els = {
  clientName: document.getElementById("clientName"),
  estimateDate: document.getElementById("estimateDate"),
  doorNo: document.getElementById("doorNo"),
  gpsBtn: document.getElementById("gpsBtn"),
  gpsStatus: document.getElementById("gpsStatus"),
  jobAddress: document.getElementById("jobAddress"),
  jobDesc: document.getElementById("jobDesc"),

  matName: document.getElementById("matName"),
  matQty: document.getElementById("matQty"),
  matCost: document.getElementById("matCost"),
  addMatBtn: document.getElementById("addMatBtn"),
  materialsList: document.getElementById("materialsList"),
  materialsSubtotal: document.getElementById("materialsSubtotal"),

  labName: document.getElementById("labName"),
  labDays: document.getElementById("labDays"),
  labRate: document.getElementById("labRate"),
  addLabBtn: document.getElementById("addLabBtn"),
  labourList: document.getElementById("labourList"),
  labourSubtotal: document.getElementById("labourSubtotal"),

  markupGBP: document.getElementById("markupGBP"),
  commissionPct: document.getElementById("commissionPct"),
  vatPct: document.getElementById("vatPct"),

  subTotal: document.getElementById("subTotal"),
  markupTotal: document.getElementById("markupTotal"),
  commissionTotal: document.getElementById("commissionTotal"),
  vatTotal: document.getElementById("vatTotal"),
  grandTotal: document.getElementById("grandTotal"),

  saveDraftBtn: document.getElementById("saveDraftBtn"),
  makePdfBtn: document.getElementById("makePdfBtn"),
  newEstimateBtn: document.getElementById("newEstimateBtn"),
  exportJsonBtn: document.getElementById("exportJsonBtn"),
};

let state = { materials: [], labour: [] };

function todayISO(){
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
if(!els.estimateDate.value) els.estimateDate.value = todayISO();

/* ===========================
   Lists
   =========================== */
function renderMaterials(){
  els.materialsList.innerHTML = "";
  state.materials.forEach((m, idx)=>{
    const lineTotal = num(m.qty) * num(m.unit);
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input value="${escapeHtml(m.name)}" data-k="name" data-i="${idx}">
      <input type="number" inputmode="decimal" value="${m.qty}" data-k="qty" data-i="${idx}">
      <input type="number" inputmode="decimal" value="${m.unit}" data-k="unit" data-i="${idx}">
      <button class="danger remove" type="button" data-remove="mat" data-i="${idx}">‚úï</button>
    `;
    els.materialsList.appendChild(div);

    const meta = document.createElement("div");
    meta.className = "small";
    meta.style.margin = "-4px 0 10px";
    meta.style.display = "flex";
    meta.style.justifyContent = "space-between";
    meta.innerHTML = `<span class="pill">Line total</span><span>${fmtGBP(lineTotal)}</span>`;
    els.materialsList.appendChild(meta);
  });
}

function renderLabour(){
  els.labourList.innerHTML = "";
  state.labour.forEach((l, idx)=>{
    const lineTotal = num(l.days) * num(l.rate);
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <input value="${escapeHtml(l.name)}" data-k="name" data-i="${idx}">
      <input type="number" inputmode="decimal" value="${l.days}" data-k="days" data-i="${idx}">
      <input type="number" inputmode="decimal" value="${l.rate}" data-k="rate" data-i="${idx}">
      <button class="danger remove" type="button" data-remove="lab" data-i="${idx}">‚úï</button>
    `;
    els.labourList.appendChild(div);

    const meta = document.createElement("div");
    meta.className = "small";
    meta.style.margin = "-4px 0 10px";
    meta.style.display = "flex";
    meta.style.justifyContent = "space-between";
    meta.innerHTML = `<span class="pill">Line total</span><span>${fmtGBP(lineTotal)}</span>`;
    els.labourList.appendChild(meta);
  });
}

/* ===========================
   Totals
   =========================== */
function calc(){
  const matSub = state.materials.reduce((a,m)=>a + (num(m.qty)*num(m.unit)), 0);
  const labSub = state.labour.reduce((a,l)=>a + (num(l.days)*num(l.rate)), 0);
  const sub = matSub + labSub;

  const markup = num(els.markupGBP.value);
  const commissionPct = num(els.commissionPct.value);
  const commission = (sub + markup) * (commissionPct/100);

  const vatPct = num(els.vatPct.value);
  const vatBase = sub + markup + commission;
  const vat = vatBase * (vatPct/100);

  const total = vatBase + vat;

  els.materialsSubtotal.textContent = fmtGBP(matSub);
  els.labourSubtotal.textContent = fmtGBP(labSub);
  els.subTotal.textContent = fmtGBP(sub);
  els.markupTotal.textContent = fmtGBP(markup);
  els.commissionTotal.textContent = fmtGBP(commission);
  els.vatTotal.textContent = fmtGBP(vat);
  els.grandTotal.textContent = fmtGBP(total);

  return {matSub, labSub, sub, markup, commissionPct, commission, vatPct, vat, total};
}

/* ===========================
   Add items
   =========================== */
function addMaterial(){
  const name = els.matName.value.trim();
  const qty = num(els.matQty.value);
  const unit = num(els.matCost.value);
  if(!name) return;

  state.materials.unshift({name, qty: qty||1, unit});
  els.matName.value = "";
  els.matQty.value = "";
  els.matCost.value = "";
  renderMaterials();
  calc();
  autosave();
}

function addLabour(){
  const name = els.labName.value.trim();
  const days = num(els.labDays.value);
  const rate = num(els.labRate.value);
  if(!name) return;

  state.labour.unshift({name, days: days||1, rate});
  els.labName.value = "";
  els.labDays.value = "";
  els.labRate.value = "";
  renderLabour();
  calc();
  autosave();
}

els.addMatBtn.addEventListener("click", addMaterial);
els.addLabBtn.addEventListener("click", addLabour);

[els.matName, els.matQty, els.matCost].forEach(el=>{
  el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addMaterial(); }});
});
[els.labName, els.labDays, els.labRate].forEach(el=>{
  el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); addLabour(); }});
});

document.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-remove]");
  if(!btn) return;
  const type = btn.dataset.remove;
  const i = parseInt(btn.dataset.i,10);

  if(type==="mat"){
    state.materials.splice(i,1);
    renderMaterials();
  }else{
    state.labour.splice(i,1);
    renderLabour();
  }
  calc();
  autosave();
});

document.addEventListener("input",(e)=>{
  const inp = e.target;
  const k = inp.dataset.k;
  const i = inp.dataset.i;
  if(k==null || i==null) return;
  const idx = parseInt(i,10);

  if(state.materials[idx] && (k==="name"||k==="qty"||k==="unit")){
    state.materials[idx][k] = (k==="name") ? inp.value : num(inp.value);
    calc(); autosave();
  }
  if(state.labour[idx] && (k==="name"||k==="days"||k==="rate")){
    state.labour[idx][k] = (k==="name") ? inp.value : num(inp.value);
    calc(); autosave();
  }
});

[els.markupGBP, els.commissionPct, els.vatPct].forEach(el=>el.addEventListener("input", ()=>{ calc(); autosave(); }));

/* ===========================
   Draft save/load
   =========================== */
const KEY = "fps_on_site_estimate_draft_v2";

function getDoc(){
  return {
    clientName: els.clientName.value.trim(),
    estimateDate: els.estimateDate.value,
    doorNo: els.doorNo.value.trim(),
    jobAddress: els.jobAddress.value.trim(),
    jobDesc: els.jobDesc.value.trim(),
    markupGBP: num(els.markupGBP.value),
    commissionPct: num(els.commissionPct.value),
    vatPct: num(els.vatPct.value),
    materials: state.materials,
    labour: state.labour,
    savedAt: new Date().toISOString()
  };
}

function setDoc(doc){
  els.clientName.value = doc.clientName || "";
  els.estimateDate.value = doc.estimateDate || todayISO();
  els.doorNo.value = doc.doorNo || "";
  els.jobAddress.value = doc.jobAddress || "";
  els.jobDesc.value = doc.jobDesc || "";
  els.markupGBP.value = (doc.markupGBP ?? 0);
  els.commissionPct.value = (doc.commissionPct ?? 0);
  els.vatPct.value = (doc.vatPct ?? 20);
  state.materials = Array.isArray(doc.materials) ? doc.materials : [];
  state.labour = Array.isArray(doc.labour) ? doc.labour : [];
  renderMaterials();
  renderLabour();
  calc();
}

function autosave(){
  try{ localStorage.setItem(KEY, JSON.stringify(getDoc())); }catch{}
}

function loadDraft(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    const doc = JSON.parse(raw);
    setDoc(doc);
  }catch{}
}

els.saveDraftBtn.addEventListener("click", ()=>{
  autosave();
  alert("Draft saved on this device.");
});

els.newEstimateBtn.addEventListener("click", ()=>{
  if(!confirm("Clear this estimate?")) return;
  state.materials = [];
  state.labour = [];
  els.clientName.value = "";
  els.estimateDate.value = todayISO();
  els.doorNo.value = "";
  els.jobAddress.value = "";
  els.jobDesc.value = "";
  els.markupGBP.value = 0;
  els.commissionPct.value = 0;
  els.vatPct.value = 20;
  renderMaterials(); renderLabour(); calc();
  autosave();
});

els.exportJsonBtn.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(getDoc(), null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FPS_OnSiteEstimate_Backup_${(els.estimateDate.value||todayISO())}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});

/* ===========================
   GPS Address
   Uses OpenStreetMap Nominatim reverse geocode
   =========================== */
async function reverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
  const res = await fetch(url, {method:"GET"});
  if(!res.ok) throw new Error("Reverse geocode failed");
  return res.json();
}

els.gpsBtn.addEventListener("click", async ()=>{
  els.gpsStatus.textContent = "Getting location‚Ä¶";
  els.gpsBtn.disabled = true;

  if(!navigator.geolocation){
    els.gpsStatus.textContent = "GPS not supported on this device/browser.";
    els.gpsBtn.disabled = false;
    return;
  }

  navigator.geolocation.getCurrentPosition(async (pos)=>{
    try{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      els.gpsStatus.textContent = "Finding address‚Ä¶";
      const data = await reverseGeocode(lat, lon);

      const a = data.address || {};
      const house = a.house_number || "";
      const road = a.road || a.pedestrian || a.cycleway || "";
      const suburb = a.suburb || a.neighbourhood || "";
      const town = a.town || a.city || a.village || "";
      const county = a.county || "";
      const postcode = a.postcode || "";

      // Build a clean UK-ish line
      let line1 = [house, road].filter(Boolean).join(" ").trim();
      let line2 = [suburb, town].filter(Boolean).join(", ").trim();
      let line3 = [county, postcode].filter(Boolean).join(", ").trim();

      // If no house number, let user use Door/Flat field
      const door = els.doorNo.value.trim();
      if(!house && door){
        line1 = [door, road].filter(Boolean).join(" ").trim();
      }

      const addr = [line1, line2, line3].filter(Boolean).join("\n").trim();
      if(addr) els.jobAddress.value = addr;

      els.gpsStatus.textContent = addr ? "Address filled ‚úî" : "Location found but no address returned ‚Äî type manually.";
      calc(); autosave();
    }catch(err){
      els.gpsStatus.textContent = "Couldn‚Äôt get address ‚Äî you can type it manually.";
    }finally{
      els.gpsBtn.disabled = false;
    }
  }, (err)=>{
    els.gpsStatus.textContent = "GPS blocked/denied ‚Äî allow location permission then try again.";
    els.gpsBtn.disabled = false;
  }, {enableHighAccuracy:true, timeout:12000, maximumAge:30000});
});

/* ===========================
   PDF generation
   =========================== */
function wrapText(doc, text, x, y, maxW, lineH){
  const lines = doc.splitTextToSize(String(text||""), maxW);
  lines.forEach((ln, idx)=> doc.text(ln, x, y + idx*lineH));
  return y + (lines.length * lineH);
}

els.makePdfBtn.addEventListener("click", ()=>{
  const totals = calc();
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const M = 42;

  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("FORD PROPERTY SERVICES", M, 56);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text("On-Site Estimate", M, 74);
  doc.text(`Date: ${els.estimateDate.value || ""}`, W - M, 56, {align:"right"});

  let y = 96;
  doc.setDrawColor(220);
  doc.setLineWidth(0.8);
  doc.roundedRect(M, y, W-(M*2), 92, 10, 10);

  doc.setFont("helvetica","bold");
  doc.text("Agent / Job", M+12, y+18);
  doc.setFont("helvetica","normal");

  doc.text(`Agent/Branch: ${els.clientName.value || ""}`, M+12, y+36);

  const door = els.doorNo.value.trim();
  const doorLine = door ? `Door/Flat: ${door}` : "";
  if(doorLine) doc.text(doorLine, M+12, y+52);

  doc.text("Address:", (W/2), y+18);
  wrapText(doc, els.jobAddress.value || "", (W/2), y+36, (W/2)-M-12, 12);

  y = 200;
  doc.roundedRect(M, y, W-(M*2), 92, 10, 10);
  doc.setFont("helvetica","bold");
  doc.text("Scope of Works", M+12, y+18);
  doc.setFont("helvetica","normal");
  wrapText(doc, els.jobDesc.value || "", M+12, y+36, W-(M*2)-24, 12);

  y = 312;

  function tableTitle(title){
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text(title, M, y);
    y += 10;
    doc.setLineWidth(0.8);
    doc.line(M, y, W-M, y);
    y += 16;
  }

  function ensureSpace(minSpace){
    if(y + minSpace > H - M){
      doc.addPage();
      y = M;
    }
  }

  // Materials
  tableTitle("Materials");
  doc.setFontSize(10);
  doc.setFont("helvetica","bold");
  doc.text("Item", M, y);
  doc.text("Qty", W-220, y);
  doc.text("Unit", W-160, y);
  doc.text("Total", W-M, y, {align:"right"});
  doc.setFont("helvetica","normal");
  y += 12;

  const mat = state.materials.slice().reverse();
  if(mat.length === 0){
    doc.text("‚Äî", M, y); y += 14;
  }else{
    mat.forEach(m=>{
      ensureSpace(28);
      const lineTotal = num(m.qty)*num(m.unit);
      doc.text(String(m.name||""), M, y);
      doc.text(String(m.qty||0), W-220, y);
      doc.text(fmtGBP(m.unit), W-160, y);
      doc.text(fmtGBP(lineTotal), W-M, y, {align:"right"});
      y += 14;
    });
  }

  doc.setFont("helvetica","bold");
  doc.text("Materials Subtotal", W-220, y+6);
  doc.text(fmtGBP(totals.matSub), W-M, y+6, {align:"right"});
  doc.setFont("helvetica","normal");
  y += 26;

  // Labour
  tableTitle("Labour");
  doc.setFontSize(10);
  doc.setFont("helvetica","bold");
  doc.text("Name", M, y);
  doc.text("Days", W-220, y);
  doc.text("Rate", W-160, y);
  doc.text("Total", W-M, y, {align:"right"});
  doc.setFont("helvetica","normal");
  y += 12;

  const lab = state.labour.slice().reverse();
  if(lab.length === 0){
    doc.text("‚Äî", M, y); y += 14;
  }else{
    lab.forEach(l=>{
      ensureSpace(28);
      const lineTotal = num(l.days)*num(l.rate);
      doc.text(String(l.name||""), M, y);
      doc.text(String(l.days||0), W-220, y);
      doc.text(fmtGBP(l.rate), W-160, y);
      doc.text(fmtGBP(lineTotal), W-M, y, {align:"right"});
      y += 14;
    });
  }

  doc.setFont("helvetica","bold");
  doc.text("Labour Subtotal", W-220, y+6);
  doc.text(fmtGBP(totals.labSub), W-M, y+6, {align:"right"});
  doc.setFont("helvetica","normal");
  y += 26;

  // Totals box
  ensureSpace(150);
  doc.roundedRect(M, y, W-(M*2), 130, 10, 10);
  doc.setFont("helvetica","bold");
  doc.text("Totals", M+12, y+20);

  doc.setFont("helvetica","normal");
  doc.text("Subtotal", M+12, y+42);
  doc.text(fmtGBP(totals.sub), W-M-12, y+42, {align:"right"});

  doc.text("Markup", M+12, y+58);
  doc.text(fmtGBP(totals.markup), W-M-12, y+58, {align:"right"});

  doc.text(`Commission (${totals.commissionPct}%)`, M+12, y+74);
  doc.text(fmtGBP(totals.commission), W-M-12, y+74, {align:"right"});

  doc.text(`VAT (${totals.vatPct}%)`, M+12, y+90);
  doc.text(fmtGBP(totals.vat), W-M-12, y+90, {align:"right"});

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("TOTAL", M+12, y+114);
  doc.text(fmtGBP(totals.total), W-M-12, y+114, {align:"right"});

  doc.setFontSize(9);
  doc.setFont("helvetica","normal");
  doc.text("Prepared on site ‚Ä¢ Ford Property Services", M, H - 26);

  const fname = `FPS_Estimate_${(els.clientName.value||"Agent").replace(/[^a-z0-9]+/gi,"_")}_${(els.estimateDate.value||todayISO())}.pdf`;
  doc.save(fname);
});

/* ===========================
   Init
   =========================== */
loadDraft();
renderMaterials();
renderLabour();
calc();

[
  els.clientName, els.estimateDate, els.doorNo,
  els.jobAddress, els.jobDesc,
  els.markupGBP, els.commissionPct, els.vatPct
].forEach(el=> el.addEventListener("input", autosave));
</script>

</main>
</body>
</html>
