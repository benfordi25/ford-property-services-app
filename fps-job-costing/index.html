<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ford Property Services – Job Costing</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2e; --muted:#94a3b8; --text:#e5e7eb; --line:#26314d; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#070c16);color:var(--text)}
    .wrap{max-width:1200px;margin:18px auto;padding:14px}
    h1{font-size:18px;margin:0 0 8px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.35}
    .layout{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){ .layout{grid-template-columns:320px 1fr} }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{background:rgba(17,26,46,.92);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:720px){ .row{grid-template-columns:repeat(4,1fr)} .row.two{grid-template-columns:repeat(2,1fr)} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:#0b1220;color:var(--text);outline:none
    }
    input:focus,select:focus{border-color:#3b82f6}
    button{cursor:pointer}
    .btn{background:#1f3a6b;border-color:#2b4d90}
    .btn:active{transform:translateY(1px)}
    .small{padding:8px 10px;font-size:12px;border-radius:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220;color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .right{display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap;margin-top:10px}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .danger{color:#fca5a5}
    .ok{color:#86efac}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
    td{padding:0 6px}

    .totals{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:700px){ .totals{grid-template-columns:repeat(4,1fr)} }
    .kpi{padding:12px;border-radius:14px;border:1px solid var(--line);background:#0b1220}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;margin-top:6px}

    .profitBox{border-color:rgba(134,239,172,.35)}
    .lossBox{border-color:rgba(252,165,165,.35)}

    .readonlyTag{
      display:none;
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(252,165,165,.35);
      background:#0b1220;
      color:#fca5a5;
      font-size:12px;
      line-height:1.35;
    }
    .readonly .readonlyTag{display:block}
    .readonly input,
    .readonly select{ opacity:.78; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Ford Property Services – Job Costing</h1>
        <div class="sub">Cloud-synced across devices (Firebase). Multiple jobs + clean PDF export. Login required.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="pill" id="userPill">Not signed in</span>
        <button class="small" id="signOutBtn" disabled>Sign out</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <span class="pill">Login</span>
      <div class="hint">Use the email/password you created in Firebase Authentication.</div>
      <div class="row two" style="margin-top:10px">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@domain.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" />
        </div>
      </div>
      <div class="right">
        <button class="btn small" id="loginBtn">Sign in</button>
      </div>
      <div class="hint danger" id="loginErr" style="display:none"></div>
      <div class="hint">
        Tip: If login fails on GitHub Pages, add <span class="mono">benfordi25.github.io</span> to Firebase → Authentication → Settings → Authorized domains.
      </div>
    </div>

    <!-- APP -->
    <div class="layout" id="appLayout" style="display:none">
      <!-- LEFT: JOBS -->
      <div class="card">
        <span class="pill">Jobs</span>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Open active job</label>
            <select id="jobSelect"></select>
            <div class="hint">Active jobs are editable and autosave to the cloud.</div>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>New job: Property address</label>
            <input id="newAddress" placeholder="e.g., 10 Example Rd, Postcode" />
          </div>
          <div>
            <label>New job: Job label</label>
            <input id="newLabel" placeholder="e.g., Bathroom refurb" />
          </div>
        </div>

        <div class="right">
          <button class="btn small" id="createJobBtn">+ Create job</button>
          <button class="small" id="duplicateJobBtn">Duplicate</button>
          <button class="small" id="deleteJobBtn">Delete</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

        <span class="pill">Completed / Archived</span>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Open archived job</label>
            <select id="archivedSelect"></select>
            <div class="hint">Archived jobs are read-only. You can still create a PDF or restore them.</div>
          </div>
        </div>

        <div class="right">
          <button class="small" id="markCompleteBtn">Mark current as completed</button>
          <button class="small" id="restoreBtn">Restore selected archived</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

        <div class="hint"><b>Sync:</b> <span class="mono" id="syncState">idle</span></div>

        <div class="right">
          <button class="small" id="pdfBtn">Create PDF</button>
          <button class="small" id="exportBtn">Export JSON</button>
        </div>
      </div>

      <!-- RIGHT: MAIN -->
      <div id="mainPanel">
        <div class="readonlyTag" id="readonlyTag">
          This job is <b>Archived</b> and is <b>read-only</b>. Restore it to Active to edit.
        </div>

        <div class="grid">
          <!-- LEFT -->
          <div class="card">
            <div class="row two">
              <div>
                <label>Property address</label>
                <input id="propertyAddress" placeholder="e.g., Flat 2, 10 Example Rd, Postcode" />
              </div>
              <div>
                <label>Job label</label>
                <input id="jobLabel" placeholder="e.g., Kitchen refurb / leak repair" />
              </div>
            </div>

            <div class="row two">
              <div>
                <label>Estimated duration (days)</label>
                <input id="estDuration" type="text" inputmode="decimal" autocomplete="off" placeholder="e.g., 6" />
              </div>
              <div>
                <label>Currency</label>
                <select id="currency">
                  <option value="GBP">GBP (£)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="USD">USD ($)</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Notes (optional)</label>
                <input id="jobNotes" placeholder="Anything important for this job…" />
              </div>
            </div>

            <div style="margin-top:14px">
              <span class="pill">Labour</span>
              <div class="hint">
                Totals update when you leave a box (blur) or press Done/Enter. (Stops Android keypad closing.)
              </div>

              <table>
                <thead>
                  <tr>
                    <th style="width:16%">Person</th>
                    <th style="width:16%">Other name</th>
                    <th style="width:16%">Rate / day</th>
                    <th style="width:16%">Est days</th>
                    <th style="width:16%">Actual days</th>
                    <th style="width:20%">Total (used)</th>
                  </tr>
                </thead>
                <tbody id="labourBody"></tbody>
              </table>
            </div>

            <div style="margin-top:14px">
              <span class="pill">Materials</span>
              <div class="hint">Enter material costs as <b>NET only</b>. Estimated Materials Budget is for PDF/target only.</div>

              <div class="row two" style="margin-top:10px">
                <div>
                  <label>Estimated materials budget (NET)</label>
                  <input id="estMaterialsNet" type="text" inputmode="decimal" autocomplete="off" placeholder="e.g., 650" />
                </div>
                <div>
                  <label>Estimated materials notes (optional)</label>
                  <input id="estMaterialsNote" placeholder="e.g., based on supplier quote" />
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th style="width:20%">Date</th>
                    <th style="width:52%">Description</th>
                    <th style="width:20%">Net</th>
                    <th style="width:8%"></th>
                  </tr>
                </thead>
                <tbody id="matBody"></tbody>
              </table>

              <div class="right">
                <button class="btn small" id="addMatBtn">+ Add material</button>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="card">
            <span class="pill">Estimate & Commission</span>

            <div class="row two">
              <div>
                <label>Total estimate (NET)</label>
                <input id="estimateNet" type="text" inputmode="decimal" autocomplete="off" placeholder="e.g., 4250" />
              </div>
              <div>
                <label>Commission % (to client)</label>
                <input id="commissionPct" type="text" inputmode="decimal" autocomplete="off" placeholder="e.g., 12.5" />
              </div>
            </div>

            <div class="row two">
              <div>
                <label>Commission amount</label>
                <input id="commissionAmt" disabled />
              </div>
              <div>
                <label>Net left after commission</label>
                <input id="netAfterCommission" disabled />
              </div>
            </div>

            <div style="margin-top:14px">
              <span class="pill">Live totals</span>

              <div class="totals" style="margin-top:10px">
                <div class="kpi">
                  <div class="t">Labour total (used)</div>
                  <div class="v" id="kpiLabour">£0.00</div>
                </div>
                <div class="kpi">
                  <div class="t">Materials (net)</div>
                  <div class="v" id="kpiMaterials">£0.00</div>
                </div>
                <div class="kpi">
                  <div class="t">Spent so far</div>
                  <div class="v" id="kpiSpent">£0.00</div>
                </div>
                <div class="kpi">
                  <div class="t">Remaining / Profit-Loss (NET)</div>
                  <div class="v" id="kpiRemaining">£0.00</div>
                </div>
              </div>

              <div class="kpi" id="profitLossBox" style="margin-top:10px">
                <div class="t">Profit / Loss status</div>
                <div class="hint" id="profitLossHint"></div>
                <div class="hint" id="statusHint"></div>
              </div>

              <div class="right">
                <button class="small" id="resetBtn">Reset current job</button>
              </div>

              <div class="hint">
                Profit/Loss (NET) = <span class="mono">(Net after commission) − (Labour used + Materials net)</span>.
              </div>
            </div>
          </div>
        </div><!-- /grid -->
      </div><!-- /main -->
    </div><!-- /layout -->
  </div><!-- /wrap -->

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      collection, doc,
      addDoc, deleteDoc, setDoc,
      onSnapshot, query, orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfKXXlQyYJIGNjLOIVQqwtyL_QgDEG9Ps",
      authDomain: "ford-property-services-be377.firebaseapp.com",
      projectId: "ford-property-services-be377",
      storageBucket: "ford-property-services-be377.firebasestorage.app",
      messagingSenderId: "943925201384",
      appId: "1:943925201384:web:cc273115633c1337c93c5d"
    };

    const $ = (id) => document.getElementById(id);

    const num = (v) => {
      const s = String(v ?? "").replace(/,/g, "").trim();
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    };
    const todayISO = () => new Date().toISOString().slice(0,10);
    const safeName = (s) => (s || "").trim().slice(0, 80);

    function currencySymbol(cur){
      return cur === "GBP" ? "£" : cur === "EUR" ? "€" : "$";
    }
    function money(n, cur){
      const sym = currencySymbol(cur);
      const x = Number.isFinite(n) ? n : 0;
      return sym + x.toFixed(2);
    }

    function usedDays(row){
      const act = row?.actDays;
      const hasActual = act !== null && act !== undefined && String(act) !== "";
      return hasActual ? num(act) : num(row?.estDays);
    }

    const defaultJob = () => ({
      propertyAddress: "",
      jobLabel: "",
      estDuration: "",
      jobNotes: "",
      currency: "GBP",
      estimateNet: "",
      commissionPct: "",
      estMaterialsNet: "",
      estMaterialsNote: "",
      labour: [
        { person: "Ben", otherName: "", rate: "", estDays: "", actDays: "" },
        { person: "Joe", otherName: "", rate: "", estDays: "", actDays: "" },
        { person: "Brett", otherName: "", rate: "", estDays: "", actDays: "" },
        { person: "Other", otherName: "", rate: "", estDays: "", actDays: "" }
      ],
      materials: [
        { date: todayISO(), desc: "", net: "" }
      ],
      status: "active",
      completedAt: null,
      createdAt: null,
      updatedAt: null
    });

    let state = defaultJob();
    let uid = null;

    let jobsUnsub = null;
    let jobDocUnsub = null;

    let currentJobId = null;
    let savingTimer = null;
    let applyingRemote = false;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const jobsCol = (userId) => collection(db, "users", userId, "jobs");
    const jobDocRef = (userId, jobId) => doc(db, "users", userId, "jobs", jobId);

    function setSync(text) { $("syncState").textContent = text; }
    function isArchived(){ return (state.status || "active") === "archived"; }

    function calcLabourTotalUsed() {
      return (state.labour || []).reduce((sum, r) => sum + (num(r.rate) * usedDays(r)), 0);
    }
    function calcMaterialsTotalNet() {
      return (state.materials || []).reduce((sum, m) => sum + num(m.net), 0);
    }
    function calcCommission(estNet, pct){ return estNet * (pct/100); }

    function calcLabourEstimatedBudget(){
      return (state.labour || []).reduce((sum, r) => sum + (num(r.rate) * num(r.estDays)), 0);
    }

    function personDisplay(row){ return row.person === "Other" ? (row.otherName || "Other") : row.person; }

    function computeSummary(){
      const cur = state.currency;

      const labourUsed = calcLabourTotalUsed();
      const materialsNet = calcMaterialsTotalNet();
      const spent = labourUsed + materialsNet;

      const estNet = num(state.estimateNet);
      const commPct = num(state.commissionPct);
      const commAmt = calcCommission(estNet, commPct);
      const netAfterCommission = estNet - commAmt;

      const remaining = netAfterCommission - spent;

      return { cur, labourUsed, materialsNet, spent, estNet, commPct, commAmt, netAfterCommission, remaining };
    }

    function applyEditLock(){
      const ro = isArchived();
      $("mainPanel").classList.toggle("readonly", ro);

      const ids = [
        "propertyAddress","jobLabel","estDuration","jobNotes","currency",
        "estimateNet","commissionPct",
        "estMaterialsNet","estMaterialsNote"
      ];
      ids.forEach(id => { const el = $(id); if (el) el.disabled = ro; });

      $("addMatBtn").disabled = ro;
      $("resetBtn").disabled = ro;
      $("markCompleteBtn").disabled = ro || !currentJobId;

      $("pdfBtn").disabled = !currentJobId;
      $("exportBtn").disabled = !currentJobId;
      $("deleteJobBtn").disabled = !currentJobId;
      $("duplicateJobBtn").disabled = !currentJobId;
    }

    function renderTotals() {
      const s = computeSummary();

      $("commissionAmt").value = money(s.commAmt, s.cur);
      $("netAfterCommission").value = money(s.netAfterCommission, s.cur);

      $("kpiLabour").textContent = money(s.labourUsed, s.cur);
      $("kpiMaterials").textContent = money(s.materialsNet, s.cur);
      $("kpiSpent").textContent = money(s.spent, s.cur);
      $("kpiRemaining").textContent = money(s.remaining, s.cur);

      const plBox = $("profitLossBox");
      if (s.remaining >= 0) {
        plBox.classList.remove("lossBox"); plBox.classList.add("profitBox");
        $("profitLossHint").innerHTML = `<span class="ok">Profit (within budget after commission)</span>`;
      } else {
        plBox.classList.remove("profitBox"); plBox.classList.add("lossBox");
        $("profitLossHint").innerHTML = `<span class="danger">Loss (over budget after commission)</span>`;
      }

      const hint = $("statusHint");
      if (s.netAfterCommission <= 0 && (state.estimateNet !== "" || state.commissionPct !== "")) {
        hint.innerHTML = `<span class="danger">Net after commission is £0 or less — check estimate/commission.</span>`;
      } else if (s.remaining < 0) {
        hint.innerHTML = `<span class="danger">Over budget vs net after commission.</span>`;
      } else {
        hint.innerHTML = `<span class="ok">Within budget vs net after commission.</span>`;
      }
    }

    // ---- BLUR-ONLY: update totals only when leaving the field (or Done/Enter) ----
    function hookBlurOnly(el, applyStateFn, afterUpdateFn) {
      const ro = isArchived();
      if (ro) return;

      // Keep state updated while typing (NO totals update)
      el.addEventListener("input", () => {
        applyStateFn();
        queueSave(false); // save ok; does not touch totals or rerender
      });

      const commit = () => {
        applyStateFn();
        if (afterUpdateFn) afterUpdateFn();
        renderTotals();     // ✅ only here
        queueSave(false);
      };

      el.addEventListener("blur", commit);

      // Android "Done" / Enter key
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          el.blur(); // triggers commit
        }
      });
    }

    function renderLabour() {
      const body = $("labourBody");
      body.innerHTML = "";
      const ro = isArchived();

      (state.labour || []).forEach((row, idx) => {
        const tr = document.createElement("tr");

        const personTd = document.createElement("td");
        const sel = document.createElement("select");
        ["Ben","Joe","Brett","Other"].forEach(p => sel.appendChild(new Option(p, p)));
        sel.value = row.person;
        sel.disabled = ro;
        sel.onchange = () => {
          state.labour[idx].person = sel.value;
          if (sel.value !== "Other") state.labour[idx].otherName = "";
          queueSave(false);
          renderLabour(); // ok (dropdown change closes keypad anyway)
          renderTotals();
        };
        personTd.appendChild(sel);

        const otherTd = document.createElement("td");
        const other = document.createElement("input");
        other.type = "text";
        other.autocomplete = "off";
        other.placeholder = row.person === "Other" ? "Type name" : "—";
        other.value = row.otherName || "";
        other.disabled = ro || row.person !== "Other";
        other.oninput = () => { state.labour[idx].otherName = other.value; queueSave(false); };
        other.onblur = () => { renderTotals(); queueSave(false); };
        otherTd.appendChild(other);

        const rateTd = document.createElement("td");
        const rate = document.createElement("input");
        rate.type = "text";
        rate.inputMode = "decimal";
        rate.autocomplete = "off";
        rate.placeholder = "e.g., 180";
        rate.value = row.rate ?? "";
        rate.disabled = ro;
        rateTd.appendChild(rate);

        const estTd = document.createElement("td");
        const est = document.createElement("input");
        est.type = "text";
        est.inputMode = "decimal";
        est.autocomplete = "off";
        est.placeholder = "e.g., 2";
        est.value = row.estDays ?? "";
        est.disabled = ro;
        estTd.appendChild(est);

        const actTd = document.createElement("td");
        const act = document.createElement("input");
        act.type = "text";
        act.inputMode = "decimal";
        act.autocomplete = "off";
        act.placeholder = "blank = use est";
        act.value = row.actDays ?? "";
        act.disabled = ro;
        actTd.appendChild(act);

        const totalTd = document.createElement("td");
        const total = document.createElement("input");
        total.disabled = true;
        total.value = money(num(row.rate) * usedDays(row), state.currency);
        totalTd.appendChild(total);

        const applyState = () => {
          state.labour[idx].rate = rate.value;
          state.labour[idx].estDays = est.value;
          state.labour[idx].actDays = act.value;
        };
        const updateRowTotal = () => {
          const r = state.labour[idx];
          total.value = money(num(r.rate) * usedDays(r), state.currency);
        };

        hookBlurOnly(rate, applyState, updateRowTotal);
        hookBlurOnly(est, applyState, updateRowTotal);
        hookBlurOnly(act, applyState, updateRowTotal);

        [personTd, otherTd, rateTd, estTd, actTd, totalTd].forEach(td => tr.appendChild(td));
        body.appendChild(tr);
      });
    }

    function renderMaterials() {
      const body = $("matBody");
      body.innerHTML = "";
      const ro = isArchived();

      (state.materials || []).forEach((m, idx) => {
        const tr = document.createElement("tr");

        const dateTd = document.createElement("td");
        const date = document.createElement("input");
        date.type = "date";
        date.value = m.date || todayISO();
        date.disabled = ro;
        date.oninput = () => { state.materials[idx].date = date.value; queueSave(false); };
        date.onblur = () => { renderTotals(); queueSave(false); };
        dateTd.appendChild(date);

        const descTd = document.createElement("td");
        const desc = document.createElement("input");
        desc.type = "text";
        desc.autocomplete = "off";
        desc.placeholder = "e.g., plasterboard, fixings, paint…";
        desc.value = m.desc || "";
        desc.disabled = ro;
        desc.oninput = () => { state.materials[idx].desc = desc.value; queueSave(false); };
        descTd.appendChild(desc);

        const netTd = document.createElement("td");
        const net = document.createElement("input");
        net.type = "text";
        net.inputMode = "decimal";
        net.autocomplete = "off";
        net.placeholder = "e.g., 80.00";
        net.value = m.net || "";
        net.disabled = ro;
        netTd.appendChild(net);

        hookBlurOnly(net,
          () => { state.materials[idx].net = net.value; },
          null
        );

        const delTd = document.createElement("td");
        if (!ro) {
          const del = document.createElement("button");
          del.textContent = "✕";
          del.className = "small";
          del.onclick = () => {
            state.materials.splice(idx, 1);
            if (state.materials.length === 0) state.materials.push({ date: todayISO(), desc:"", net:"" });
            renderMaterials();
            renderTotals();
            queueSave(false);
          };
          delTd.appendChild(del);
        }

        [dateTd, descTd, netTd, delTd].forEach(td => tr.appendChild(td));
        body.appendChild(tr);
      });
    }

    function renderAll() {
      $("propertyAddress").value = state.propertyAddress || "";
      $("jobLabel").value = state.jobLabel || "";
      $("estDuration").value = state.estDuration || "";
      $("jobNotes").value = state.jobNotes || "";
      $("currency").value = state.currency || "GBP";
      $("estimateNet").value = state.estimateNet || "";
      $("commissionPct").value = state.commissionPct || "";
      $("estMaterialsNet").value = state.estMaterialsNet || "";
      $("estMaterialsNote").value = state.estMaterialsNote || "";

      renderLabour();
      renderMaterials();
      renderTotals();
      applyEditLock();
    }

    function queueSave(recalc = false) {
      if (!uid || !currentJobId || applyingRemote) return;
      if (isArchived()) return;
      setSync("pending");
      clearTimeout(savingTimer);
      savingTimer = setTimeout(saveToCloud, 350);
    }

    async function saveToCloud() {
      if (!uid || !currentJobId) return;
      if (isArchived()) return;
      try {
        setSync("saving…");
        await setDoc(jobDocRef(uid, currentJobId), { ...state, updatedAt: serverTimestamp() }, { merge: true });
        setSync("saved");
      } catch (e) {
        console.error(e);
        setSync("error");
      }
    }

    function subscribeToJob(jobId) {
      if (jobDocUnsub) jobDocUnsub();
      currentJobId = jobId;

      setSync("loading…");
      const ref = jobDocRef(uid, jobId);

      jobDocUnsub = onSnapshot(ref, (snap) => {
        applyingRemote = true;
        const data = snap.data();
        state = { ...defaultJob(), ...(data || {}) };

        if (Array.isArray(state.labour)) {
          state.labour = state.labour.map(r => {
            if (!r || typeof r !== "object") return { person:"Other", otherName:"", rate:"", estDays:"", actDays:"" };
            const est = (r.estDays ?? r.estimatedDays ?? r.days ?? "");
            const act = (r.actDays ?? r.actualDays ?? "");
            return {
              person: r.person ?? "Other",
              otherName: r.otherName ?? "",
              rate: r.rate ?? "",
              estDays: est,
              actDays: act
            };
          });
        } else {
          state.labour = defaultJob().labour;
        }

        if (Array.isArray(state.materials)) {
          state.materials = state.materials.map(m => {
            if (m && typeof m === "object") {
              if ((m.net == null || m.net === "") && m.gross != null && m.gross !== "") {
                return { date: m.date || todayISO(), desc: m.desc || "", net: m.gross };
              }
              return { date: m.date || todayISO(), desc: m.desc || "", net: m.net ?? "" };
            }
            return { date: todayISO(), desc: "", net: "" };
          });
          if (state.materials.length === 0) state.materials = [{ date: todayISO(), desc: "", net: "" }];
        } else {
          state.materials = [{ date: todayISO(), desc: "", net: "" }];
        }

        renderAll();
        setSync("synced");
        setTimeout(() => { applyingRemote = false; }, 60);
      }, (err) => {
        console.error(err);
        setSync("error");
      });
    }

    function subscribeToJobsList() {
      if (jobsUnsub) jobsUnsub();

      const q = query(jobsCol(uid), orderBy("updatedAt", "desc"));
      jobsUnsub = onSnapshot(q, (snap) => {
        const activeSelect = $("jobSelect");
        const archivedSelect = $("archivedSelect");

        const prevActive = activeSelect.value;

        const activeJobs = [];
        const archivedJobs = [];

        snap.forEach(docSnap => {
          const d = docSnap.data() || {};
          const status = d.status || "active";
          const job = {
            id: docSnap.id,
            label: safeName(d.jobLabel) || "Untitled job",
            address: safeName(d.propertyAddress) || "",
            status
          };
          (status === "archived" ? archivedJobs : activeJobs).push(job);
        });

        activeSelect.innerHTML = "";
        if (activeJobs.length === 0) {
          activeSelect.appendChild(new Option("No active jobs – create one", ""));
          activeSelect.disabled = true;
        } else {
          activeSelect.disabled = false;
          activeJobs.forEach(j => activeSelect.appendChild(new Option(j.address ? `${j.label} — ${j.address}` : j.label, j.id)));
        }

        archivedSelect.innerHTML = "";
        if (archivedJobs.length === 0) {
          archivedSelect.appendChild(new Option("No archived jobs", ""));
          archivedSelect.disabled = true;
        } else {
          archivedSelect.disabled = false;
          archivedJobs.forEach(j => archivedSelect.appendChild(new Option(j.address ? `${j.label} — ${j.address}` : j.label, j.id)));
        }

        const pickActive =
          (currentJobId && activeJobs.some(j => j.id === currentJobId)) ? currentJobId :
          (prevActive && activeJobs.some(j => j.id === prevActive)) ? prevActive :
          (activeJobs[0]?.id || "");

        if (pickActive) {
          activeSelect.value = pickActive;
          if (pickActive !== currentJobId) subscribeToJob(pickActive);
        } else if (archivedJobs.length) {
          const id = archivedJobs[0].id;
          archivedSelect.value = id;
          if (id !== currentJobId) subscribeToJob(id);
        } else {
          currentJobId = null;
          applyEditLock();
        }

        applyEditLock();
      });
    }

    async function createJobFromInputs() {
      const addr = safeName($("newAddress").value);
      const lbl = safeName($("newLabel").value);

      const job = defaultJob();
      job.propertyAddress = addr;
      job.jobLabel = lbl;
      job.status = "active";
      job.completedAt = null;
      job.createdAt = serverTimestamp();
      job.updatedAt = serverTimestamp();

      const ref = await addDoc(jobsCol(uid), job);
      $("newAddress").value = "";
      $("newLabel").value = "";
      subscribeToJob(ref.id);
    }

    async function duplicateCurrentJob() {
      if (!currentJobId) return;
      const copy = JSON.parse(JSON.stringify(state));
      copy.status = "active";
      copy.completedAt = null;
      copy.createdAt = serverTimestamp();
      copy.updatedAt = serverTimestamp();
      copy.jobLabel = safeName((copy.jobLabel || "Job") + " (copy)");

      const ref = await addDoc(jobsCol(uid), copy);
      subscribeToJob(ref.id);
    }

    async function deleteCurrentJob() {
      if (!currentJobId) return;
      const name = safeName(state.jobLabel) || "this job";
      if (!confirm(`Delete ${name}? This cannot be undone.`)) return;
      await deleteDoc(jobDocRef(uid, currentJobId));
      currentJobId = null;
      setSync("deleted");
    }

    async function markCurrentCompleted() {
      if (!uid || !currentJobId) return;
      if (isArchived()) return;

      const name = safeName(state.jobLabel) || "this job";
      if (!confirm(`Mark ${name} as completed? (Moves to Archived)`)) return;

      try {
        setSync("saving…");
        await setDoc(jobDocRef(uid, currentJobId), {
          status: "archived",
          completedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
        setSync("saved");
      } catch (e) {
        console.error(e);
        setSync("error");
        alert("Could not mark completed.");
      }
    }

    async function restoreArchivedSelected() {
      if (!uid) return;
      const id = $("archivedSelect").value;
      if (!id) return;

      try {
        setSync("saving…");
        await setDoc(jobDocRef(uid, id), {
          status: "active",
          completedAt: null,
          updatedAt: serverTimestamp()
        }, { merge: true });
        setSync("saved");
      } catch (e) {
        console.error(e);
        setSync("error");
        alert("Could not restore job.");
      }
    }

    // ---------------- CLEAN PDF (headings + tables; no buttons) ----------------
    function formatDateISO(d){ return d || ""; }

    async function createCleanPdf(){
      if (!currentJobId) return;

      const s = computeSummary();
      const cur = s.cur;
      const sym = currencySymbol(cur);

      const estMat = num(state.estMaterialsNet);
      const estMatNote = (state.estMaterialsNote || "").trim();
      const labourEstBudget = calcLabourEstimatedBudget();

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const marginX = 14;
      let y = 14;

      pdf.setFont("helvetica","bold");
      pdf.setFontSize(16);
      pdf.text("Ford Property Services – Job Costing Report", marginX, y);
      y += 7;

      pdf.setFont("helvetica","normal");
      pdf.setFontSize(10);
      pdf.text(`Generated: ${new Date().toLocaleString()}`, marginX, y);
      y += 6;

      const jobDetails = [
        ["Property address", state.propertyAddress || ""],
        ["Job label", state.jobLabel || ""],
        ["Estimated duration (days)", state.estDuration || ""],
        ["Currency", `${cur} (${sym})`],
        ["Status", (state.status || "active").toUpperCase()],
        ["Notes", state.jobNotes || ""],
        ["Estimated materials budget (NET)", estMat ? money(estMat, cur) : ""],
        ["Estimated materials note", estMatNote || ""],
      ];

      pdf.autoTable({
        startY: y,
        head: [["Job details", ""]],
        body: jobDetails,
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 2.5 },
        headStyles: { fillColor: [20, 28, 45] },
        columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 120 } },
      });

      y = pdf.lastAutoTable.finalY + 6;

      pdf.setFont("helvetica","bold");
      pdf.setFontSize(12);
      pdf.text("Labour", marginX, y);
      y += 2;

      const labourBody = (state.labour || []).map(r => {
        const used = usedDays(r);
        const usingActual = (r.actDays !== null && r.actDays !== undefined && String(r.actDays) !== "");
        return ([
          personDisplay(r),
          num(r.rate) ? money(num(r.rate), cur) : "",
          (r.estDays ?? "") !== "" ? String(num(r.estDays)) : "",
          (r.actDays ?? "") !== "" ? String(num(r.actDays)) : "",
          usingActual ? "Actual" : "Est",
          (num(r.rate) * used) ? money(num(r.rate) * used, cur) : ""
        ]);
      });

      pdf.autoTable({
        startY: y,
        head: [["Person", "Rate/day", "Est days", "Actual days", "Used", "Total (used)"]],
        body: labourBody.length ? labourBody : [["", "", "", "", "", ""]],
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 2.5 },
        headStyles: { fillColor: [20, 28, 45] },
        columnStyles: {
          0: { cellWidth: 42 },
          1: { cellWidth: 30, halign: "right" },
          2: { cellWidth: 20, halign: "right" },
          3: { cellWidth: 22, halign: "right" },
          4: { cellWidth: 20, halign: "center" },
          5: { cellWidth: 40, halign: "right" },
        },
      });

      y = pdf.lastAutoTable.finalY + 6;

      pdf.setFont("helvetica","bold");
      pdf.setFontSize(12);
      pdf.text("Materials (NET)", marginX, y);
      y += 2;

      const matBody = (state.materials || []).map(m => ([
        formatDateISO(m.date),
        m.desc || "",
        num(m.net) ? money(num(m.net), cur) : ""
      ]));

      pdf.autoTable({
        startY: y,
        head: [["Date", "Description", "Net"]],
        body: matBody.length ? matBody : [["", "", ""]],
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 2.5 },
        headStyles: { fillColor: [20, 28, 45] },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 110 },
          2: { cellWidth: 40, halign: "right" },
        },
      });

      y = pdf.lastAutoTable.finalY + 6;

      pdf.setFont("helvetica","bold");
      pdf.setFontSize(12);
      pdf.text("Financial summary (NET)", marginX, y);
      y += 2;

      const summaryBody = [
        ["Estimate (NET)", money(s.estNet, cur)],
        ["Commission %", `${s.commPct.toFixed(2)}%`],
        ["Commission amount", money(s.commAmt, cur)],
        ["Net after commission", money(s.netAfterCommission, cur)],
        ["Labour total (used)", money(s.labourUsed, cur)],
        ["Labour budget (est days x rate) – target only", money(labourEstBudget, cur)],
        ["Materials total (net)", money(s.materialsNet, cur)],
        ["Materials budget (estimated) – target only", estMat ? money(estMat, cur) : ""],
        ["Spent so far", money(s.spent, cur)],
        ["Profit / Loss (NET)", money(s.remaining, cur)],
      ];

      pdf.autoTable({
        startY: y,
        head: [["Item", "Amount"]],
        body: summaryBody,
        theme: "grid",
        styles: { fontSize: 10, cellPadding: 2.5 },
        headStyles: { fillColor: [20, 28, 45] },
        columnStyles: { 0: { cellWidth: 115 }, 1: { cellWidth: 65, halign: "right" } },
        didParseCell: function (data) {
          if (data.section === "body" && data.row.index === summaryBody.length - 1 && data.column.index === 1) {
            data.cell.styles.textColor = s.remaining >= 0 ? [0, 130, 0] : [170, 0, 0];
            data.cell.styles.fontStyle = "bold";
          }
        }
      });

      const namePart = (state.propertyAddress || state.jobLabel || "job")
        .replace(/[^a-z0-9]+/gi,"-").toLowerCase().slice(0, 50);

      pdf.save(`fps-job-costing-${namePart || "report"}.pdf`);
    }
    // -------------------------------------------------------------------------

    function wireInputs() {
      $("jobSelect").onchange = () => { const id = $("jobSelect").value; if (id) subscribeToJob(id); };
      $("archivedSelect").onchange = () => { const id = $("archivedSelect").value; if (id) subscribeToJob(id); };

      $("createJobBtn").onclick = async () => { try { await createJobFromInputs(); } catch(e){ console.error(e); alert("Could not create job."); } };
      $("duplicateJobBtn").onclick = async () => { try { await duplicateCurrentJob(); } catch(e){ console.error(e); alert("Could not duplicate job."); } };
      $("deleteJobBtn").onclick = async () => { try { await deleteCurrentJob(); } catch(e){ console.error(e); alert("Could not delete job."); } };
      $("markCompleteBtn").onclick = async () => { try { await markCurrentCompleted(); } catch(e){ console.error(e); alert("Could not mark completed."); } };
      $("restoreBtn").onclick = async () => { try { await restoreArchivedSelected(); } catch(e){ console.error(e); alert("Could not restore job."); } };

      $("propertyAddress").oninput = () => { state.propertyAddress = $("propertyAddress").value; queueSave(false); };
      $("jobLabel").oninput = () => { state.jobLabel = $("jobLabel").value; queueSave(false); };
      $("jobNotes").oninput = () => { state.jobNotes = $("jobNotes").value; queueSave(false); };

      $("currency").onchange = () => { state.currency = $("currency").value; queueSave(false); renderAll(); };

      // BLUR-only totals for these:
      const estDuration = $("estDuration");
      estDuration.addEventListener("input", () => { state.estDuration = estDuration.value; queueSave(false); });
      estDuration.addEventListener("blur", () => { renderTotals(); queueSave(false); });

      const estimateNet = $("estimateNet");
      estimateNet.addEventListener("input", () => { state.estimateNet = estimateNet.value; queueSave(false); });
      estimateNet.addEventListener("blur", () => { renderTotals(); queueSave(false); });
      estimateNet.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); estimateNet.blur(); } });

      const commissionPct = $("commissionPct");
      commissionPct.addEventListener("input", () => { state.commissionPct = commissionPct.value; queueSave(false); });
      commissionPct.addEventListener("blur", () => { renderTotals(); queueSave(false); });
      commissionPct.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); commissionPct.blur(); } });

      $("estMaterialsNet").oninput = () => { state.estMaterialsNet = $("estMaterialsNet").value; queueSave(false); };
      $("estMaterialsNote").oninput = () => { state.estMaterialsNote = $("estMaterialsNote").value; queueSave(false); };

      $("addMatBtn").onclick = () => {
        if (isArchived()) return;
        state.materials.push({ date: todayISO(), desc:"", net:"" });
        renderMaterials();
        queueSave(false);
      };

      $("resetBtn").onclick = async () => {
        if (isArchived()) return;
        if (!confirm("Reset this job? This will overwrite the saved job.")) return;
        const keepCreated = state.createdAt;
        state = defaultJob();
        state.createdAt = keepCreated || state.createdAt;
        renderAll();
        queueSave(false);
      };

      $("exportBtn").onclick = () => {
        const data = JSON.stringify({ jobId: currentJobId, ...state }, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `fps-job-${(state.jobLabel || "job").replace(/[^a-z0-9]+/gi,"-").toLowerCase()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      $("pdfBtn").onclick = async () => { try { await createCleanPdf(); } catch (e) { console.error(e); alert("PDF failed."); } };
      $("signOutBtn").onclick = async () => { await signOut(auth); };
    }

    async function createJobFromInputs() {
      const addr = safeName($("newAddress").value);
      const lbl = safeName($("newLabel").value);

      const job = defaultJob();
      job.propertyAddress = addr;
      job.jobLabel = lbl;
      job.status = "active";
      job.completedAt = null;
      job.createdAt = serverTimestamp();
      job.updatedAt = serverTimestamp();

      const ref = await addDoc(jobsCol(uid), job);
      $("newAddress").value = "";
      $("newLabel").value = "";
      subscribeToJob(ref.id);
    }

    $("loginBtn").onclick = async () => {
      $("loginErr").style.display = "none";
      const email = $("email").value.trim();
      const pass = $("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        $("loginErr").textContent = e?.message || "Login failed.";
        $("loginErr").style.display = "block";
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        uid = null;
        if (jobsUnsub) jobsUnsub(); jobsUnsub = null;
        if (jobDocUnsub) jobDocUnsub(); jobDocUnsub = null;
        currentJobId = null;

        $("userPill").textContent = "Not signed in";
        $("signOutBtn").disabled = true;

        $("loginCard").style.display = "block";
        $("appLayout").style.display = "none";
        return;
      }

      uid = user.uid;
      $("userPill").textContent = user.email || "Signed in";
      $("signOutBtn").disabled = false;

      $("loginCard").style.display = "none";
      $("appLayout").style.display = "grid";

      wireInputs();
      subscribeToJobsList();
    });
  </script>
</body>
</html>
