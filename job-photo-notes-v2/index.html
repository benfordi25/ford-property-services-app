<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ford Property Services ‚Ä¢ Photo Notes</title>
  <meta name="theme-color" content="#0b1220" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --text:#e7eefc; --muted:#a9b7d3;
      --line:rgba(255,255,255,.14); --shadow:0 10px 30px rgba(0,0,0,.35);
      --blue:#4aa3ff; --good:#22c55e; --bad:#ef4444;
      --r:18px; --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(74,163,255,.22), transparent 60%),
        radial-gradient(900px 650px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(11,18,32,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .top{justify-content:space-between}
    .title{font-weight:900}
    .back{color:#9ecbff;text-decoration:none;font-weight:900}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(16,26,51,.92), rgba(12,23,48,.92));
      box-shadow: var(--shadow);
      padding:14px;
    }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,textarea,select{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      font-size:15px;
    }
    textarea{min-height:92px;white-space:pre-wrap;resize:vertical}
    .grid{display:grid;gap:12px;margin-top:12px}
    @media(min-width:860px){.grid{grid-template-columns: 1.05fr .95fr}}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action: manipulation;
    }
    button.primary{border-color: rgba(74,163,255,.45); background: rgba(74,163,255,.14)}
    button.good{border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.12)}
    button.bad{border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.10)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .addrRow{display:flex;gap:10px;align-items:center}
    .addrRow input{flex:1;min-width:220px}
    .smallBtn{padding:10px 12px;border-radius:14px;white-space:nowrap}

    .list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: var(--r2);
      overflow:hidden;
    }

    .itemTop{display:flex;gap:10px;padding:12px;align-items:flex-start}
    .thumb{
      width:92px;height:92px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      object-fit:cover;
      flex:0 0 auto;
    }
    .meta{flex:1;min-width:0}
    .metaHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .metaLeft{min-width:0}
    .meta .t{margin:0;font-weight:900;font-size:14px}
    .meta .s{margin:4px 0 0;font-size:12px;color:var(--muted)}

    .dangerTop{
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      border-color: rgba(239,68,68,.55);
      background: rgba(239,68,68,.10);
      white-space:nowrap;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .itemBtns{display:flex;gap:8px;flex-wrap:wrap;padding:0 12px 12px}
    .small{padding:9px 12px;border-radius:12px;font-size:13px}
    .ghost{border-color: rgba(255,255,255,.12);background: rgba(255,255,255,.04)}

    /* ----- Full screen delete confirm ----- */
    .modal{
      position:fixed; inset:0; z-index:9999;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:16px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(720px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(16,26,51,.96), rgba(10,16,34,.96));
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetTop{
      display:flex; gap:12px; align-items:center;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .sheetTop img{
      width:64px;height:64px;border-radius:14px; object-fit:cover;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .sheetTop .h{margin:0;font-weight:900}
    .sheetTop .p{margin:6px 0 0; color:var(--muted); font-size:12px}
    .sheetBody{padding:14px}
    .holdArea{
      border:1px solid rgba(239,68,68,.55);
      background: rgba(239,68,68,.10);
      border-radius: 16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action:none;
    }
    .holdTitle{font-weight:900}
    .holdBarBig{
      width:100%; height:14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .holdFillBig{
      width:0%; height:100%;
      background: rgba(239,68,68,.78);
      border-radius:999px;
    }
    .sheetBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:14px;
      border-top:1px solid rgba(255,255,255,.10);
      justify-content:flex-end;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap row top">
    <div class="row" style="gap:12px">
      <div class="title">Ford Property Services ‚Ä¢ Photo Notes</div>
      <span class="pill" id="speechPill">Dictation: checking‚Ä¶</span>
    </div>
    <!-- ‚úÖ AMENDED: becomes "Back to Job" when opened from Jobs Board -->
    <a class="back" id="backLink" href="../dashboard/">‚Üê Dashboard</a>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <label>Property Address</label>
      <div class="addrRow">
        <input id="address" placeholder="e.g., 12 High Street, London" />
        <button id="btnGps" class="primary smallBtn" type="button">üìç Use GPS</button>
      </div>

      <div id="houseWrap" style="display:none; margin-top:8px;">
        <label style="margin:0 0 6px;">Select Address (if needed)</label>
        <select id="houseSelect"></select>
        <div class="hint" id="houseHint" style="margin-top:6px;"></div>
      </div>

      <div class="hint" id="gpsHint" style="margin-top:6px;"></div>

      <div class="row" style="gap:12px">
        <div style="flex:1;min-width:220px">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div style="flex:1;min-width:220px">
          <label>Operative (optional)</label>
          <input id="operative" placeholder="e.g., Ben Ford" />
        </div>
      </div>

      <div class="btnrow">
        <button id="btnCamera" class="primary" type="button">üì∑ Camera</button>
        <button id="btnGallery" class="primary" type="button">üñºÔ∏è Gallery</button>
        <button id="btnPdf" class="good" type="button">üßæ Generate PDF</button>
        <button id="btnShare" class="primary" type="button" disabled>üì§ Share PDF (WhatsApp)</button>
        <button id="btnDownload" class="primary" type="button" disabled>‚¨áÔ∏è Download PDF</button>

        <!-- ‚úÖ AMENDED: Save into Jobs Board Documents -->
        <button id="btnSaveToJob" class="good" type="button" disabled>üíæ Save to Job (Docs)</button>

        <button id="btnClear" class="bad" type="button">üóëÔ∏è Clear All</button>
      </div>

      <div class="hint" id="status">Ready.</div>
      <div class="hint" id="debug"></div>

      <input id="cameraInput" type="file" accept="image/*" capture="environment" multiple hidden>
      <input id="galleryInput" type="file" accept="image/*" multiple hidden>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Photos & Notes</strong>
        <span class="pill" id="countPill">0 photos</span>
      </div>
      <div class="list" id="list"></div>
    </section>
  </div>
</main>

<!-- Delete confirm modal -->
<div class="modal" id="delModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="sheetTop">
      <img id="delThumb" alt="Photo preview">
      <div style="min-width:0">
        <p class="h" id="delTitle" style="margin:0">Delete photo?</p>
        <p class="p" id="delSub" style="margin:6px 0 0"></p>
      </div>
    </div>

    <div class="sheetBody">
      <div class="holdArea" id="holdArea">
        <div class="holdTitle">üóëÔ∏è HOLD 2 SECONDS TO DELETE</div>
        <div class="hint" style="margin:0;color:#ffd1d1">Keep holding until the bar fills.</div>
        <div class="holdBarBig"><div class="holdFillBig" id="holdFillBig"></div></div>
      </div>
    </div>

    <div class="sheetBtns">
      <button type="button" class="primary" id="delCancel">Cancel</button>
    </div>
  </div>
</div>
<script type="module">
/* =========================================================
   Firebase (SAME PROJECT AS JOBS BOARD)
   ========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, doc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJPVdTvzHFRiyLTzR08hMTBp71gPEPLU8",
  authDomain: "fps-jobs-board.firebaseapp.com",
  projectId: "fps-jobs-board",
  storageBucket: "fps-jobs-board.firebasestorage.app",
  messagingSenderId: "386598717430",
  appId: "1:386598717430:web:06a2b508f1d7fcc92069d7"
};

const fbApp   = initializeApp(firebaseConfig);
const auth    = getAuth(fbApp);
const db      = getFirestore(fbApp);
const storage = getStorage(fbApp);
const JOBS_DOC = doc(db, "jobsBoard", "shared");

async function ensureSignedIn(){
  if(auth.currentUser) return auth.currentUser;
  const u = await new Promise(resolve=>{
    const unsub = onAuthStateChanged(auth, usr=>{ unsub(); resolve(usr); });
  });
  if(u) return u;
  await signInAnonymously(auth);
  return auth.currentUser;
}

/* =========================================================
   LINK CONTEXT FROM JOBS BOARD
   ========================================================= */
const params      = new URLSearchParams(location.search);
const linkedJobId = params.get("job") || "";
const backUrl     = params.get("back") || "../dashboard/";

const backLink = document.getElementById("backLink");
if(linkedJobId){
  backLink.textContent = "‚Üê Back to Job";
  backLink.href = backUrl;
}

/* =========================================================
   STATE / HELPERS
   ========================================================= */
const $ = (id) => document.getElementById(id);

const STORE = "fps_photo_notes_v2_store";
const VERSION_STAMP = "v2.4.0-job-linked-doc-save";

let state = {
  address:"",
  date:"",
  operative:"",
  photos:[],
  gps:null
};

let pdfBlob = null;
let pdfFile = null;
let pdfName = "";

function save(){
  localStorage.setItem(STORE, JSON.stringify(state));
}

function load(){
  const raw = localStorage.getItem(STORE);
  if(raw){
    try{ state = JSON.parse(raw); }catch{}
  }
  state.photos = (state.photos || []).map(p=>({
    id:p.id,
    img:p.img,
    subject:p.subject||"",
    note:p.note||"",
    ts:p.ts
  }));

  $("address").value   = state.address || "";
  $("operative").value = state.operative || "";
  $("date").value      = state.date || new Date().toISOString().slice(0,10);
}

/* =========================================================
   AUTO-POPULATE FROM JOB (BEST EFFORT)
   ========================================================= */
function applyLinkContext(){
  const addr  = params.get("address");
  const agent = params.get("agent");
  const ref   = params.get("ref");
  const estNo = params.get("estNo");

  if(addr && !$("address").value.trim()){
    $("address").value = addr;
    state.address = addr;
  }

  if(!$("operative").value.trim()){
    const bits = [];
    if(agent) bits.push(agent);
    if(ref)   bits.push(ref);
    if(estNo) bits.push(`Est ${estNo}`);
    if(bits.length){
      $("operative").value = bits.join(" ‚Ä¢ ");
      state.operative = $("operative").value;
    }
  }
  save();
}

/* =========================================================
   BASIC FORM BINDINGS
   ========================================================= */
$("address").addEventListener("input", e=>{
  state.address = e.target.value;
  save();
});

$("operative").addEventListener("input", e=>{
  state.operative = e.target.value;
  save();
});

$("date").addEventListener("change", e=>{
  state.date = e.target.value;
  save();
});
  /* =========================================================
   CACHE / SERVICE WORKER KILL (your existing)
   ========================================================= */
async function killServiceWorkersAndCachesOnce(){
  try{
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister().catch(()=>{});
    }
    if (window.caches) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
    }
  }catch(e){}
}

/* =========================================================
   GPS helpers (your existing)
   ========================================================= */
async function reverseGeocodeOSM(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=18&addressdetails=1`;
  const res = await fetch(url, { headers: { "Accept":"application/json", "Accept-Language":"en-GB" } });
  if(!res.ok) throw new Error("Reverse geocode failed");
  return await res.json();
}
function setGpsHint(msg){ $("gpsHint").textContent = msg || ""; }
function setHouseHint(msg){ $("houseHint").textContent = msg || ""; }
function pickTown(a){ return a.town || a.city || a.village || a.suburb || a.county || ""; }
function buildAddress(houseNumber, road, town, postcode){
  const line1 = [houseNumber, road].filter(Boolean).join(" ").trim();
  return [line1, town, postcode].filter(Boolean).join(", ").trim();
}
async function fetchNearbyFullAddresses({road, town, postcode, lat, lon}){
  const d = 0.01;
  const left = lon - d, right = lon + d, top = lat + d, bottom = lat - d;
  const params = new URLSearchParams({
    format: "jsonv2",
    addressdetails: "1",
    limit: "60",
    countrycodes: "gb",
    street: road || "",
    city: town || "",
    postalcode: postcode || "",
    viewbox: `${left},${top},${right},${bottom}`,
    bounded: "1"
  });
  const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;
  const res = await fetch(url, { headers: { "Accept":"application/json", "Accept-Language":"en-GB" } });
  if(!res.ok) throw new Error("Nearby address search failed");
  const results = await res.json();

  const seen = new Set();
  const list = [];
  for(const r of results){
    const a = r.address || {};
    const hn = (a.house_number || "").trim();
    const rRoad = (a.road || a.pedestrian || a.footway || "").trim();
    if(!hn) continue;
    if(road && rRoad && rRoad.toLowerCase() !== road.toLowerCase()) continue;

    const t = pickTown(a) || town || "";
    const pc = (a.postcode || "").trim() || postcode || "";
    const full = buildAddress(hn, rRoad || road, t, pc);
    if(!full) continue;

    const key = full.toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);

    list.push({ label: full, house: hn, road: rRoad || road, town: t, postcode: pc });
  }
  list.sort((A,B)=>{
    const na = parseInt(A.house,10), nb = parseInt(B.house,10);
    if(!isNaN(na) && !isNaN(nb) && na !== nb) return na - nb;
    return A.label.localeCompare(B.label, "en-GB", {numeric:true, sensitivity:"base"});
  });
  return list.slice(0, 40);
}
function showAddressPicker(addresses, preselectLabel){
  const wrap = $("houseWrap");
  const sel = $("houseSelect");
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Select the correct address‚Ä¶";
  sel.appendChild(opt0);
  addresses.forEach((a) => {
    const opt = document.createElement("option");
    opt.value = a.label;
    opt.textContent = a.label;
    sel.appendChild(opt);
  });
  wrap.style.display = addresses.length ? "block" : "none";
  if(preselectLabel){
    const found = addresses.find(x => x.label.toLowerCase() === preselectLabel.toLowerCase());
    if(found) sel.value = found.label;
  }
}

function setStatus(msg){ $("status").textContent = msg; }
function setDebug(msg){ $("debug").textContent = msg || ""; }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* =========================================================
   GPS button (your existing)
   ========================================================= */
$("btnGps").onclick = () => {
  if(!navigator.geolocation){ alert("GPS not supported on this device/browser."); return; }
  setGpsHint("Getting your location‚Ä¶");
  setHouseHint("");
  $("houseWrap").style.display = "none";
  $("btnGps").disabled = true;

  navigator.geolocation.getCurrentPosition(async (pos) => {
    try{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      setGpsHint("Finding road/postcode‚Ä¶");
      const data = await reverseGeocodeOSM(lat, lon);
      const a = data.address || {};

      const hn = (a.house_number || "").trim();
      const road = (a.road || a.pedestrian || a.footway || "").trim();
      const town = pickTown(a);
      const postcode = (a.postcode || "").trim();

      const base = buildAddress(hn, road, town, postcode) || (data.display_name || "");
      if(base){
        $("address").value = base;
        state.address = base;
        state.gps = { lat, lon, ts: new Date().toISOString(), road, town, postcode, house: hn || null };
        save();
      }

      if(!road){ setGpsHint("GPS found, but no road name returned. You can type the address manually."); return; }

      setGpsHint("Looking for nearby full addresses‚Ä¶");
      const addresses = await fetchNearbyFullAddresses({ road, town, postcode, lat, lon });

      if(addresses.length){
        showAddressPicker(addresses, base);
        setGpsHint(hn
          ? "GPS found an address. If it‚Äôs slightly off, pick the correct one below."
          : "GPS couldn‚Äôt find an exact house number ‚Äî pick the correct address below.");

        $("houseSelect").onchange = () => {
          const chosen = $("houseSelect").value;
          if(!chosen) return;

          $("address").value = chosen;
          state.address = chosen;

          const picked = addresses.find(x => x.label === chosen);
          state.gps = {
            ...(state.gps || {}),
            lat, lon,
            ts: new Date().toISOString(),
            road: picked?.road || road,
            town: picked?.town || town,
            postcode: picked?.postcode || postcode,
            house: picked?.house || hn || null
          };
          save();
          setHouseHint("Selected address applied.");
        };
      } else {
        setGpsHint(hn ? "GPS found an address." : "Couldn‚Äôt find nearby addresses for this road. Type the number manually if needed.");
      }

    }catch(err){
      console.warn(err);
      setGpsHint("Couldn‚Äôt get address list. Try again in a moment.");
      alert("Couldn‚Äôt convert GPS to nearby addresses (may be rate-limited). Try again shortly.");
    }finally{
      $("btnGps").disabled = false;
    }
  }, () => {
    $("btnGps").disabled = false;
    setGpsHint("GPS permission denied or unavailable.");
    alert("GPS not available. Please allow location permission and try again.");
  }, { enableHighAccuracy:true, timeout:12000, maximumAge:60000 });
};

/* =========================================================
   Dictation support (your existing)
   ========================================================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const dictationSupported = !!SpeechRecognition;
$("speechPill").textContent = dictationSupported ? "Dictation: supported" : "Dictation: not supported";

const BULLET = "‚Ä¢ ";
function ensureEndsWithNewline(text){
  if(!text) return "";
  return text.endsWith("\n") ? text : (text + "\n");
}
function prepareBulletPrefix(currentText){
  const t = (currentText || "");
  const trimmed = t.trimEnd();
  if(!trimmed) return BULLET;
  const lines = trimmed.split("\n");
  const last = lines[lines.length - 1].trim();
  if(last === "‚Ä¢" || last === BULLET.trim()) return "";
  return ensureEndsWithNewline(t) + BULLET;
}

/* =========================================================
   Delete modal hold-to-delete (your existing)
   ========================================================= */
let deleteTargetId = null;
let holdRAF = null;
let holdStart = 0;

function openDeleteModal(photo){
  deleteTargetId = photo.id;
  $("delThumb").src = photo.img;
  const subj = (photo.subject || "").trim();
  $("delSub").textContent = `Photo subject: ${subj ? subj : "‚Äî"}`;
  $("delModal").classList.add("show");
  $("holdFillBig").style.width = "0%";
  $("delModal").setAttribute("aria-hidden", "false");
}
function closeDeleteModal(){
  cancelHold();
  deleteTargetId = null;
  $("delModal").classList.remove("show");
  $("delModal").setAttribute("aria-hidden", "true");
  $("holdFillBig").style.width = "0%";
}
function cancelHold(){
  if(holdRAF){ cancelAnimationFrame(holdRAF); holdRAF = null; }
  $("holdFillBig").style.width = "0%";
}
function startHold(){
  if(!deleteTargetId) return;
  cancelHold();
  holdStart = Date.now();
  if(navigator.vibrate) navigator.vibrate(25);

  const tick = () => {
    const elapsed = Date.now() - holdStart;
    const pct = Math.min(100, (elapsed/2000)*100);
    $("holdFillBig").style.width = pct.toFixed(1) + "%";
    if(elapsed >= 2000){
      const id = deleteTargetId;
      closeDeleteModal();
      state.photos = state.photos.filter(p => p.id !== id);
      save();
      pdfBlob = pdfFile = null;
      $("btnShare").disabled = true;
      $("btnDownload").disabled = true;
      $("btnSaveToJob").disabled = true;
      setStatus("Photo deleted.");
      if(navigator.vibrate) navigator.vibrate(90);
      render();
      return;
    }
    holdRAF = requestAnimationFrame(tick);
  };
  holdRAF = requestAnimationFrame(tick);
}

$("delCancel").onclick = closeDeleteModal;
$("delModal").addEventListener("click", (e) => {
  if(e.target === $("delModal")) closeDeleteModal();
});

const holdArea = $("holdArea");
holdArea.addEventListener("touchstart", (e)=>{ e.preventDefault(); startHold(); }, {passive:false});
holdArea.addEventListener("touchend", (e)=>{ e.preventDefault(); cancelHold(); }, {passive:false});
holdArea.addEventListener("touchcancel", cancelHold);
holdArea.addEventListener("mousedown", (e)=>{ e.preventDefault(); startHold(); });
window.addEventListener("mouseup", cancelHold);
window.addEventListener("blur", cancelHold);

/* =========================================================
   Images import helpers (your existing)
   ========================================================= */
function looksLikeImage(file){
  const name = (file?.name || "").toLowerCase();
  const extOk = /\.(jpe?g|png|gif|webp|bmp|heic|heif)$/i.test(name);
  const typeOk = (file?.type || "").startsWith("image/");
  return typeOk || extOk;
}
function loadImageFromObjectURL(file){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("Image load failed")); };
    img.src = url;
  });
}
function compressToJpegDataURL(img, maxW=1600, maxH=1600, quality=0.85){
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  const scale = Math.min(1, maxW / w, maxH / h);
  const cw = Math.max(1, Math.round(w * scale));
  const ch = Math.max(1, Math.round(h * scale));
  const c = document.createElement("canvas");
  c.width = cw; c.height = ch;
  const ctx = c.getContext("2d", { alpha:false });
  ctx.drawImage(img, 0, 0, cw, ch);
  return c.toDataURL("image/jpeg", quality);
}

$("btnCamera").onclick = () => $("cameraInput").click();
$("btnGallery").onclick = () => $("galleryInput").click();

async function handleFiles(e){
  const files = Array.from(e.target.files || []);
  if (!files.length) return;

  setStatus(`Adding ${files.length} photo(s)‚Ä¶`);
  setDebug(`Picker returned ${files.length} file(s).`);

  let added = 0, skipped = 0;

  for (const f of files) {
    try{
      if (!f || !looksLikeImage(f)) { skipped++; continue; }
      const img = await loadImageFromObjectURL(f);
      const dataURL = compressToJpegDataURL(img, 1600, 1600, 0.85);
      if (!dataURL.startsWith("data:image/")) { skipped++; continue; }

      state.photos.push({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
        img: dataURL,
        subject: "",
        note: "",
        ts: new Date().toISOString()
      });
      added++;
    }catch(err){
      console.warn("Import fail:", err);
      skipped++;
    }
  }

  save();
  pdfBlob = pdfFile = null;
  $("btnShare").disabled = true;
  $("btnDownload").disabled = true;
  $("btnSaveToJob").disabled = true;
  render();

  if (added) setStatus(`Photos added: ${added}${skipped ? ` (skipped ${skipped})` : ""}.`);
  else setStatus("No photos added. (If your phone uses HEIC, switch Camera settings to JPEG.)");
  e.target.value = "";
}

$("cameraInput").addEventListener("change", handleFiles);
$("galleryInput").addEventListener("change", handleFiles);

/* =========================================================
   Render (your existing)
   ========================================================= */
function escapeHtml(str){
  return String(str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function escapeAttr(str){
  return escapeHtml(str).replace(/"/g, "&quot;");
}

function render(){
  $("countPill").textContent = `${state.photos.length} photo${state.photos.length===1?"":"s"}`;
  const list = $("list");
  list.innerHTML = "";

  if (!state.photos.length) {
    const div = document.createElement("div");
    div.className = "hint";
    div.textContent = "No photos yet. Tap ‚ÄúCamera‚Äù or ‚ÄúGallery‚Äù.";
    list.appendChild(div);
    return;
  }

  state.photos.forEach((p, idx) => {
    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="itemTop">
        <img class="thumb" src="${p.img}" alt="Photo ${idx+1}">
        <div class="meta">
          <div class="metaHead">
            <div class="metaLeft">
              <p class="t">Photo ${idx+1}${p.subject ? " ‚Ä¢ " + escapeHtml(p.subject) : ""}</p>
              <p class="s">Notes + subject</p>
            </div>
            <button class="dangerTop" type="button" data-delopen="${p.id}">üóëÔ∏è Delete</button>
          </div>

          <input data-subject="${p.id}" placeholder="Subject (e.g., Kitchen door, Bathroom basin)" value="${escapeAttr(p.subject || "")}">
          <div style="height:8px"></div>
          <textarea placeholder="Notes‚Ä¶">${p.note || ""}</textarea>
        </div>
      </div>

      <div class="itemBtns">
        <button class="small primary" type="button" ${dictationSupported ? "" : "disabled"} data-dict="${p.id}">üéôÔ∏è Dictate</button>
        <button class="small ghost" type="button" disabled data-stop="${p.id}">‚èπÔ∏è Stop</button>
        <button class="small" type="button" data-clearnote="${p.id}">üßΩ Clear Notes</button>
      </div>
    `;

    item.querySelector(`[data-delopen="${p.id}"]`).onclick = () => openDeleteModal(p);

    const subj = item.querySelector(`[data-subject="${p.id}"]`);
    subj.addEventListener("input", () => {
      p.subject = subj.value;
      save();
      pdfBlob = pdfFile = null;
      $("btnShare").disabled = true;
      $("btnDownload").disabled = true;
      $("btnSaveToJob").disabled = true;
      item.querySelector(".t").textContent = `Photo ${idx+1}${p.subject ? " ‚Ä¢ " + p.subject : ""}`;
    });

    const ta = item.querySelector("textarea");
    ta.addEventListener("input", () => {
      p.note = ta.value;
      save();
      pdfBlob = pdfFile = null;
      $("btnShare").disabled = true;
      $("btnDownload").disabled = true;
      $("btnSaveToJob").disabled = true;
    });

    item.querySelector(`[data-clearnote="${p.id}"]`).onclick = () => {
      if(!confirm("Clear notes for this photo only?")) return;
      p.note = "";
      ta.value = "";
      save();
      pdfBlob = pdfFile = null;
      $("btnShare").disabled = true;
      $("btnDownload").disabled = true;
      $("btnSaveToJob").disabled = true;
      setStatus("Notes cleared for that photo.");
    };

    const btnDict = item.querySelector(`[data-dict="${p.id}"]`);
    const btnStop = item.querySelector(`[data-stop="${p.id}"]`);
    if (dictationSupported) {
      btnDict.onclick = () => {
        const rec = new SpeechRecognition();
        rec.lang = "en-GB";
        rec.interimResults = true;
        rec.continuous = false;

        btnDict.disabled = true;
        btnStop.disabled = false;

        const prefix = prepareBulletPrefix(ta.value);
        if(prefix){
          ta.value = prefix;
          p.note = ta.value;
          save();
        }
        setStatus("Listening‚Ä¶ speak your bullet point.");

        let finalText = "";
        btnStop.onclick = () => { try{ rec.stop(); }catch{} };

        rec.onresult = (e) => {
          let interim = "";
          for (let i = e.resultIndex; i < e.results.length; i++){
            const t = e.results[i][0].transcript;
            if (e.results[i].isFinal) finalText += t;
            else interim += t;
          }
          const spoken = (finalText + interim).trim();
          if(!spoken) return;

          const current = ta.value || "";
          const lastBulletIdx = current.lastIndexOf(BULLET);
          if(lastBulletIdx !== -1){
            const before = current.slice(0, lastBulletIdx + BULLET.length);
            ta.value = before + spoken;
          }else{
            ta.value = (current.trim() ? (current.trimEnd() + "\n") : "") + BULLET + spoken;
          }
          p.note = ta.value;
          save();
        };

        rec.onerror = () => {
          setStatus("Dictation error. Try again.");
          btnDict.disabled = false;
          btnStop.disabled = true;
        };

        rec.onend = () => {
          setStatus("Ready.");
          btnDict.disabled = false;
          btnStop.disabled = true;
          ta.value = (ta.value || "").replace(/[ \t]+$/g, "");
          p.note = ta.value;
          save();
        };

        try { rec.start(); } catch {
          setStatus("Couldn‚Äôt start dictation. Try again.");
          btnDict.disabled = false;
          btnStop.disabled = true;
        }
      };
    }

    list.appendChild(item);
  });
      }
  /* =========================================================
   PDF helpers (your existing)
   ========================================================= */
function addPageNumbers(doc){
  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    const w = doc.internal.pageSize.getWidth();
    const h = doc.internal.pageSize.getHeight();
    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    doc.setTextColor(130);
    doc.text(`Page ${i} of ${pageCount}`, w - 12, h - 8, { align:"right" });
  }
}

function downloadLastPdf(){
  if(!pdfBlob){ alert("Generate the PDF first."); return; }
  const url = URL.createObjectURL(pdfBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = pdfName || "photo-notes.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
  setStatus("PDF downloaded.");
}

$("btnDownload").onclick = downloadLastPdf;

/* =========================================================
   CLEAN PROFESSIONAL PDF (NO TIMESTAMPS, KEEP PHOTO+NOTES TOGETHER)
   (your existing)
   ========================================================= */
function ukDateFromISO(iso){
  try{
    return new Date(iso).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"});
  }catch{
    return iso || "";
  }
}

async function dataURLToImage(dataURL){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = dataURL;
  });
}

function safeFilePart(s){
  return String(s||"")
    .replace(/[^\w\s-]/g,"")
    .trim()
    .replace(/\s+/g,"-")
    .slice(0,40) || "Report";
}

$("btnPdf").onclick = async () => {
  if (!state.address.trim()) { alert("Add the property address first."); return; }
  if (!state.photos.length) { alert("Add at least one photo first."); return; }

  setStatus("Generating PDF‚Ä¶");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 12;
  const contentW = pageW - margin*2;

  const border = 210;
  const dark = 20;
  const mid = 110;

  const dateUK = ukDateFromISO(state.date || todayISO());
  const gpsLine = (state.gps && typeof state.gps.lat==="number" && typeof state.gps.lon==="number")
    ? `${state.gps.lat.toFixed(6)}, ${state.gps.lon.toFixed(6)}`
    : "";

  function hr(y){
    doc.setDrawColor(border);
    doc.setLineWidth(0.3);
    doc.line(margin, y, pageW - margin, y);
  }
  function card(x, y, w, h){
    doc.setDrawColor(border);
    doc.setLineWidth(0.3);
    doc.roundedRect(x, y, w, h, 3, 3);
  }

  function ensureSpace(neededHeight, y){
    if (y + neededHeight > pageH - 12) {
      doc.addPage();
      return 18;
    }
    return y;
  }

  // Header
  doc.setTextColor(dark);
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("FORD PROPERTY SERVICES", margin, 18);

  doc.setFontSize(12);
  doc.setFont("helvetica","normal");
  doc.setTextColor(mid);
  doc.text("PHOTO NOTES REPORT", margin, 25);

  hr(30);

  // Info block
  let y = 36;
  const infoH = gpsLine ? 32 : 26;
  card(margin, y, contentW, infoH);

  doc.setTextColor(dark);
  doc.setFont("helvetica","bold");
  doc.setFontSize(10);

  doc.text("Property:", margin+4, y+7);
  doc.text("Date:", margin+4, y+14);
  doc.text("Operative:", margin+4, y+21);
  if (gpsLine) doc.text("GPS:", margin+4, y+28);

  doc.setFont("helvetica","normal");
  doc.setTextColor(dark);

  const addrLines = doc.splitTextToSize(state.address.trim(), contentW - 30);
  doc.text(addrLines, margin+26, y+7);

  doc.text(dateUK, margin+26, y+14);
  doc.text((state.operative || "").trim() || "‚Äî", margin+26, y+21);
  if (gpsLine) doc.text(gpsLine, margin+26, y+28);

  y += infoH + 10;

  // Photos: keep each block together
  for (let i=0; i<state.photos.length; i++){
    const p = state.photos[i];
    const subjectLine = (p.subject || "").trim();

    const note = (p.note || "").trim() || "‚Äî";
    const noteLines = doc.splitTextToSize(note, contentW - 8);
    const noteBoxH = Math.max(14, (noteLines.length * 5) + 8);

    // Determine image draw size
    const img = await dataURLToImage(p.img);
    const imgWpx = img.naturalWidth || img.width;
    const imgHpx = img.naturalHeight || img.height;

    const titleH = 10;
    const imgMaxH = 85;
    let drawW = contentW;
    let drawH = (imgHpx / imgWpx) * drawW;
    if (drawH > imgMaxH) { drawH = imgMaxH; drawW = (imgWpx / imgHpx) * drawH; }

    const imgCardH = drawH + 6;
    const notesH = 4 + noteBoxH + 6;
    const blockH = titleH + imgCardH + notesH + 8;

    y = ensureSpace(blockH, y);

    // Title
    doc.setFont("helvetica","bold");
    doc.setFontSize(11);
    doc.setTextColor(dark);
    doc.text(`Photo ${i+1}${subjectLine ? " ‚Äî " + subjectLine : ""}`, margin, y);
    y += 5;

    // Image card
    const xImg = margin + (contentW - drawW)/2;
    card(margin, y, contentW, imgCardH);
    doc.addImage(p.img, "JPEG", xImg, y+3, drawW, drawH);
    y += imgCardH + 6;

    // Notes label + box
    doc.setFont("helvetica","bold");
    doc.setFontSize(10);
    doc.setTextColor(dark);
    doc.text("Notes", margin, y);
    y += 4;

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.setTextColor(dark);

    card(margin, y, contentW, noteBoxH);
    doc.text(noteLines, margin+4, y+6);

    y += noteBoxH + 12;
  }

  addPageNumbers(doc);

  pdfBlob = doc.output("blob");
  const safeAddr = safeFilePart(state.address);
  const datePart = (state.date || todayISO());
  pdfName = `Photo-Notes-${safeAddr}-${datePart}.pdf`;
  pdfFile = new File([pdfBlob], pdfName, { type:"application/pdf" });

  $("btnShare").disabled = false;
  $("btnDownload").disabled = false;

  // ‚úÖ enable save-to-job only if linked to a job
  $("btnSaveToJob").disabled = !(linkedJobId && pdfBlob);

  setStatus(linkedJobId
    ? "PDF generated. Tap Share / Download, or Save to Job Documents."
    : "PDF generated. Tap Share or Download.");
};

/* =========================================================
   Share (your existing)
   ========================================================= */
$("btnShare").onclick = async () => {
  if (!pdfFile) { alert("Generate the PDF first."); return; }
  if (navigator.canShare && navigator.canShare({ files:[pdfFile] })) {
    try{
      await navigator.share({ title: "Photo Notes", text: "Photo notes report attached.", files:[pdfFile] });
      setStatus("Shared.");
      return;
    }catch(e){}
  }
  downloadLastPdf();
  alert("If Share isn‚Äôt supported on this device, the PDF downloads‚Äîattach it in WhatsApp.");
};

/* =========================================================
   ‚úÖ NEW: SAVE PDF INTO JOB BOARD DOCUMENTS
   - Uploads PDF to Firebase Storage
   - Appends into the matching job.docs in jobsBoard/shared
   ========================================================= */
function bytesToNice(n){
  const b = Number(n||0);
  if(!b) return "";
  const units = ["B","KB","MB","GB"];
  let v=b, i=0;
  while(v>=1024 && i<units.length-1){ v/=1024; i++; }
  return `${v.toFixed(i===0?0:1)} ${units[i]}`;
}

async function savePdfToJobDocs(){
  if(!linkedJobId){
    alert("This report is not linked to a job. Open Photo Notes from the Jobs Board Job Notes button.");
    return;
  }
  if(!pdfBlob){
    alert("Generate the PDF first.");
    return;
  }

  $("btnSaveToJob").disabled = true;
  setStatus("Saving PDF to Job Documents‚Ä¶");

  try{
    await ensureSignedIn();

    // Upload to Storage
    const ts = Date.now();
    const safeName = (pdfName || `Photo-Notes-${ts}.pdf`).replace(/[^\w.\-() ]+/g, "_");
    const docId = "doc_" + Math.random().toString(16).slice(2) + "_" + ts.toString(16);
    const path = `jobsBoard/shared/jobs/${linkedJobId}/${docId}_${safeName}`;

    const storageRef = sRef(storage, path);
    await uploadBytes(storageRef, pdfBlob, { contentType:"application/pdf" });
    const url = await getDownloadURL(storageRef);

    // Append to Firestore job.docs (transaction)
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(JOBS_DOC);
      if(!snap.exists()) throw new Error("Jobs doc not found");

      const data = snap.data() || {};
      const arr = Array.isArray(data.jobs) ? data.jobs.slice() : [];

      const idx = arr.findIndex(j => j && j.id === linkedJobId);
      if(idx < 0) throw new Error("Linked job not found in jobs list");

      const job = { ...(arr[idx] || {}) };
      job.docs = Array.isArray(job.docs) ? job.docs.slice() : [];

      job.docs.push({
        id: docId,
        name: safeName,
        mime: "application/pdf",
        size: pdfBlob.size || 0,
        url,
        storagePath: path,
        createdAtMs: ts
      });

      job.updatedAt = new Date().toISOString();
      arr[idx] = job;

      tx.set(JOBS_DOC, {
        jobs: arr,
        updatedAtMs: ts,
        updatedBy: auth.currentUser?.uid || null
      }, { merge:true });
    });

    setStatus(`Saved to Job Documents ‚úÖ (${bytesToNice(pdfBlob.size)})`);
    if(navigator.vibrate) navigator.vibrate(60);

  }catch(err){
    console.error(err);
    alert("Couldn‚Äôt save PDF into Job Documents. Check Storage/Firestore rules and try again.");
    setStatus("Save failed.");
  }finally{
    // re-enable if still linked and pdf exists
    $("btnSaveToJob").disabled = !(linkedJobId && pdfBlob);
  }
}

$("btnSaveToJob").onclick = savePdfToJobDocs;

/* =========================================================
   Clear all (your existing)
   ========================================================= */
$("btnClear").onclick = () => {
  if (!confirm("Clear ALL photos and notes for this report?")) return;
  state.photos = [];
  save();
  pdfBlob = pdfFile = null;
  $("btnShare").disabled = true;
  $("btnDownload").disabled = true;
  $("btnSaveToJob").disabled = true;
  setStatus("Cleared.");
  render();
};

/* =========================================================
   Boot
   ========================================================= */
(async () => {
  await killServiceWorkersAndCachesOnce();
  load();

  if (!$("date").value) $("date").value = todayISO();
  state.date = $("date").value || todayISO();

  applyLinkContext();
  render();

  // If job-linked, show hint
  if(linkedJobId){
    setStatus("Linked to job ‚Äî add photos, generate PDF, then Save to Job Documents.");
  }else{
    setStatus("Ready.");
  }
})();
</script>

</body>
</html>
