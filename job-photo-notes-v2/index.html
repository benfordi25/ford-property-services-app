<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ Photo Notes</title>
<meta name="theme-color" content="#0b1220">

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220; --text:#e7eefc; --muted:#a9b7d3;
  --line:rgba(255,255,255,.14); --good:#22c55e; --bad:#ef4444; --info:#7dd3fc;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 650px at 20% -10%, rgba(74,163,255,.18), transparent 60%),
    radial-gradient(1000px 650px at 100% 0%, rgba(34,197,94,.10), transparent 55%),
    var(--bg);
}
header{
  position:sticky;top:0;z-index:10;
  background: rgba(11,18,32,.86);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
main{max-width:1100px;margin:0 auto;padding:16px}
.card{
  background: linear-gradient(180deg, rgba(15,27,51,.92), rgba(12,23,48,.92));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: var(--shadow);
  padding:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
}
button.good{border-color:rgba(34,197,94,.55)}
button.bad{border-color:rgba(239,68,68,.55)}
button.rec{
  border-color:rgba(239,68,68,.85);
  box-shadow:0 0 0 2px rgba(239,68,68,.22) inset;
}
button:disabled{opacity:.6;cursor:not-allowed}

input,textarea{
  width:100%;
  background: rgba(0,0,0,.22);
  color:var(--text);
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:10px 12px;
}
textarea{min-height:90px;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
#speechStatus{font-size:12px;color:#b9d6ff;margin-top:8px}

.grid{display:grid;gap:12px;margin-top:12px;grid-template-columns:1fr}
@media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
.item{
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:12px;
  background: rgba(0,0,0,.14);
}
.thumb{
  aspect-ratio:4/3;
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  overflow:hidden;
  background:#000;
  margin-bottom:8px;
}
.thumb img{width:100%;height:100%;object-fit:contain}
.liveLine{font-size:12px;color:var(--info);min-height:16px;margin-top:6px}
a.back{color:#9ecbff;text-decoration:none;font-weight:900}

/* camera modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50;padding:14px}
.panel{background:#0b1220;border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:12px;width:min(960px,96%)}
.videoWrap{aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.14)}
video{width:100%;height:100%;object-fit:cover}
</style>
</head>

<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div style="font-weight:950">Ford Property Services ‚Ä¢ Photo Notes (V2)</div>
    <!-- If your dashboard is in /dashboard/ folder, change to ../dashboard/ -->
    <a class="back" href="../">‚Üê Dashboard</a>
  </div>
</header>

<input id="galleryInput" type="file" accept="image/*" multiple style="display:none">

<main>
  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
      <div>
        <div style="font-weight:950;font-size:16px">Photo Report</div>
        <div class="small">Dictate bullet notes per photo. Export clean PDF.</div>
      </div>
      <div class="row">
        <button id="newForm" class="bad" type="button">üÜï New form</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="address" placeholder="Property address">
      <input id="date" type="date" style="max-width:220px">
    </div>

    <div class="row" style="margin-top:10px">
      <button id="openCamera" class="good" type="button">üì∑ Open camera</button>
      <button id="chooseGallery" type="button">üñºÔ∏è Gallery</button>
      <button id="createPdf" class="good" type="button">üßæ Create PDF</button>
      <button id="sharePdf" type="button" disabled>üì§ Share PDF</button>
      <button id="downloadPdf" type="button" disabled>‚¨áÔ∏è Download PDF</button>
    </div>

    <div id="speechStatus"></div>

    <textarea id="general" placeholder="General notes (optional)" style="margin-top:12px"></textarea>

    <div id="list" class="grid"></div>

    <div class="small" style="margin-top:10px">
      Dictation: tap <strong>Dictate</strong>, speak normally. Pause ~2‚Äì3 seconds to finish and it will save a bullet.
    </div>
  </div>
</main>

<!-- Camera modal -->
<div id="camModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <strong>Camera</strong>
      <button id="closeCamTop" class="bad" type="button">‚úï Close</button>
    </div>
    <div class="videoWrap" style="margin-top:10px">
      <video id="video" autoplay playsinline muted></video>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="snap" class="good" type="button">üì∏ Take photo</button>
      <button id="closeCam" class="bad" type="button">‚úï Close</button>
    </div>
    <div class="small" style="margin-top:8px">Photos stay inside the app unless you export a PDF.</div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const STORE = "fps_job_photo_notes_v9_buffered_pdf";

/* =======================
   STATE
======================= */
let state = { address:"", date:"", general:"", items:[] };
let currentPdfBlob = null;
let currentPdfFilename = "";

/* =======================
   DATE + FILENAME
======================= */
function todayISO(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ukDateFromInput(value){
  if(!value) return "";
  const [y,m,d] = value.split("-").map(Number);
  if(!y||!m||!d) return "";
  return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
}
function ukDateForFilename(value){
  if(!value) return "";
  const [y,m,d] = value.split("-").map(Number);
  if(!y||!m||!d) return "";
  return `${String(d).padStart(2,"0")}-${String(m).padStart(2,"0")}-${y}`;
}
function cleanForFilename(s){
  return (s || "No-Address")
    .trim()
    .replace(/\s+/g," ")
    .replace(/[\/\\:*?"<>|]/g,"-")
    .slice(0, 60);
}

/* =======================
   SAVE/LOAD
======================= */
function invalidatePdf(){
  currentPdfBlob = null;
  currentPdfFilename = "";
  $("sharePdf").disabled = true;
  $("downloadPdf").disabled = true;
}
function saveState(){
  localStorage.setItem(STORE, JSON.stringify(state));
  invalidatePdf();
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORE);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
  $("address").value = state.address || "";
  $("general").value = state.general || "";
  if(state.date){
    $("date").value = state.date;
  }else{
    state.date = todayISO();
    $("date").value = state.date;
    saveState();
  }
  render();
}

$("address").addEventListener("input", e=>{ state.address = e.target.value; saveState(); });
$("date").addEventListener("change", e=>{ state.date = e.target.value; saveState(); });
$("general").addEventListener("input", e=>{ state.general = e.target.value; saveState(); });

/* =======================
   CAMERA
======================= */
let stream = null;
function openCam(){
  $("camModal").style.display="flex";
  $("camModal").setAttribute("aria-hidden","false");
}
function closeCam(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  $("camModal").style.display="none";
  $("camModal").setAttribute("aria-hidden","true");
}
$("openCamera").addEventListener("click", async ()=>{
  openCam();
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" }, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    $("video").srcObject = stream;
    await $("video").play();
  }catch(err){
    alert("Camera failed to start. Please allow camera permission.\n\n" + err);
    closeCam();
  }
});
$("closeCam").addEventListener("click", closeCam);
$("closeCamTop").addEventListener("click", closeCam);

$("snap").addEventListener("click", ()=>{
  const v = $("video");
  if(!v.videoWidth) return;

  const c = document.createElement("canvas");
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);

  state.items.push({ img: c.toDataURL("image/jpeg",0.94), note:"", lastFinal:"" });
  saveState();
  render();
});

/* =======================
   GALLERY
======================= */
$("chooseGallery").addEventListener("click", ()=> $("galleryInput").click());
$("galleryInput").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  for(const f of files){
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await img.decode();

    const max = 2200;
    const scale = Math.min(1, max / Math.max(img.width, img.height));
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    c.getContext("2d").drawImage(img,0,0,w,h);
    URL.revokeObjectURL(img.src);

    state.items.push({ img: c.toDataURL("image/jpeg",0.95), note:"", lastFinal:"" });
  }

  e.target.value="";
  saveState();
  render();
});

/* =======================
   DICTATION (BUFFERED + MORE RELIABLE)
======================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

let rec = null;
let activeItem=null, activeTa=null, activeBtn=null, activeLive=null;
let wantRecording=false;

let finalBuffer = "";
let interimBuffer = "";
let silenceTimer = null;

function setSpeechStatus(msg){ $("speechStatus").textContent = msg || ""; }
function setLive(msg){ if(activeLive) activeLive.textContent = msg || ""; }

function setBtnRecording(on){
  if(!activeBtn) return;
  if(on){
    activeBtn.textContent="‚èπ Stop";
    activeBtn.classList.add("rec");
  }else{
    activeBtn.textContent="üé§ Dictate";
    activeBtn.classList.remove("rec");
  }
}

function normalise(t){
  return (t||"").toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim();
}
function collapseRepeatedWords(text){
  const words = (text||"").trim().split(/\s+/);
  const out=[];
  for(const w of words){
    if(out.length && out[out.length-1].toLowerCase() === w.toLowerCase()) continue;
    out.push(w);
  }
  return out.join(" ");
}
function overlapDelta(prev, next){
  const a = normalise(prev);
  const b = normalise(next);
  if(!a) return next;

  if(b.startsWith(a)){
    const extra = next.slice(prev.length).trim();
    return extra;
  }

  const lastLine = (activeItem?.note || "").trim().split("\n").slice(-1)[0] || "";
  const lastNorm = normalise(lastLine.replace(/^‚Ä¢\s*/,""));
  const nextNorm = normalise(next);
  if(lastNorm && nextNorm){
    const closeLen = Math.abs(lastNorm.length - nextNorm.length) <= 10;
    if(closeLen && (lastNorm.includes(nextNorm) || nextNorm.includes(lastNorm))) return "";
  }

  return next;
}

function appendBullet(item, rawText){
  let t=(rawText||"").trim();
  if(!t) return;

  t = collapseRepeatedWords(t).trim();
  if(!t) return;

  const delta = overlapDelta(item.lastFinal || "", t).trim();
  if(!delta) return;

  const bullet = "‚Ä¢ " + delta;
  const cur = item.note || "";
  item.note = cur.trim() ? (cur.replace(/\s+$/,"") + "\n" + bullet) : bullet;
  item.lastFinal = t;

  if(activeTa) activeTa.value = item.note;
  saveState();
}

async function warmUpMic(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    return true;
  }catch(e){
    setSpeechStatus("Mic blocked. Chrome: ‚ãÆ ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.");
    return false;
  }
}

function clearSilence(){
  if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; }
}
function armAutoStop(){
  clearSilence();
  silenceTimer = setTimeout(()=>{
    if(rec && wantRecording){
      try{ rec.stop(); }catch(e){}
    }
  }, 2500);
}

function combinedBuffer(){
  return (finalBuffer + " " + interimBuffer).replace(/\s+/g," ").trim();
}

async function startRec(){
  rec = new SR();
  rec.lang = "en-GB";
  rec.interimResults = true;
  rec.continuous = true;
  rec.maxAlternatives = 1;

  finalBuffer = "";
  interimBuffer = "";

  rec.onstart = ()=>{
    setSpeechStatus("Recording‚Ä¶ speak normally.");
    setLive("Listening‚Ä¶");
    armAutoStop();
  };

  rec.onspeechstart = ()=>{
    setLive("Hearing you‚Ä¶");
    clearSilence();
  };

  rec.onresult = (ev)=>{
    armAutoStop();
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      const res = ev.results[i];
      const txt = (res?.[0]?.transcript || "").trim();
      if(!txt) continue;

      if(res.isFinal){
        const normSeg = normalise(txt);
        const normAll = normalise(finalBuffer);
        if(!normAll.endsWith(normSeg)){
          finalBuffer = (finalBuffer + " " + txt).trim();
        }
        interimBuffer = "";
        setLive("");
        setSpeechStatus("Recording‚Ä¶ (pause to finish)");
      }else{
        interimBuffer = txt;
        setLive("‚Ä¶ " + txt);
      }
    }
  };

  rec.onerror = (ev)=>{
    const err = ev?.error || "unknown";
    if(err === "not-allowed" || err === "service-not-allowed"){
      wantRecording=false;
      setBtnRecording(false);
      setLive("");
      setSpeechStatus("Mic blocked. Chrome: ‚ãÆ ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.");
    }else if(err === "no-speech"){
      setSpeechStatus("No speech detected. Try again.");
    }else{
      setSpeechStatus("Dictation error: " + err);
    }
  };

  rec.onend = ()=>{
    clearSilence();

    const all = combinedBuffer();
    if(wantRecording && activeItem && all){
      appendBullet(activeItem, all);
    }

    rec = null;
    wantRecording = false;

    setBtnRecording(false);
    setLive("");
    setSpeechStatus("Stopped.");
    setTimeout(()=>setSpeechStatus(""), 900);

    activeItem=null; activeTa=null; activeBtn=null; activeLive=null;
    finalBuffer=""; interimBuffer="";
  };

  try{
    rec.start();
  }catch(e){
    wantRecording=false;
    setBtnRecording(false);
    setLive("");
    setSpeechStatus("Could not start dictation. Use Chrome and allow microphone.");
  }
}

async function toggleDictation(item, textarea, btn, live){
  if(rec && wantRecording){
    wantRecording=false;
    try{ rec.stop(); }catch(e){}
    return;
  }

  if(!SR){
    alert("Dictation not supported. Use Chrome on Android.");
    return;
  }

  activeItem=item; activeTa=textarea; activeBtn=btn; activeLive=live;

  setBtnRecording(true);
  setSpeechStatus("Requesting microphone‚Ä¶");
  setLive("Listening‚Ä¶");

  const ok = await warmUpMic();
  if(!ok){
    setBtnRecording(false);
    setLive("");
    return;
  }

  wantRecording=true;
  await startRec();
}

/* =======================
   RENDER
======================= */
function render(){
  const list = $("list");
  list.innerHTML = "";

  state.items.forEach((it, idx)=>{
    if(typeof it.lastFinal !== "string") it.lastFinal = "";

    const box = document.createElement("div");
    box.className="item";
    box.innerHTML = `
      <div class="thumb"><img src="${it.img}" alt="Photo ${idx+1}"></div>
      <div class="small" style="margin-bottom:6px"><strong>Photo ${idx+1}</strong></div>
      <textarea placeholder="Notes for this photo..."></textarea>
      <div class="liveLine"></div>
      <div class="row" style="margin-top:6px">
        <button type="button" class="good">üé§ Dictate</button>
        <button type="button">‚Ü© Undo last bullet</button>
        <button type="button">‚å´ Clear</button>
        <button type="button" class="bad">üóëÔ∏è Delete</button>
      </div>
    `;

    const ta = box.querySelector("textarea");
    const live = box.querySelector(".liveLine");
    ta.value = it.note || "";
    ta.addEventListener("input", e=>{ it.note = e.target.value; saveState(); });

    const btns = box.querySelectorAll("button");
    const bDict = btns[0], bUndo = btns[1], bClear = btns[2], bDel = btns[3];

    bDict.addEventListener("click", ()=> toggleDictation(it, ta, bDict, live));

    bUndo.addEventListener("click", ()=>{
      const lines = (it.note || "").split("\n");
      lines.pop();
      it.note = lines.join("\n");
      ta.value = it.note;
      it.lastFinal = "";
      saveState();
    });

    bClear.addEventListener("click", ()=>{
      it.note = "";
      ta.value = "";
      it.lastFinal = "";
      saveState();
    });

    bDel.addEventListener("click", ()=>{
      if(!confirm("Delete this photo?")) return;
      if(rec && activeItem === it){ wantRecording=false; try{ rec.stop(); }catch(e){} }
      state.items.splice(idx,1);
      saveState();
      render();
    });

    list.appendChild(box);
  });
}

/* =======================
   NEW FORM
======================= */
$("newForm").addEventListener("click", ()=>{
  if(!confirm("Start a NEW form? This clears address/date/notes/photos on this device.")) return;

  if(rec){ wantRecording=false; try{ rec.stop(); }catch(e){} }

  state = { address:"", date: todayISO(), general:"", items:[] };
  localStorage.removeItem(STORE);

  $("address").value="";
  $("general").value="";
  $("date").value=state.date;

  saveState();
  render();
});

/* =======================
   PDF (NO OVERLAP)
======================= */
function validateForPdf(){
  if(!state.address || !state.address.trim()){ alert("Enter the Property address first."); return false; }
  if(!state.date){ alert("Select the date first."); return false; }
  if(!state.items.length){ alert("Add at least 1 photo first."); return false; }
  return true;
}
async function dataUrlToDims(dataUrl){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>resolve({w:img.width,h:img.height});
    img.onerror=reject;
    img.src=dataUrl;
  });
}
function makeFilename(){
  const safeAddr = cleanForFilename(state.address);
  const dateFile = ukDateForFilename(state.date) || "No-Date";
  return `Photo-Notes_${safeAddr}_${dateFile}.pdf`;
}
function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
}
async function shareBlob(blob, filename){
  if(!navigator.canShare || !navigator.share){ downloadBlob(blob, filename); return; }
  const file = new File([blob], filename, { type:"application/pdf" });
  try{
    if(navigator.canShare({ files:[file] })) await navigator.share({ files:[file], title: filename });
    else downloadBlob(blob, filename);
  }catch(e){ downloadBlob(blob, filename); }
}

async function buildPdfBlob(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"mm", format:"a4" });

  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 12;
  const maxW = pageW - margin*2;
  const lineH = 5.2;
  let y = margin;

  function ensureSpace(h){
    if(y + h > pageH - margin){
      doc.addPage();
      y = margin;
    }
  }

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Ford Property Services", margin, y); y += 7;

  doc.setFontSize(12);
  doc.text("Photo Notes", margin, y); y += 9;

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);

  const addrLines = doc.splitTextToSize("Address: " + (state.address || ""), maxW);
  ensureSpace(addrLines.length*lineH + 2);
  doc.text(addrLines, margin, y); y += addrLines.length*lineH + 4;

  const dateLine = "Date: " + (ukDateFromInput(state.date) || "");
  ensureSpace(lineH + 4);
  doc.text(dateLine, margin, y); y += lineH + 6;

  if(state.general && state.general.trim()){
    doc.setFont("helvetica","bold");
    ensureSpace(lineH+2);
    doc.text("General notes:", margin, y); y += lineH + 2;

    doc.setFont("helvetica","normal");
    const gLines = doc.splitTextToSize(state.general.trim(), maxW);
    ensureSpace(gLines.length*lineH + 10);
    doc.text(gLines, margin, y); y += gLines.length*lineH + 10;
  }

  for(let i=0;i<state.items.length;i++){
    const it = state.items[i];

    doc.setFont("helvetica","bold");
    ensureSpace(lineH+2);
    doc.text(`Photo ${i+1}`, margin, y); y += lineH + 2;

    const dims = await dataUrlToDims(it.img);
    const imgMaxH = 95;
    const ratio = Math.min(maxW/dims.w, imgMaxH/dims.h);
    const w = dims.w * ratio;
    const h = dims.h * ratio;

    ensureSpace(h + 6);
    doc.addImage(it.img, "JPEG", margin, y, w, h);
    y += h + 6;

    doc.setFont("helvetica","normal");
    const note = (it.note && it.note.trim()) ? it.note.trim() : "‚Äî";
    const noteLines = doc.splitTextToSize(note, maxW);

    ensureSpace(noteLines.length*lineH + 10);
    doc.text(noteLines, margin, y);
    y += noteLines.length*lineH + 10;

    if(i < state.items.length-1 && y > pageH - margin - 45){
      doc.addPage();
      y = margin;
    }
  }

  return doc.output("blob");
}

$("createPdf").addEventListener("click", async ()=>{
  if(!validateForPdf()) return;

  try{
    $("createPdf").disabled = true;

    const blob = await buildPdfBlob();
    const filename = makeFilename();

    currentPdfBlob = blob;
    currentPdfFilename = filename;

    $("sharePdf").disabled = false;
    $("downloadPdf").disabled = false;

    alert("PDF created ‚úÖ\n\nUse Share or Download.");
  }catch(err){
    alert("PDF creation failed:\n\n" + err);
  }finally{
    $("createPdf").disabled = false;
  }
});

$("sharePdf").addEventListener("click", async ()=>{
  if(!currentPdfBlob){ alert("Tap Create PDF first."); return; }
  await shareBlob(currentPdfBlob, currentPdfFilename);
});

$("downloadPdf").addEventListener("click", ()=>{
  if(!currentPdfBlob){ alert("Tap Create PDF first."); return; }
  downloadBlob(currentPdfBlob, currentPdfFilename);
});

/* =======================
   START
======================= */
loadState();
render();
</script>
</body>
</html>
