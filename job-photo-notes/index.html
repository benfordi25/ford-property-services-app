<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ Photo Notes</title>
<meta name="theme-color" content="#0b1220">

<!-- jsPDF (creates real PDFs with file names) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220; --line:rgba(255,255,255,.14);
  --text:#e7eefc; --muted:#a9b7d3;
  --good:#22c55e; --bad:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
header{position:sticky;top:0;z-index:10;background:#0b1220;border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:54px;height:54px;border-radius:14px;background:#fff;color:#000;display:grid;place-items:center;font-weight:900}
main{max-width:1100px;margin:0 auto;padding:16px}
.card{border:1px solid var(--line);border-radius:18px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{
  background:rgba(255,255,255,.06);color:var(--text);
  border:1px solid var(--line);border-radius:14px;
  padding:10px 12px;font-weight:900;cursor:pointer
}
button.good{border-color:rgba(34,197,94,.55)}
button.bad{border-color:rgba(239,68,68,.55)}
button.rec{
  border-color:rgba(239,68,68,.75);
  box-shadow: 0 0 0 2px rgba(239,68,68,.15) inset;
}
button:disabled{opacity:.55; cursor:not-allowed}
input,textarea{
  width:100%;background:rgba(0,0,0,.2);color:var(--text);
  border:1px solid var(--line);border-radius:14px;padding:10px 12px
}
textarea{min-height:90px;white-space:pre-wrap}
.grid{display:grid;gap:12px;margin-top:12px}
@media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
.item{border:1px solid var(--line);border-radius:18px;padding:12px}
.thumb{aspect-ratio:4/3;border:1px solid var(--line);border-radius:14px;overflow:hidden;margin-bottom:8px;background:#000}
.thumb img{width:100%;height:100%;object-fit:contain}
.small{font-size:12px;color:var(--muted)}
.toast{
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  background:#000;color:#fff;padding:10px 14px;border-radius:14px;display:none;font-weight:900;z-index:100
}

/* CAMERA MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50;padding:14px}
.panel{background:#0b1220;border:1px solid var(--line);border-radius:18px;padding:12px;width:min(960px,96%)}
.videoWrap{aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;border:1px solid var(--line)}
video{width:100%;height:100%;object-fit:cover}

/* Files modal */
.filesModal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:60;padding:14px}
.filesPanel{background:#0b1220;border:1px solid var(--line);border-radius:18px;padding:12px;width:min(980px,96%);max-height:90vh;overflow:auto}
.fileRow{
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  margin-top:10px;
  display:flex;
  gap:10px;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
}
.fileActions{display:flex;gap:8px;flex-wrap:wrap}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px; color:var(--muted)}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
</style>
</head>

<body>

<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo">FPS</div>
      <div>
        <strong>Ford Property Services</strong><br>
        <span class="small">Photo Notes</span>
      </div>
    </div>
    <a href="/app/dashboard/" style="color:#9ecbff;text-decoration:none">‚Üê Dashboard</a>
  </div>
</header>

<input id="galleryInput" type="file" accept="image/*" multiple style="display:none">

<main>
  <div class="card">

    <div style="margin-bottom:10px">
      <div style="font-weight:900;font-size:16px">Photo Report</div>
      <div style="margin-top:6px"><strong>Property Address:</strong> <span id="pdfAddress">‚Äî</span></div>
      <div class="small">Date: <span id="pdfDate">‚Äî</span></div>
    </div>

    <div class="row">
      <button id="newForm" class="bad" type="button">üÜï New form</button>
      <button id="openCamera" class="good" type="button">üì∑ Open camera</button>
      <button id="chooseGallery" type="button">üñºÔ∏è Gallery</button>
      <button id="createPdf" class="good" type="button">üßæ Create PDF</button>
      <button id="sharePdf" type="button" disabled>üì§ Share PDF</button>
      <button id="downloadPdf" type="button" disabled>‚¨áÔ∏è Download PDF</button>
      <button id="openFiles" type="button">üìÅ Downloaded files</button>
    </div>

    <div class="small" style="margin-top:6px">
      1) Create PDF ‚Üí 2) Share PDF (WhatsApp/Email) or Download PDF.
    </div>

    <div id="speechStatus" class="small" style="margin-top:8px"></div>

    <div class="row" style="margin-top:12px">
      <input id="address" placeholder="Property address">
      <input id="date" type="date">
    </div>

    <textarea id="general" placeholder="General notes (optional)" style="margin-top:12px"></textarea>

    <div id="list" class="grid"></div>

    <hr>

    <div class="small">
      ‚ÄúDownloaded files‚Äù shows PDFs created by this app (saved in-app). Browsers can‚Äôt list your whole phone Downloads folder.
    </div>

  </div>
</main>

<!-- Camera modal -->
<div id="camModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <strong>Camera</strong>
      <button id="closeCamTop" class="bad" type="button">‚úï Close</button>
    </div>
    <div class="videoWrap" style="margin-top:10px">
      <video id="video" autoplay playsinline muted></video>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="snap" class="good" type="button">üì∏ Take photo</button>
      <button id="closeCam" class="bad" type="button">‚úï Close</button>
    </div>
    <div class="small" style="margin-top:8px">If prompted, tap <strong>Allow</strong> to give camera & microphone access.</div>
  </div>
</div>

<!-- Files modal -->
<div id="filesModal" class="filesModal" aria-hidden="true">
  <div class="filesPanel">
    <div class="row" style="justify-content:space-between">
      <div>
        <strong>Downloaded files</strong><br>
        <span class="small">Your saved PDFs (address + date filename)</span>
      </div>
      <div class="row">
        <button id="refreshFiles" type="button">‚Üª Refresh</button>
        <button id="closeFiles" class="bad" type="button">‚úï Close</button>
      </div>
    </div>

    <div id="filesList" style="margin-top:10px"></div>

    <div class="small" style="margin-top:10px">
      Tip: If you need more storage, delete old PDFs here.
    </div>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
const $ = (id) => document.getElementById(id);

/* =======================
   STATE (autosaves)
======================= */
const STORE = "fps_photo_notes_v2_state";
let state = { address:"", date:"", general:"", items:[] };

// current generated PDF (for share/download after create)
let currentPdfBlob = null;
let currentPdfFilename = "";

function showToast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(showToast._tm);
  showToast._tm = setTimeout(()=>t.style.display="none", 1600);
}

function ukDateFromInput(value){
  if(!value) return "";
  const [y,m,d] = value.split("-").map(Number);
  if(!y || !m || !d) return "";
  return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
}
function ukDateForFilename(value){
  if(!value) return "";
  const [y,m,d] = value.split("-").map(Number);
  if(!y || !m || !d) return "";
  return `${String(d).padStart(2,"0")}-${String(m).padStart(2,"0")}-${y}`;
}
function cleanForFilename(s){
  return (s || "No-Address")
    .trim()
    .replace(/\s+/g," ")
    .replace(/[\/\\:*?"<>|]/g,"-")
    .slice(0, 60);
}

function syncHeader(){
  $("pdfAddress").textContent = state.address || "‚Äî";
  $("pdfDate").textContent = ukDateFromInput(state.date) || "‚Äî";
}

function saveState(){
  localStorage.setItem(STORE, JSON.stringify(state));
  syncHeader();
  // If the form changes, we invalidate the current PDF (so you don't share old one)
  invalidateCurrentPdf();
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORE);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
  $("address").value = state.address || "";
  $("date").value = state.date || "";
  $("general").value = state.general || "";
  syncHeader();
  render();
}

function invalidateCurrentPdf(){
  currentPdfBlob = null;
  currentPdfFilename = "";
  $("sharePdf").disabled = true;
  $("downloadPdf").disabled = true;
}

$("address").addEventListener("input", (e)=>{ state.address = e.target.value; saveState(); });
$("date").addEventListener("change", (e)=>{ state.date = e.target.value; saveState(); });
$("general").addEventListener("input", (e)=>{ state.general = e.target.value; saveState(); });

/* =======================
   DICTATION (BULLETS, NO MISSING PHRASES)
======================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;
let micWarmStream = null;

let activeDictBtn = null;
let activeTarget = null;

function setSpeechStatus(msg){ $("speechStatus").textContent = msg || ""; }

function setDictButtonState(btn, st){
  if(!btn) return;
  if(st === "recording"){
    btn.textContent = "‚èπ Stop";
    btn.classList.add("rec");
  }else{
    btn.textContent = "üé§ Dictate";
    btn.classList.remove("rec");
  }
}

async function warmUpMicPermission(){
  try{
    micWarmStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    micWarmStream.getTracks().forEach(t=>t.stop());
    micWarmStream = null;
    return true;
  }catch(err){
    setSpeechStatus("Mic blocked. Chrome ‚Üí padlock ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.");
    return false;
  }
}

function appendBullet(targetTextarea, text){
  const clean = (text || "").trim();
  if(!clean) return;

  const bulletLine = "‚Ä¢ " + clean;
  const cur = targetTextarea.value || "";

  if(!cur.trim()){
    targetTextarea.value = bulletLine;
  }else{
    targetTextarea.value = cur.replace(/\s+$/,"") + "\n" + bulletLine;
  }
  targetTextarea.dispatchEvent(new Event("input", { bubbles:true }));
}

function stopDictation(){
  if(rec){
    try{ rec.stop(); }catch(e){}
  }
  setDictButtonState(activeDictBtn, "idle");
  setSpeechStatus("Stopped.");
  rec = null;
  activeDictBtn = null;
  activeTarget = null;
}

async function toggleDictation(targetTextarea, dictButton){
  if(rec && activeTarget === targetTextarea){
    stopDictation();
    return;
  }
  if(rec) stopDictation();

  if(!SR){
    alert("Dictation not supported. Use Chrome on Android.");
    return;
  }

  setSpeechStatus("Requesting microphone‚Ä¶");
  const ok = await warmUpMicPermission();
  if(!ok) return;

  activeDictBtn = dictButton;
  activeTarget = targetTextarea;
  setDictButtonState(activeDictBtn, "recording");

  rec = new SR();
  rec.lang = "en-GB";
  rec.interimResults = true;
  rec.continuous = true;

  rec.onstart = ()=> setSpeechStatus("Recording‚Ä¶ speak now.");

  rec.onresult = (ev)=>{
    let addedAny = false;
    for(let i = ev.resultIndex; i < ev.results.length; i++){
      const res = ev.results[i];
      if(res && res.isFinal){
        const phrase = res[0] && res[0].transcript ? res[0].transcript : "";
        appendBullet(activeTarget, phrase);
        addedAny = true;
      }
    }
    if(addedAny) setSpeechStatus("Recorded ‚úÖ (tap Stop or keep talking)");
    else setSpeechStatus("Recording‚Ä¶");
  };

  rec.onerror = (ev)=>{
    const err = ev && ev.error ? ev.error : "unknown";
    if(err === "not-allowed" || err === "service-not-allowed"){
      setSpeechStatus("Mic blocked. Chrome ‚Üí padlock ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.");
    }else if(err === "no-speech"){
      setSpeechStatus("No speech detected. Try again.");
    }else{
      setSpeechStatus("Dictation error: " + err);
    }
  };

  rec.onend = ()=>{
    setDictButtonState(activeDictBtn, "idle");
    setSpeechStatus("Stopped.");
    rec = null; activeDictBtn = null; activeTarget = null;
    setTimeout(()=> setSpeechStatus(""), 1500);
  };

  try{ rec.start(); }
  catch(e){
    setDictButtonState(activeDictBtn, "idle");
    setSpeechStatus("Could not start dictation. Try Chrome + allow microphone.");
    rec = null; activeDictBtn = null; activeTarget = null;
  }
}

/* =======================
   RENDER PHOTOS
======================= */
function render(){
  const list = $("list");
  list.innerHTML = "";

  state.items.forEach((it, idx)=>{
    const box = document.createElement("div");
    box.className="item";
    box.innerHTML = `
      <div class="thumb"><img src="${it.img}" alt="Photo ${idx+1}"></div>
      <div class="small" style="margin-bottom:6px"><strong>Photo ${idx+1}</strong></div>
      <textarea placeholder="Notes for this photo..."></textarea>
      <div class="row" style="margin-top:6px">
        <button type="button" class="good">üé§ Dictate</button>
        <button type="button" class="bad">‚å´ Clear</button>
        <button type="button" class="bad">üóëÔ∏è Delete</button>
      </div>
    `;

    const ta = box.querySelector("textarea");
    ta.value = it.note || "";
    ta.addEventListener("input", (e)=>{ it.note = e.target.value; saveState(); });

    const [bDict,bClear,bDel] = box.querySelectorAll("button");

    bDict.addEventListener("click", ()=> toggleDictation(ta, bDict));

    bClear.addEventListener("click", ()=>{
      ta.value=""; it.note=""; saveState(); showToast("Note cleared");
    });

    bDel.addEventListener("click", ()=>{
      if(!confirm("Delete this photo?")) return;
      if(activeTarget === ta) stopDictation();
      state.items.splice(idx,1);
      saveState(); render(); showToast("Photo deleted");
    });

    list.appendChild(box);
  });
}

/* =======================
   CAMERA
======================= */
let stream = null;

function openCam(){
  $("camModal").style.display="flex";
  $("camModal").setAttribute("aria-hidden","false");
}
function closeCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  $("camModal").style.display="none";
  $("camModal").setAttribute("aria-hidden","true");
}

$("openCamera").addEventListener("click", async ()=>{
  openCam();
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" }, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    $("video").srcObject = stream;
    await $("video").play();
  }catch(err){
    alert("Camera failed to start. Please allow camera permission.\n\n" + err);
    closeCam();
  }
});
$("closeCam").addEventListener("click", closeCam);
$("closeCamTop").addEventListener("click", closeCam);

$("snap").addEventListener("click", ()=>{
  const v = $("video");
  if(!v.videoWidth) return;
  const c = document.createElement("canvas");
  c.width=v.videoWidth; c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);

  state.items.push({ img:c.toDataURL("image/jpeg",0.94), note:"" });
  saveState(); render(); showToast("Photo added");
});

/* =======================
   GALLERY IMPORT
======================= */
$("chooseGallery").addEventListener("click", ()=> $("galleryInput").click());

$("galleryInput").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  for(const f of files){
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await img.decode();

    const max = 1800;
    const scale = Math.min(1, max / Math.max(img.width, img.height));
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const c = document.createElement("canvas");
    c.width=w; c.height=h;
    c.getContext("2d").drawImage(img,0,0,w,h);

    state.items.push({ img:c.toDataURL("image/jpeg",0.94), note:"" });
    URL.revokeObjectURL(img.src);
  }

  e.target.value="";
  saveState(); render(); showToast("Added from gallery");
});

/* =======================
   NEW FORM
======================= */
$("newForm").addEventListener("click", ()=>{
  if(!confirm("Start a NEW form? This clears address/date/notes/photos on this device.")) return;
  if(rec) stopDictation();

  state = { address:"", date:"", general:"", items:[] };
  localStorage.removeItem(STORE);

  $("address").value="";
  $("general").value="";

  const d = new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  $("date").value = `${y}-${m}-${day}`;
  state.date = $("date").value;

  saveState(); render(); showToast("New form ready");
});

/* =======================
   PDF LIBRARY (IndexedDB)
======================= */
const DB_NAME = "fps_pdfs_db";
const DB_STORE = "pdfs";
const DB_VER = 1;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        const store = db.createObjectStore(DB_STORE, { keyPath:"id" });
        store.createIndex("createdAt", "createdAt");
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function savePdfRecord(record){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).put(record);
    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
  });
}

async function listPdfRecords(){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readonly");
    const store = tx.objectStore(DB_STORE);
    const req = store.getAll();
    req.onsuccess = ()=>{
      const rows = req.result || [];
      rows.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      db.close();
      resolve(rows);
    };
    req.onerror = ()=>{ db.close(); reject(req.error); };
  });
}

async function deletePdfRecord(id){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).delete(id);
    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
  });
}

/* =======================
   PDF GENERATION (CREATE ‚Üí SHARE/DOWNLOAD)
======================= */
async function dataUrlToImageDims(dataUrl){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=> resolve({ w: img.width, h: img.height });
    img.onerror = reject;
    img.src = dataUrl;
  });
}

async function buildPdfBlob(){
  const { jsPDF } = window.jspdf;
  if(!jsPDF) throw new Error("jsPDF not loaded");

  const addr = state.address || "No Address";
  const dateUK = ukDateFromInput(state.date) || "No Date";

  const doc = new jsPDF({ unit:"mm", format:"a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 12;
  let y = margin;

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Ford Property Services", margin, y);
  y += 7;
  doc.setFontSize(12);
  doc.text("Photo Notes", margin, y);
  y += 8;

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);
  doc.text("Property Address:", margin, y);
  y += 6;

  doc.setFont("helvetica","bold");
  doc.text(doc.splitTextToSize(addr, pageW - margin*2), margin, y);
  y += 10;

  doc.setFont("helvetica","normal");
  doc.text("Date: " + dateUK, margin, y);
  y += 10;

  if(state.general && state.general.trim()){
    doc.setFont("helvetica","bold"); doc.text("General notes:", margin, y); y += 6;
    doc.setFont("helvetica","normal");
    const lines = doc.splitTextToSize(state.general.trim(), pageW - margin*2);
    doc.text(lines, margin, y);
    y += lines.length * 5 + 6;
  }

  for(let i=0;i<state.items.length;i++){
    const it = state.items[i];

    if(y > pageH - 60){
      doc.addPage();
      y = margin;
    }

    doc.setFont("helvetica","bold");
    doc.text(`Photo ${i+1}`, margin, y);
    y += 6;

    const dims = await dataUrlToImageDims(it.img);
    const maxW = pageW - margin*2;
    const maxH = 90;
    const ratio = Math.min(maxW / dims.w, maxH / dims.h);
    const drawW = dims.w * ratio;
    const drawH = dims.h * ratio;

    doc.addImage(it.img, "JPEG", margin, y, drawW, drawH);
    y += drawH + 6;

    doc.setFont("helvetica","normal");
    const note = (it.note && it.note.trim()) ? it.note.trim() : "‚Äî";
    const noteLines = doc.splitTextToSize(note, pageW - margin*2);
    doc.text(noteLines, margin, y);
    y += noteLines.length * 5 + 8;
  }

  return doc.output("blob");
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
}

async function shareBlob(blob, filename){
  if(!navigator.canShare || !navigator.share){
    downloadBlob(blob, filename);
    return;
  }
  const file = new File([blob], filename, { type:"application/pdf" });
  try{
    if(navigator.canShare({ files:[file] })){
      await navigator.share({ files:[file], title: filename });
    }else{
      downloadBlob(blob, filename);
    }
  }catch(e){
    downloadBlob(blob, filename);
  }
}

function makeFilename(){
  const safeAddr = cleanForFilename(state.address);
  const dateFile = ukDateForFilename(state.date) || "No-Date";
  return `Photo-Notes_${safeAddr}_${dateFile}.pdf`;
}

function validateForPdf(){
  if(!state.address || !state.address.trim()){
    alert("Please enter the Property address first (so the PDF can be named).");
    return false;
  }
  if(!state.date){
    alert("Please select a date first.");
    return false;
  }
  if(!state.items.length){
    alert("Please add at least 1 photo before creating PDF.");
    return false;
  }
  return true;
}

/* Create PDF (stores in app library + enables Share/Download buttons) */
$("createPdf").addEventListener("click", async ()=>{
  if(!validateForPdf()) return;

  try{
    $("createPdf").disabled = true;
    showToast("Creating PDF‚Ä¶");

    const blob = await buildPdfBlob();
    const filename = makeFilename();

    currentPdfBlob = blob;
    currentPdfFilename = filename;

    // Save into in-app library
    const id = "pdf_" + Date.now();
    await savePdfRecord({
      id,
      filename,
      createdAt: Date.now(),
      address: state.address,
      date: state.date,
      blob
    });

    $("sharePdf").disabled = false;
    $("downloadPdf").disabled = false;

    showToast("PDF created ‚úÖ Now tap Share or Download");
  }catch(err){
    alert("PDF creation failed:\n\n" + err);
  }finally{
    $("createPdf").disabled = false;
  }
});

/* Share PDF (uses last created PDF) */
$("sharePdf").addEventListener("click", async ()=>{
  if(!currentPdfBlob){
    alert("Please tap Create PDF first.");
    return;
  }
  await shareBlob(currentPdfBlob, currentPdfFilename);
});

/* Download PDF (uses last created PDF) */
$("downloadPdf").addEventListener("click", ()=>{
  if(!currentPdfBlob){
    alert("Please tap Create PDF first.");
    return;
  }
  downloadBlob(currentPdfBlob, currentPdfFilename);
  showToast("Downloaded ‚úÖ");
});

/* =======================
   FILES MODAL
======================= */
function openFiles(){
  $("filesModal").style.display="flex";
  $("filesModal").setAttribute("aria-hidden","false");
  renderFiles();
}
function closeFiles(){
  $("filesModal").style.display="none";
  $("filesModal").setAttribute("aria-hidden","true");
}
$("openFiles").addEventListener("click", openFiles);
$("closeFiles").addEventListener("click", closeFiles);
$("refreshFiles").addEventListener("click", renderFiles);

async function renderFiles(){
  const box = $("filesList");
  box.innerHTML = "<div class='small'>Loading‚Ä¶</div>";
  try{
    const rows = await listPdfRecords();
    if(!rows.length){
      box.innerHTML = "<div class='small'>No PDFs saved yet. Use ‚ÄúCreate PDF‚Äù.</div>";
      return;
    }

    box.innerHTML = "";
    rows.forEach((r)=>{
      const d = new Date(r.createdAt);
      const when = d.toLocaleString("en-GB");
      const row = document.createElement("div");
      row.className = "fileRow";
      row.innerHTML = `
        <div>
          <strong>${r.filename}</strong>
          <div class="mono">${when}</div>
          <div class="small">${r.address || ""}</div>
        </div>
        <div class="fileActions">
          <button type="button" class="good">‚¨áÔ∏è Download</button>
          <button type="button">üì§ Share</button>
          <button type="button" class="bad">üóëÔ∏è Delete</button>
        </div>
      `;

      const [bDown, bShare, bDel] = row.querySelectorAll("button");

      bDown.addEventListener("click", ()=> downloadBlob(r.blob, r.filename));
      bShare.addEventListener("click", ()=> shareBlob(r.blob, r.filename));
      bDel.addEventListener("click", async ()=>{
        if(!confirm("Delete this saved PDF from the app library?")) return;
        await deletePdfRecord(r.id);
        renderFiles();
      });

      box.appendChild(row);
    });
  }catch(e){
    box.innerHTML = "<div class='small'>Could not load saved PDFs.</div>";
  }
}

/* =======================
   INIT
======================= */
(function init(){
  const d = new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  $("date").value = `${y}-${m}-${day}`;

  loadState();

  if(!state.date){
    state.date = $("date").value;
    saveState();
  }
})();
</script>

</body>
</html>
```Ó®Å0Ó®Ç
