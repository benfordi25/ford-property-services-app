<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Photo Notes ‚Ä¢ Job PDF</title>

  <meta name="theme-color" content="#0b1220" />

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --card2:#0e1730;
      --text:#e7eefc; --muted:#a9b7d3; --line:rgba(255,255,255,.14);
      --blue:#4aa3ff; --good:#22c55e; --warn:#fbbf24; --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px; --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(74,163,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 100% 0%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 16px 10px;
      position:sticky; top:0; z-index:50;
      background: linear-gradient(to bottom, rgba(11,18,32,.95), rgba(11,18,32,.6));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .wrap{max-width:980px; margin:0 auto;}
    .toprow{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    main{padding:14px 16px 80px;}
    .grid{display:grid; grid-template-columns:1fr; gap:12px;}
    @media(min-width:860px){ .grid{grid-template-columns: 1.05fr .95fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 14px 8px;
      font-size:14px; text-transform:uppercase; letter-spacing:.14em;
      color: var(--muted);
    }
    .card .body{padding:0 14px 14px;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, textarea{
      width:100%;
      background: rgba(7,11,20,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font-size: 15px;
    }
    textarea{min-height:96px; resize:vertical;}
    .row{display:grid; grid-template-columns:1fr; gap:10px;}
    @media(min-width:860px){ .row{grid-template-columns:1fr 1fr;} }

    .btnrow{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;}
    button{
      border:none; cursor:pointer; font-weight:800;
      border-radius: 14px; padding: 12px 14px;
      color:var(--text);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
    }
    button.primary{
      background: rgba(74,163,255,.18);
      border-color: rgba(74,163,255,.35);
    }
    button.good{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.35);
    }
    button.bad{
      background: rgba(239,68,68,.16);
      border-color: rgba(239,68,68,.35);
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    .hint{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.35;}
    .divider{height:1px; background: rgba(255,255,255,.10); margin:12px 0;}

    /* Photo items */
    .list{display:flex; flex-direction:column; gap:12px; padding:0 14px 14px;}
    .item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,11,20,.35);
      border-radius: var(--r2);
      overflow:hidden;
    }
    .itemTop{
      display:flex; gap:10px; padding:12px;
      align-items:flex-start;
    }
    .thumb{
      width:92px; height:92px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      object-fit:cover; background: rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .meta{flex:1; min-width:0;}
    .meta .title{
      font-weight:900; font-size:14px; margin:0 0 4px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .meta .sub{font-size:12px; color:var(--muted); margin:0 0 8px;}
    .meta textarea{min-height:84px; font-size:14px;}
    .itemBtns{
      display:flex; flex-wrap:wrap; gap:8px; padding:0 12px 12px;
    }
    .small{
      padding:10px 12px; border-radius: 12px; font-size:13px; font-weight:900;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:6px 10px; border-radius:999px;
    }

    /* Bottom bar */
    .bottombar{
      position:fixed; left:0; right:0; bottom:0; z-index:80;
      background: linear-gradient(to top, rgba(11,18,32,.96), rgba(11,18,32,.72));
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      backdrop-filter: blur(10px);
    }
    .bwrap{max-width:980px; margin:0 auto; display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .status{font-size:12px; color:var(--muted); line-height:1.2;}
    .status strong{color:var(--text);}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="toprow">
        <div class="brand">
          üì∏ <span>Photo Notes</span>
          <span class="pill" id="todayPill"></span>
        </div>
        <span class="pill" id="supportPill">Dictation: checking‚Ä¶</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Left: Job details + capture -->
      <section class="card">
        <h2>Job details</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Job / Property</label>
              <input id="jobName" placeholder="e.g., 12 High Street, London" />
            </div>
            <div>
              <label>Client / Ref</label>
              <input id="clientRef" placeholder="e.g., Letting Agent / Job Ref" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Operative</label>
              <input id="operative" placeholder="e.g., Ben Ford" />
            </div>
            <div>
              <label>Report ID</label>
              <input id="reportId" placeholder="Auto-generated" />
            </div>
          </div>

          <div class="divider"></div>

          <label>Add photos</label>
          <div class="btnrow">
            <button class="primary" id="btnAddPhoto">üì∑ Take / Add Photos</button>
            <button id="btnClearAll" class="bad">üóëÔ∏è Clear All</button>
          </div>
          <div class="hint">
            Tip: On Android Chrome, this will open the camera first. You can add multiple photos.
          </div>

          <input id="photoInput" type="file" accept="image/*" capture="environment" multiple style="display:none" />

          <div class="divider"></div>

          <div class="btnrow">
            <button class="good" id="btnMakePdf">üßæ Generate PDF</button>
            <button id="btnSharePdf" class="primary" disabled>üì§ Share PDF (WhatsApp)</button>
            <button id="btnDownloadPdf" disabled>‚¨áÔ∏è Download PDF</button>
          </div>

          <div class="hint" id="shareHint">
            After generating the PDF, tap <strong>Share PDF</strong> and pick WhatsApp.
          </div>
        </div>
      </section>

      <!-- Right: Photo list -->
      <section class="card">
        <h2>Photos & notes</h2>
        <div class="body">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
            <span class="badge" id="countBadge">0 photos</span>
            <span class="badge" id="pdfBadge">PDF: not generated</span>
          </div>
        </div>

        <div class="list" id="photoList"></div>
      </section>
    </div>
  </main>

  <div class="bottombar">
    <div class="bwrap">
      <div class="status" id="status">
        <strong>Ready.</strong> Add photos, dictate notes, then generate and share a PDF.
      </div>
      <button class="small primary" id="btnScrollTop">‚Üë Top</button>
    </div>
  </div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  const now = new Date();
  const ukDate = (d) => d.toLocaleDateString("en-GB", { day:"2-digit", month:"2-digit", year:"numeric" });
  const ukTime = (d) => d.toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit" });

  function makeReportId(){
    // e.g. PN-2026-01-10-1432-7F3A
    const pad = (n) => String(n).padStart(2,"0");
    const y = now.getFullYear();
    const m = pad(now.getMonth()+1);
    const d = pad(now.getDate());
    const hh = pad(now.getHours());
    const mm = pad(now.getMinutes());
    const rand = Math.random().toString(16).slice(2,6).toUpperCase();
    return `PN-${y}-${m}-${d}-${hh}${mm}-${rand}`;
  }

  function setStatus(msg, tone=""){
    const el = $("status");
    el.innerHTML = `<strong>${tone ? tone + " " : ""}</strong>${msg}`;
  }

  async function fileToDataURL(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function dataURLToImage(dataURL){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = dataURL;
    });
  }

  function blobToFile(blob, filename, type){
    return new File([blob], filename, { type: type || blob.type || "application/pdf" });
  }

  // ---------- State ----------
  const state = {
    items: [], // { id, dataURL, ts, note }
    pdfBlob: null,
    pdfFile: null,
    pdfName: null
  };

  // ---------- Dictation (Web Speech API) ----------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const dictationSupported = !!SpeechRecognition;

  function setSupportPill(){
    $("supportPill").textContent = dictationSupported ? "Dictation: supported" : "Dictation: not supported";
  }

  // Build a recognition instance per recording for reliability
  function startDictationFor(itemId, textarea){
    if(!dictationSupported){
      alert("Dictation isn't supported on this browser. Try Android Chrome.");
      return;
    }
    const rec = new SpeechRecognition();
    rec.lang = "en-GB";
    rec.interimResults = true;
    rec.continuous = false;

    let finalText = "";
    const existing = textarea.value ? textarea.value.trim() : "";

    const stopBtn = document.querySelector(`[data-stop="${itemId}"]`);
    const startBtn = document.querySelector(`[data-dictate="${itemId}"]`);
    startBtn.disabled = true;
    stopBtn.disabled = false;

    setStatus("Listening‚Ä¶ speak your note.", "üéôÔ∏è");

    rec.onresult = (e) => {
      let interim = "";
      for (let i = e.resultIndex; i < e.results.length; i++){
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) finalText += t;
        else interim += t;
      }
      const combined = (existing ? existing + " " : "") + (finalText + interim).trim();
      textarea.value = combined.trim();
      saveNote(itemId, textarea.value);
    };

    rec.onerror = (e) => {
      setStatus("Dictation error. You can try again.", "‚ö†Ô∏è");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    rec.onend = () => {
      setStatus("Dictation stopped.", "‚úÖ");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    // hook stop
    stopBtn.onclick = () => {
      try { rec.stop(); } catch {}
    };

    try {
      rec.start();
    } catch (err) {
      setStatus("Couldn‚Äôt start dictation. Try again.", "‚ö†Ô∏è");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  // ---------- UI Rendering ----------
  function updateBadges(){
    $("countBadge").textContent = `${state.items.length} photo${state.items.length===1?"":"s"}`;
    $("pdfBadge").textContent = state.pdfFile ? `PDF: ready (${state.pdfName})` : "PDF: not generated";
    $("btnSharePdf").disabled = !state.pdfFile;
    $("btnDownloadPdf").disabled = !state.pdfFile;
  }

  function saveNote(itemId, val){
    const it = state.items.find(x => x.id === itemId);
    if(it){ it.note = val; }
  }

  function removeItem(itemId){
    state.items = state.items.filter(x => x.id !== itemId);
    // Invalidate PDF because content changed
    state.pdfBlob = null; state.pdfFile = null; state.pdfName = null;
    renderList();
    updateBadges();
    setStatus("Photo removed. Generate the PDF again when ready.", "üóëÔ∏è");
  }

  function renderList(){
    const list = $("photoList");
    list.innerHTML = "";

    if(state.items.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.style.padding = "0 14px 14px";
      empty.innerHTML = "No photos yet. Tap <strong>Take / Add Photos</strong> to start.";
      list.appendChild(empty);
      return;
    }

    state.items.forEach((it, idx) => {
      const item = document.createElement("div");
      item.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const img = document.createElement("img");
      img.className = "thumb";
      img.src = it.dataURL;
      img.alt = `Photo ${idx+1}`;

      const meta = document.createElement("div");
      meta.className = "meta";

      const title = document.createElement("p");
      title.className = "title";
      title.textContent = `Photo ${idx+1}`;

      const sub = document.createElement("p");
      sub.className = "sub";
      sub.textContent = `${ukDate(it.ts)} ${ukTime(it.ts)}`;

      const ta = document.createElement("textarea");
      ta.placeholder = "Add notes for this photo‚Ä¶ (or use Dictate)";
      ta.value = it.note || "";
      ta.oninput = () => {
        saveNote(it.id, ta.value);
        // Invalidate PDF if edited
        state.pdfBlob = null; state.pdfFile = null; state.pdfName = null;
        updateBadges();
      };

      meta.appendChild(title);
      meta.appendChild(sub);
      meta.appendChild(ta);

      top.appendChild(img);
      top.appendChild(meta);

      const btns = document.createElement("div");
      btns.className = "itemBtns";

      const bDict = document.createElement("button");
      bDict.className = "small primary";
      bDict.textContent = "üéôÔ∏è Dictate";
      bDict.disabled = !dictationSupported;
      bDict.setAttribute("data-dictate", it.id);
      bDict.onclick = () => startDictationFor(it.id, ta);

      const bStop = document.createElement("button");
      bStop.className = "small";
      bStop.textContent = "‚èπÔ∏è Stop";
      bStop.disabled = true;
      bStop.setAttribute("data-stop", it.id);

      const bRemove = document.createElement("button");
      bRemove.className = "small bad";
      bRemove.textContent = "üóëÔ∏è Remove";
      bRemove.onclick = () => removeItem(it.id);

      btns.appendChild(bDict);
      btns.appendChild(bStop);
      btns.appendChild(bRemove);

      item.appendChild(top);
      item.appendChild(btns);

      list.appendChild(item);
    });
  }

  // ---------- PDF Generation ----------
  async function generatePdf(){
    const jobName = $("jobName").value.trim() || "Job";
    const clientRef = $("clientRef").value.trim();
    const operative = $("operative").value.trim();
    const reportId = $("reportId").value.trim() || makeReportId();
    $("reportId").value = reportId;

    if(state.items.length === 0){
      alert("Add at least one photo first.");
      return;
    }

    setStatus("Generating PDF‚Ä¶", "üßæ");
    $("btnMakePdf").disabled = true;

    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 12;
      const contentW = pageW - margin*2;

      // Header
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("PHOTO NOTES REPORT", margin, 16);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Date: ${ukDate(new Date())}   Time: ${ukTime(new Date())}`, margin, 22);
      doc.text(`Report ID: ${reportId}`, margin, 27);

      doc.setFont("helvetica", "bold");
      doc.text("Job / Property:", margin, 34);
      doc.setFont("helvetica", "normal");
      doc.text(jobName, margin + 28, 34);

      if(clientRef){
        doc.setFont("helvetica", "bold");
        doc.text("Client / Ref:", margin, 40);
        doc.setFont("helvetica", "normal");
        doc.text(clientRef, margin + 28, 40);
      }

      if(operative){
        doc.setFont("helvetica", "bold");
        doc.text("Operative:", margin, 46);
        doc.setFont("helvetica", "normal");
        doc.text(operative, margin + 28, 46);
      }

      // Divider line
      doc.setDrawColor(200);
      doc.setLineWidth(0.2);
      doc.line(margin, 50, pageW - margin, 50);

      let y = 58;

      for(let i=0; i<state.items.length; i++){
        const it = state.items[i];

        // If not enough space, new page
        if(y > pageH - 30){
          doc.addPage();
          y = 18;
        }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text(`Photo ${i+1}`, margin, y);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text(`${ukDate(it.ts)} ${ukTime(it.ts)}`, pageW - margin, y, { align:"right" });

        y += 4;

        // Image sizing: fit within a box
        const img = await dataURLToImage(it.dataURL);
        const imgWpx = img.naturalWidth || img.width;
        const imgHpx = img.naturalHeight || img.height;

        const maxImgW = contentW;
        const maxImgH = 95; // mm
        let drawW = maxImgW;
        let drawH = (imgHpx / imgWpx) * drawW;

        if(drawH > maxImgH){
          drawH = maxImgH;
          drawW = (imgWpx / imgHpx) * drawH;
        }

        const xImg = margin + (contentW - drawW)/2;

        // Draw image border
        doc.setDrawColor(180);
        doc.roundedRect(margin, y, contentW, drawH + 2, 2, 2);
        doc.addImage(it.dataURL, "JPEG", xImg, y+1, drawW, drawH);

        y += drawH + 8;

        // Notes
        const note = (it.note || "").trim();
        doc.setFont("helvetica", "bold");
        doc.setFontSize(10);
        doc.text("Notes:", margin, y);

        y += 5;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        const noteText = note ? note : "‚Äî";
        const lines = doc.splitTextToSize(noteText, contentW);
        // notes box
        const boxH = Math.max(14, lines.length * 5 + 6);
        if(y + boxH > pageH - 12){
          doc.addPage();
          y = 18;
        }
        doc.setDrawColor(180);
        doc.roundedRect(margin, y-4, contentW, boxH, 2, 2);
        doc.text(lines, margin+3, y+2);

        y += boxH + 10;
      }

      // Output blob
      const pdfBlob = doc.output("blob");
      const safeName = (jobName || "Job")
        .replace(/[^\w\s-]/g,"")
        .trim()
        .replace(/\s+/g,"-")
        .slice(0,40);

      const filename = `Photo-Notes-${safeName}-${reportId}.pdf`;

      state.pdfBlob = pdfBlob;
      state.pdfFile = blobToFile(pdfBlob, filename, "application/pdf");
      state.pdfName = filename;

      updateBadges();
      setStatus("PDF generated. Tap Share PDF and choose WhatsApp.", "‚úÖ");
    } catch (err){
      console.error(err);
      alert("PDF generation failed. If you used very large photos, try fewer at once.");
      setStatus("PDF generation failed.", "‚ö†Ô∏è");
    } finally {
      $("btnMakePdf").disabled = false;
    }
  }

  // ---------- Sharing / Download ----------
  async function sharePdf(){
    if(!state.pdfFile){
      alert("Generate the PDF first.");
      return;
    }

    // Web Share (best for WhatsApp)
    if(navigator.canShare && navigator.canShare({ files:[state.pdfFile] })){
      try{
        await navigator.share({
          title: "Photo Notes PDF",
          text: "Photo notes report attached.",
          files: [state.pdfFile]
        });
        setStatus("Shared via share sheet.", "üì§");
        return;
      } catch (e){
        // user cancelled or share failed
        console.warn(e);
      }
    }

    // Fallback: download
    downloadPdf();
    alert("Your browser can't share files directly. Downloaded the PDF instead‚Äîthen attach it in WhatsApp.");
  }

  function downloadPdf(){
    if(!state.pdfBlob) return;
    const url = URL.createObjectURL(state.pdfBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = state.pdfName || "photo-notes.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
    setStatus("PDF downloaded.", "‚¨áÔ∏è");
  }

  // ---------- Photo adding ----------
  async function handleFiles(fileList){
    const files = Array.from(fileList || []);
    if(!files.length) return;

    setStatus(`Adding ${files.length} photo(s)‚Ä¶`, "üì∏");
    $("btnAddPhoto").disabled = true;

    try{
      for(const f of files){
        if(!f.type.startsWith("image/")) continue;

        const dataURL = await fileToDataURL(f);

        state.items.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
          dataURL,
          ts: new Date(),
          note: ""
        });
      }

      // Invalidate PDF because content changed
      state.pdfBlob = null; state.pdfFile = null; state.pdfName = null;

      renderList();
      updateBadges();
      setStatus("Photos added. Add notes (or dictate), then generate the PDF.", "‚úÖ");
    } finally {
      $("btnAddPhoto").disabled = false;
    }
  }

  // ---------- Init ----------
  $("todayPill").textContent = `${ukDate(new Date())} ‚Ä¢ ${ukTime(new Date())}`;
  $("reportId").value = makeReportId();
  setSupportPill();
  renderList();
  updateBadges();

  $("btnAddPhoto").onclick = () => $("photoInput").click();
  $("photoInput").addEventListener("change", (e) => handleFiles(e.target.files));

  $("btnMakePdf").onclick = generatePdf;
  $("btnSharePdf").onclick = sharePdf;
  $("btnDownloadPdf").onclick = downloadPdf;

  $("btnClearAll").onclick = () => {
    if(!confirm("Clear all photos and notes?")) return;
    state.items = [];
    state.pdfBlob = null; state.pdfFile = null; state.pdfName = null;
    renderList();
    updateBadges();
    setStatus("Cleared.", "üóëÔ∏è");
  };

  $("btnScrollTop").onclick = () => window.scrollTo({ top:0, behavior:"smooth" });

})();
</script>
</body>
</html>
