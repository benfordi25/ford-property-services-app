<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ Photo Notes</title>
<meta name="theme-color" content="#0b1220">

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220; --text:#e7eefc; --muted:#a9b7d3;
  --line:rgba(255,255,255,.14); --shadow:0 10px 30px rgba(0,0,0,.35);
  --good:#22c55e; --bad:#ef4444; --info:#7dd3fc;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 650px at 20% -10%, rgba(74,163,255,.18), transparent 60%),
    radial-gradient(1000px 650px at 100% 0%, rgba(34,197,94,.10), transparent 55%),
    var(--bg);
}
header{
  position:sticky;top:0;z-index:10;
  background: rgba(11,18,32,.86);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:54px;height:54px;border-radius:14px;background:#fff;color:#0b1220;
  display:grid;place-items:center;font-weight:950;letter-spacing:.4px;
  box-shadow:var(--shadow);
}
a.back{color:#9ecbff;text-decoration:none;font-weight:900}
main{max-width:1100px;margin:0 auto;padding:16px}
.card{
  background: linear-gradient(180deg, rgba(15,27,51,.92), rgba(12,23,48,.92));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow: var(--shadow);
  padding:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
}
button.good{border-color:rgba(34,197,94,.55)}
button.bad{border-color:rgba(239,68,68,.55)}
button.rec{
  border-color:rgba(239,68,68,.8);
  box-shadow: 0 0 0 2px rgba(239,68,68,.18) inset;
}
button:disabled{opacity:.55;cursor:not-allowed}
input,textarea{
  width:100%;
  background: rgba(0,0,0,.22);
  color:var(--text);
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:10px 12px;
}
textarea{min-height:90px;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
#speechStatus{font-size:12px;color:#b9d6ff;margin-top:8px}

.grid{display:grid;gap:12px;margin-top:12px;grid-template-columns:1fr}
@media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
.item{
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:12px;
  background: rgba(0,0,0,.16);
}
.thumb{
  aspect-ratio:4/3;
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  overflow:hidden;
  background:#000;
  margin-bottom:8px;
}
.thumb img{width:100%;height:100%;object-fit:contain}
.liveLine{font-size:12px;color:var(--info);min-height:16px;margin-top:6px}

.toast{
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  background:#000;color:#fff;padding:10px 14px;border-radius:14px;display:none;
  font-weight:900;z-index:100;border:1px solid rgba(255,255,255,.12)
}

/* camera modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50;padding:14px}
.panel{background:#0b1220;border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:12px;width:min(960px,96%)}
.videoWrap{aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.14)}
video{width:100%;height:100%;object-fit:cover}
</style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo">FPS</div>
      <div>
        <div style="font-weight:950">Ford Property Services</div>
        <div class="small">Photo Notes</div>
      </div>
    </div>
    <!-- IMPORTANT: since this file is /job-photo-notes/, dashboard is usually ../dashboard/ -->
    <a class="back" href="../dashboard/">‚Üê Dashboard</a>
  </div>
</header>

<input id="galleryInput" type="file" accept="image/*" multiple style="display:none">

<main>
  <div class="card">

    <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end">
      <div>
        <div style="font-weight:950;font-size:16px">Photo Report</div>
        <div class="small">Address and date will be added to the PDF filename.</div>
      </div>
      <div class="row">
        <button id="newForm" class="bad" type="button">üÜï New form</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="address" placeholder="Property address">
      <input id="date" type="date" style="max-width:220px">
    </div>

    <div class="row" style="margin-top:10px">
      <button id="openCamera" class="good" type="button">üì∑ Open camera</button>
      <button id="chooseGallery" type="button">üñºÔ∏è Gallery</button>
      <button id="createPdf" class="good" type="button">üßæ Create PDF</button>
      <button id="sharePdf" type="button" disabled>üì§ Share PDF</button>
      <button id="downloadPdf" type="button" disabled>‚¨áÔ∏è Download PDF</button>
    </div>

    <div id="speechStatus"></div>

    <textarea id="general" placeholder="General notes (optional)" style="margin-top:12px"></textarea>

    <div id="list" class="grid"></div>

    <div class="small" style="margin-top:10px">
      Tip: If dictation doesn‚Äôt type, open this page in <strong>Chrome</strong> and allow Microphone permission (padlock icon).
    </div>

  </div>
</main>

<!-- Camera modal -->
<div id="camModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <strong>Camera</strong>
      <button id="closeCamTop" class="bad" type="button">‚úï Close</button>
    </div>
    <div class="videoWrap" style="margin-top:10px">
      <video id="video" autoplay playsinline muted></video>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="snap" class="good" type="button">üì∏ Take photo</button>
      <button id="closeCam" class="bad" type="button">‚úï Close</button>
    </div>
    <div class="small" style="margin-top:8px">Photos stay inside the app unless you export a PDF.</div>
  </div>
</div>

<div id="toast" class="toast">Saved</div>

<script>
const $ = (id)=>document.getElementById(id);

const STORE = "fps_job_photo_notes_v3";
let state = { address:"", date:"", general:"", items:[] };

let currentPdfBlob = null;
let currentPdfFilename = "";

function showToast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(showToast._tm);
  showToast._tm = setTimeout(()=>t.style.display="none", 1400);
}

function ukDateFromInput(value){
  if(!value) return "";
  const [y,m,d] = value.split("-").map(Number);
  if(!y || !m || !d) return "";
  return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
}
function ukDateForFilename(value){
  if(!value) return "";
  const [y,m,d] = value.split("-").map(Number);
  if(!y || !m || !d) return "";
  return `${String(d).padStart(2,"0")}-${String(m).padStart(2,"0")}-${y}`;
}
function cleanForFilename(s){
  return (s || "No-Address")
    .trim()
    .replace(/\s+/g," ")
    .replace(/[\/\\:*?"<>|]/g,"-")
    .slice(0, 60);
}

function invalidatePdf(){
  currentPdfBlob = null;
  currentPdfFilename = "";
  $("sharePdf").disabled = true;
  $("downloadPdf").disabled = true;
}

function saveState(){
  localStorage.setItem(STORE, JSON.stringify(state));
  invalidatePdf();
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORE);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
  $("address").value = state.address || "";
  $("date").value = state.date || "";
  $("general").value = state.general || "";
  render();
}

/* default date today */
(function initDate(){
  const d = new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  const today = `${y}-${m}-${day}`;
  if(!localStorage.getItem(STORE)){
    state.date = today;
    $("date").value = today;
    saveState();
  }else{
    if(!$("date").value) $("date").value = today;
  }
})();

$("address").addEventListener("input", (e)=>{ state.address = e.target.value; saveState(); });
$("date").addEventListener("change", (e)=>{ state.date = e.target.value; saveState(); });
$("general").addEventListener("input", (e)=>{ state.general = e.target.value; saveState(); });

/* =======================
   CAMERA
======================= */
let stream = null;
function openCam(){
  $("camModal").style.display="flex";
  $("camModal").setAttribute("aria-hidden","false");
}
function closeCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
  $("camModal").style.display="none";
  $("camModal").setAttribute("aria-hidden","true");
}
$("openCamera").addEventListener("click", async ()=>{
  openCam();
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" }, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    $("video").srcObject = stream;
    await $("video").play();
  }catch(err){
    alert("Camera failed to start. Please allow camera permission.\n\n" + err);
    closeCam();
  }
});
$("closeCam").addEventListener("click", closeCam);
$("closeCamTop").addEventListener("click", closeCam);

$("snap").addEventListener("click", ()=>{
  const v = $("video");
  if(!v.videoWidth) return;
  const c = document.createElement("canvas");
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);
  state.items.push({ img: c.toDataURL("image/jpeg",0.94), note:"" });
  saveState();
  render();
  showToast("Photo added");
});

/* =======================
   GALLERY
======================= */
$("chooseGallery").addEventListener("click", ()=> $("galleryInput").click());
$("galleryInput").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  for(const f of files){
    const img = new Image();
    img.src = URL.createObjectURL(f);
    await img.decode();

    const max = 1800;
    const scale = Math.min(1, max / Math.max(img.width, img.height));
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    c.getContext("2d").drawImage(img,0,0,w,h);

    state.items.push({ img: c.toDataURL("image/jpeg",0.94), note:"" });
    URL.revokeObjectURL(img.src);
  }

  e.target.value="";
  saveState();
  render();
  showToast("Added from gallery");
});

/* =======================
   DICTATION (Android-robust + live preview + always commits)
======================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

let rec = null;
let micWarmStream = null;

let activeDictBtn = null;
let activeTarget = null;
let activeLiveLine = null;

let lastInterim = "";
let addedFinalThisSession = false;
let gotAnyAudioSignal = false;
let startedAt = 0;

function setSpeechStatus(msg){ $("speechStatus").textContent = msg || ""; }

function setDictButtonState(btn, st){
  if(!btn) return;
  if(st === "recording"){
    btn.textContent = "‚èπ Stop";
    btn.classList.add("rec");
  }else{
    btn.textContent = "üé§ Dictate";
    btn.classList.remove("rec");
  }
}

async function warmUpMicPermission(){
  try{
    micWarmStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    micWarmStream.getTracks().forEach(t=>t.stop());
    micWarmStream = null;
    return true;
  }catch(err){
    setSpeechStatus("Mic blocked. Chrome ‚Üí padlock ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.");
    return false;
  }
}

function setLive(text){
  if(activeLiveLine) activeLiveLine.textContent = text || "";
}

function appendBullet(targetTextarea, text){
  const clean = (text || "").trim();
  if(!clean) return;

  const bulletLine = clean.startsWith("‚Ä¢") ? clean : ("‚Ä¢ " + clean);
  const cur = targetTextarea.value || "";

  if(!cur.trim()){
    targetTextarea.value = bulletLine;
  }else{
    targetTextarea.value = cur.replace(/\s+$/,"") + "\n" + bulletLine;
  }
  targetTextarea.dispatchEvent(new Event("input", { bubbles:true }));
}

function commitInterimIfNeeded(){
  if(!activeTarget) return;
  if(!addedFinalThisSession && lastInterim.trim()){
    appendBullet(activeTarget, lastInterim);
    lastInterim = "";
  }
}

function stopDictation(){
  if(rec){
    try{ rec.stop(); }catch(e){}
  }
  setDictButtonState(activeDictBtn, "idle");
  setSpeechStatus("Stopping‚Ä¶");
}

async function toggleDictation(targetTextarea, dictButton, liveLineEl){
  if(rec && activeTarget === targetTextarea){
    stopDictation();
    return;
  }
  if(rec){
    stopDictation();
    return;
  }

  if(!SR){
    alert("Dictation not supported. Use Chrome on Android.");
    return;
  }

  activeDictBtn = dictButton;
  activeTarget = targetTextarea;
  activeLiveLine = liveLineEl || null;

  lastInterim = "";
  addedFinalThisSession = false;
  gotAnyAudioSignal = false;
  startedAt = Date.now();

  setDictButtonState(activeDictBtn, "recording");
  setLive("Listening‚Ä¶");
  setSpeechStatus("Requesting microphone‚Ä¶");

  const ok = await warmUpMicPermission();
  if(!ok){
    setDictButtonState(activeDictBtn, "idle");
    setLive("");
    return;
  }

  rec = new SR();
  rec.lang = "en-GB";
  rec.interimResults = true;

  // More reliable on Android/PWA than continuous=true
  rec.continuous = false;
  rec.maxAlternatives = 1;

  rec.onaudiostart = ()=>{ gotAnyAudioSignal = true; setSpeechStatus("Recording‚Ä¶"); };
  rec.onspeechstart = ()=>{ gotAnyAudioSignal = true; setLive("Hearing you‚Ä¶"); };
  rec.onstart = ()=>{ setSpeechStatus("Recording‚Ä¶ speak now."); };

  rec.onresult = (ev)=>{
    for(let i = ev.resultIndex; i < ev.results.length; i++){
      const res = ev.results[i];
      if(!res) continue;
      const transcript = (res[0] && res[0].transcript) ? res[0].transcript : "";
      if(!transcript.trim()) continue;

      if(res.isFinal){
        appendBullet(activeTarget, transcript);
        addedFinalThisSession = true;
        lastInterim = "";
        setLive("");
      }else{
        lastInterim = transcript;
        setLive("‚Ä¶ " + transcript.trim());
      }
    }
    if(addedFinalThisSession){
      setSpeechStatus("Recorded ‚úÖ (tap Dictate again for another bullet)");
    }else{
      setSpeechStatus(lastInterim ? "Recording‚Ä¶ (hearing you)" : "Recording‚Ä¶");
    }
  };

  rec.onerror = (ev)=>{
    const err = ev && ev.error ? ev.error : "unknown";
    if(err === "not-allowed" || err === "service-not-allowed"){
      setSpeechStatus("Mic blocked. Chrome ‚Üí padlock ‚Üí Site settings ‚Üí Microphone ‚Üí Allow.");
    }else if(err === "no-speech"){
      setSpeechStatus("No speech detected. Try again.");
    }else{
      setSpeechStatus("Dictation error: " + err);
    }
  };

  rec.onend = ()=>{
    commitInterimIfNeeded();

    const elapsed = Date.now() - startedAt;
    if(!addedFinalThisSession && !lastInterim.trim()){
      if(!gotAnyAudioSignal && elapsed > 1200){
        setSpeechStatus("No audio captured. Check Microphone permission (Chrome padlock ‚Üí Microphone ‚Üí Allow).");
      }else{
        setSpeechStatus("Stopped (no speech captured). Try again.");
      }
    }else{
      setSpeechStatus("Stopped.");
    }

    setLive("");
    setDictButtonState(activeDictBtn, "idle");

    rec = null;
    activeDictBtn = null;
    activeTarget = null;
    activeLiveLine = null;
    lastInterim = "";
    addedFinalThisSession = false;
    gotAnyAudioSignal = false;
    startedAt = 0;

    setTimeout(()=> setSpeechStatus(""), 1200);
  };

  try{
    rec.start();
    setTimeout(()=>{
      if(rec && !gotAnyAudioSignal && !lastInterim && !addedFinalThisSession){
        setSpeechStatus("Not picking up audio. Use Chrome (not Samsung Internet) and allow Microphone permission.");
      }
    }, 2000);
  }catch(e){
    setSpeechStatus("Could not start dictation. Try Chrome + allow microphone.");
    rec = null;
    setDictButtonState(activeDictBtn, "idle");
    setLive("");
  }
}

/* =======================
   RENDER
======================= */
function render(){
  const list = $("list");
  list.innerHTML = "";

  state.items.forEach((it, idx)=>{
    const box = document.createElement("div");
    box.className="item";
    box.innerHTML = `
      <div class="thumb"><img src="${it.img}" alt="Photo ${idx+1}"></div>
      <div class="small" style="margin-bottom:6px"><strong>Photo ${idx+1}</strong></div>
      <textarea placeholder="Notes for this photo..."></textarea>
      <div class="liveLine"></div>
      <div class="row" style="margin-top:6px">
        <button type="button" class="good">üé§ Dictate</button>
        <button type="button">‚å´ Clear</button>
        <button type="button" class="bad">üóëÔ∏è Delete</button>
      </div>
    `;

    const ta = box.querySelector("textarea");
    const liveLine = box.querySelector(".liveLine");
    ta.value = it.note || "";
    ta.addEventListener("input", (e)=>{ it.note = e.target.value; saveState(); });

    const [bDict, bClear, bDel] = box.querySelectorAll("button");

    bDict.addEventListener("click", ()=> toggleDictation(ta, bDict, liveLine));

    bClear.addEventListener("click", ()=>{
      ta.value = "";
      it.note = "";
      saveState();
      showToast("Cleared");
    });

    bDel.addEventListener("click", ()=>{
      if(!confirm("Delete this photo?")) return;
      state.items.splice(idx,1);
      saveState();
      render();
      showToast("Deleted");
    });

    list.appendChild(box);
  });
}

/* =======================
   NEW FORM
======================= */
$("newForm").addEventListener("click", ()=>{
  if(!confirm("Start a NEW form? This clears address/date/notes/photos on this device.")) return;
  state = { address:"", date:"", general:"", items:[] };
  localStorage.removeItem(STORE);

  $("address").value="";
  $("general").value="";
  const d = new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  $("date").value = `${y}-${m}-${day}`;
  state.date = $("date").value;

  saveState();
  render();
  showToast("New form ready");
});

/* =======================
   PDF
======================= */
async function dataUrlToDims(dataUrl){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=> resolve({w:img.width,h:img.height});
    img.onerror = reject;
    img.src = dataUrl;
  });
}

async function buildPdfBlob(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"mm", format:"a4" });

  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 12;
  let y = margin;

  const addr = state.address || "No Address";
  const dateUK = ukDateFromInput(state.date) || "No Date";

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Ford Property Services", margin, y);
  y += 7;
  doc.setFontSize(12);
  doc.text("Photo Notes", margin, y);
  y += 9;

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);
  doc.text("Property Address:", margin, y); y += 6;
  doc.setFont("helvetica","bold");
  doc.text(doc.splitTextToSize(addr, pageW - margin*2), margin, y);
  y += 10;

  doc.setFont("helvetica","normal");
  doc.text("Date: " + dateUK, margin, y);
  y += 10;

  if(state.general && state.general.trim()){
    doc.setFont("helvetica","bold");
    doc.text("General notes:", margin, y); y += 6;
    doc.setFont("helvetica","normal");
    const lines = doc.splitTextToSize(state.general.trim(), pageW - margin*2);
    doc.text(lines, margin, y);
    y += lines.length * 5 + 6;
  }

  for(let i=0;i<state.items.length;i++){
    const it = state.items[i];

    if(y > pageH - 70){
      doc.addPage();
      y = margin;
    }

    doc.setFont("helvetica","bold");
    doc.text(`Photo ${i+1}`, margin, y);
    y += 6;

    const dims = await dataUrlToDims(it.img);
    const maxW = pageW - margin*2;
    const maxH = 95;
    const ratio = Math.min(maxW/dims.w, maxH/dims.h);
    const w = dims.w * ratio;
    const h = dims.h * ratio;

    doc.addImage(it.img, "JPEG", margin, y, w, h);
    y += h + 6;

    doc.setFont("helvetica","normal");
    const note = (it.note && it.note.trim()) ? it.note.trim() : "‚Äî";
    const noteLines = doc.splitTextToSize(note, pageW - margin*2);
    doc.text(noteLines, margin, y);
    y += noteLines.length * 5 + 8;
  }

  return doc.output("blob");
}

function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
}

async function shareBlob(blob, filename){
  if(!navigator.canShare || !navigator.share){
    downloadBlob(blob, filename);
    return;
  }
  const file = new File([blob], filename, { type:"application/pdf" });
  try{
    if(navigator.canShare({ files:[file] })){
      await navigator.share({ files:[file], title: filename });
    }else{
      downloadBlob(blob, filename);
    }
  }catch(e){
    downloadBlob(blob, filename);
  }
}

function makeFilename(){
  const safeAddr = cleanForFilename(state.address);
  const dateFile = ukDateForFilename(state.date) || "No-Date";
  return `Photo-Notes_${safeAddr}_${dateFile}.pdf`;
}

function validateForPdf(){
  if(!state.address || !state.address.trim()){ alert("Enter the Property address first."); return false; }
  if(!state.date){ alert("Select the date first."); return false; }
  if(!state.items.length){ alert("Add at least 1 photo first."); return false; }
  return true;
}

$("createPdf").addEventListener("click", async ()=>{
  if(!validateForPdf()) return;

  try{
    $("createPdf").disabled = true;
    showToast("Creating PDF‚Ä¶");

    const blob = await buildPdfBlob();
    const filename = makeFilename();

    currentPdfBlob = blob;
    currentPdfFilename = filename;

    $("sharePdf").disabled = false;
    $("downloadPdf").disabled = false;

    showToast("PDF created ‚úÖ");
  }catch(err){
    alert("PDF creation failed:\n\n" + err);
  }finally{
    $("createPdf").disabled = false;
  }
});

$("sharePdf").addEventListener("click", async ()=>{
  if(!currentPdfBlob){ alert("Tap Create PDF first."); return; }
  await shareBlob(currentPdfBlob, currentPdfFilename);
});

$("downloadPdf").addEventListener("click", ()=>{
  if(!currentPdfBlob){ alert("Tap Create PDF first."); return; }
  downloadBlob(currentPdfBlob, currentPdfFilename);
  showToast("Downloaded");
});

/* =======================
   START
======================= */
loadState();
render();
</script>
</body>
</html>
